<!doctype html>
<html lang="vi" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trade Agent - Professional Stock Assistant</title>
    <link rel="icon" type="image/svg+xml" href="/static/logo.svg" />
    <link rel="stylesheet" href="/static/css/share.css" />
    <link rel="stylesheet" href="/static/css/settings.css" />
    <link rel="stylesheet" href="/static/css/portfolio.css" />
    <link rel="stylesheet" href="/static/css/chat.css" />
    <link rel="stylesheet" href="/static/css/user.css" />
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Lightweight Charts (TradingView) for Stock Charts - v4 for stable API -->
    <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#f5f7ff",
                100: "#ebf0fe",
                200: "#dce4fd",
                300: "#c5d0fb",
                400: "#a3b3f8",
                500: "#7e8ef3",
                600: "#5c64eb",
                700: "#4c4dd8",
                800: "#3f3fb1",
                900: "#37388d",
                950: "#212152",
              },
              accent: {
                cyan: "#06b6d4",
                emerald: "#10b981",
                amber: "#f59e0b",
                rose: "#f43f5e",
                violet: "#8b5cf6",
              },
            },
            backgroundImage: {
              "premium-gradient": "linear-gradient(135deg, #5c64eb 0%, #8b5cf6 100%)",
              "dark-premium-gradient": "linear-gradient(135deg, #37388d 0%, #5c64eb 100%)",
            },
          },
        },
      };
    </script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap");

      html,
      body {
        font-family: "Inter", sans-serif;
        background-color: #f8fafc;
        overflow-x: hidden;
        width: 100%;
        max-width: 100vw;
      }

      .dark body {
        background-color: #020617;
      }

      .sidebar-tab-btn {
        color: #64748b;
        background: transparent;
        position: relative;
        z-index: 10;
      }

      .dark .sidebar-tab-btn {
        color: #94a3b8;
      }

      .sidebar-tab-btn.active {
        color: #ffffff !important;
      }

      .dark .sidebar-tab-btn.active {
        color: #ffffff !important;
      }

      #tab-indicator {
        position: absolute;
        background: linear-gradient(135deg, #8b5cf6, #3b82f6);
        border: 1px solid rgba(255, 255, 255, 0.25);
        box-shadow:
          0 10px 25px -5px rgba(59, 130, 246, 0.3),
          0 8px 10px -6px rgba(139, 92, 246, 0.2);
        transition: all 0.5s cubic-bezier(0.2, 1, 0.2, 1);
        z-index: 5;
        overflow: hidden;
      }

      /* Dual Panel Mode Styles */
      #right-column.dual-panel-active #tab-content-container {
        display: flex !important;
        flex-direction: row !important;
        gap: 1.5rem;
        overflow: hidden !important;
      }

      /* In dual panel, any tab content that isn't hidden takes flex: 1 */
      #right-column.dual-panel-active .tab-content-item {
        flex: 1 !important;
        min-width: 0;
        display: none; /* Default for hidden */
      }

      /* Override hidden behavior for active components in dual mode */
      #right-column.dual-panel-active .tab-content-item:not(.hidden) {
        display: flex !important;
        flex-direction: column;
      }

      /* Ensure chart is always visible ONLY IF it's not the primary tab to avoid double column same content icon */
      /* Actually, the switchTab logic already ensures this. */

      #dual-panel-container {
        display: none;
      }

      /* Mini Charts & S/R Lines */
      .mini-sparkline {
        width: 100%;
        height: 48px;
        margin-top: 8px;
        opacity: 0.8;
        position: relative;
        overflow: hidden;
      }

      /* Analysis Chart Area */
      #analysis-chart-wrapper {
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      }

      #analysis-chart-wrapper.collapsed {
        display: none !important;
      }

      #tab-indicator::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 60%;
        height: 100%;
        background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.4), transparent);
        animation: shimmer-pill 2.5s infinite linear;
      }

      .dark #tab-indicator {
        background: linear-gradient(135deg, #7c3aed, #2563eb);
        border: 1px solid rgba(255, 255, 255, 0.35);
        box-shadow:
          0 0 20px rgba(37, 99, 235, 0.25),
          0 0 40px rgba(124, 58, 237, 0.1);
      }

      .dark #tab-indicator::after {
        background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.3), transparent);
      }

      /* Indicator Tooltip Styles */
      .indicator-tooltip {
        position: relative;
        display: inline-flex;
        align-items: center;
        cursor: help;
      }

      .indicator-tooltip .tooltip-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        margin-left: 4px;
        color: #64748b;
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      .indicator-tooltip .tooltip-icon svg {
        width: 14px;
        height: 14px;
      }

      .dark .indicator-tooltip .tooltip-icon {
        color: #94a3b8;
      }

      .indicator-tooltip:hover .tooltip-icon {
        color: #6366f1;
      }

      .dark .indicator-tooltip:hover .tooltip-icon {
        color: #818cf8;
      }

      /* Hide the inline tooltip-content, we use global tooltip instead */
      .indicator-tooltip .tooltip-content {
        display: none !important;
      }

      /* Resizer Styles */
      #resizer {
        width: 4px;
        cursor: col-resize;
        background-color: transparent;
        transition: background-color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 50;
      }

      #resizer:hover,
      #resizer.resizing,
      #analysis-chart-resizer:hover,
      #analysis-chart-resizer.resizing {
        background-color: rgba(99, 102, 241, 0.2);
      }

      #analysis-chart-resizer.resizing div {
        background-color: #6366f1;
      }
    </style>
  </head>

  <body
    class="bg-[#f8fafc] dark:bg-[#020617] text-slate-900 dark:text-slate-100 transition-colors duration-300 h-screen overflow-hidden flex flex-col relative w-full max-w-full"
    style="overflow-x: hidden"
  >
    <!-- Global Tooltip Container -->
    <div id="global-tooltip"></div>

    <!-- Background Blobs -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
      <div
        class="absolute top-0 left-0 w-[40%] h-[40%] bg-primary-500/10 dark:bg-primary-500/5 rounded-full blur-[120px] animate-pulse"
      ></div>
      <div
        class="absolute top-[20%] right-0 w-[35%] h-[35%] bg-accent-violet/10 dark:bg-accent-violet/5 rounded-full blur-[120px] animate-pulse"
        style="animation-delay: 2s"
      ></div>
      <div
        class="absolute bottom-0 left-[20%] w-[50%] h-[50%] bg-accent-cyan/10 dark:bg-accent-cyan/5 rounded-full blur-[120px] animate-pulse"
        style="animation-delay: 4s"
      ></div>
    </div>

    <!-- Header -->
    <header
      class="border-b border-white/40 dark:border-white/5 bg-white/40 dark:bg-slate-950/40 backdrop-blur-2xl px-4 lg:px-8 py-4 flex items-center justify-between z-[60] sticky top-0"
    >
      <div class="flex items-center gap-3 relative">
        <div
          class="bg-white dark:bg-slate-900 border border-indigo-100 dark:border-indigo-900/30 p-1.5 rounded-xl shadow-lg shadow-indigo-500/10 ring-1 ring-indigo-500/10 dark:ring-white/10"
        >
          <img src="/static/logo.svg" alt="Trade Agent Logo" class="w-7 h-7 object-contain" />
        </div>
        <div>
          <h1 class="text-2xl font-black bg-clip-text text-transparent bg-premium-gradient tracking-tight">
            Trade Agent
          </h1>
          <p
            class="text-[10px] uppercase tracking-[0.2em] font-bold text-slate-400 dark:text-slate-500 leading-none mt-1"
          >
            AI-Powered Intelligence
          </p>
        </div>
      </div>
      <div class="flex items-center gap-4 relative">
        <button
          id="theme-toggle"
          class="p-2.5 rounded-xl transition-all bg-gradient-to-r from-slate-100/60 to-slate-200/60 dark:from-slate-700/80 dark:to-slate-800/80 backdrop-blur-xl backdrop-saturate-150 border border-white/40 dark:border-white/10 shadow-lg ring-1 ring-inset ring-white/20 hover:from-amber-100/80 hover:to-orange-100/80 dark:hover:from-indigo-800/80 dark:hover:to-purple-800/80 hover:shadow-xl hover:scale-105"
        >
          <i data-lucide="moon" id="theme-icon-dark" class="w-5 h-5 hidden"></i>
          <i data-lucide="sun" id="theme-icon-light" class="w-5 h-5"></i>
        </button>
        <div id="user-avatar-btn" class="user-avatar">??</div>

        <!-- COMPONENT: user-menu -->
      </div>
    </header>

    <!-- COMPONENT: settings -->

    <!-- COMPONENT: portfolio -->

    <!-- Main Content -->
    <main class="flex-1 flex flex-col lg:flex-row overflow-y-auto lg:overflow-hidden relative z-10" id="main-container">
      <!-- Left Column (initially 50%) -->
      <aside
        id="left-column"
        class="pb-8 flex flex-col border-b lg:border-b-0 lg:border-r border-white/20 dark:border-white/5 bg-white/20 dark:bg-slate-950/20 backdrop-blur-xl relative w-full h-auto min-h-[85vh] lg:h-full lg:w-[50%] lg:min-h-0 overflow-hidden shrink-0 max-w-full"
      >
        <!-- COMPONENT: chat -->
      </aside>

      <!-- Vertical Resizer -->
      <div id="resizer" class="hidden lg:block h-full"></div>

      <!-- Right Column (initially 50%) -->
      <div
        id="right-column"
        class="w-full h-auto min-h-[85vh] lg:flex-1 lg:h-full lg:min-h-0 bg-white/10 dark:bg-slate-950/20 backdrop-blur-sm flex flex-col relative overflow-hidden shrink-0 max-w-full"
      >
        <!-- Background Decoration -->
        <div class="absolute inset-0 opacity-[0.05] pointer-events-none dark:opacity-[0.02]">
          <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                <path d="M 40 0 L 0 0 0 40" fill="none" stroke="currentColor" stroke-width="0.5" />
              </pattern>
            </defs>
            <rect width="100%" height="100%" fill="url(#grid)" />
          </svg>
        </div>

        <!-- Floating Shapes -->
        <div class="absolute top-0 right-0 w-64 h-64 bg-primary-500/10 rounded-full blur-3xl"></div>
        <div class="absolute bottom-0 left-0 w-64 h-64 bg-accent-cyan/10 rounded-full blur-3xl"></div>

        <!-- Tab Header -->
        <div class="z-30 px-4 pt-4 lg:px-8 lg:pt-5">
          <div
            class="flex w-full p-1 gap-1 bg-white/40 dark:bg-slate-900/40 backdrop-blur-3xl rounded-2xl border border-slate-200 dark:border-white/5 shadow-lg relative"
            id="tab-bar"
          >
            <!-- iOS Style Indicator -->
            <div id="tab-indicator" class="rounded-xl"></div>

            <button
              onclick="switchTab('chart')"
              id="tab-btn-chart"
              class="flex-1 py-2.5 px-4 rounded-xl text-xs font-black uppercase tracking-widest transition-all sidebar-tab-btn active"
            >
              <div class="flex items-center justify-center gap-2">
                <i data-lucide="line-chart" class="w-4 h-4"></i>
                <span class="hidden xl:block">Biểu đồ</span>
              </div>
            </button>
            <button
              onclick="switchTab('news')"
              id="tab-btn-news"
              class="flex-1 py-2.5 px-4 rounded-xl text-xs font-black uppercase tracking-widest transition-all sidebar-tab-btn"
            >
              <div class="flex items-center justify-center gap-2">
                <i data-lucide="newspaper" class="w-4 h-4"></i>
                <span class="hidden xl:block">Tin tức</span>
              </div>
            </button>
            <button
              onclick="switchTab('analysis')"
              id="tab-btn-analysis"
              class="flex-1 py-2.5 px-4 rounded-xl text-xs font-black uppercase tracking-widest transition-all sidebar-tab-btn"
            >
              <div class="flex items-center justify-center gap-2">
                <i data-lucide="microscope" class="w-4 h-4"></i>
                <span class="hidden xl:block">Phân tích</span>
              </div>
            </button>
          </div>
        </div>

        <!-- COMPONENT: stock-header -->

        <!-- COMPONENT: chart -->

        <!-- COMPONENT: news -->

        <!-- COMPONENT: analysis -->
      </div>
    </main>

    <script src="/static/js/utils.js"></script>
    <script src="/static/js/user.js"></script>
    <script src="/static/js/settings.js"></script>
    <script src="/static/js/portfolio.js"></script>
    <script src="/static/js/chat.js"></script>
    <script src="/static/js/stock-header.js"></script>
    <script src="/static/js/chart.js"></script>
    <script src="/static/js/news.js"></script>
    <script src="/static/js/analysis.js"></script>
    <script>
      let currentTabId = "chart";
      function switchTab(tabId) {
        currentTabId = tabId;
        const rightColumn = document.getElementById("right-column");
        const isDual = rightColumn && rightColumn.classList.contains("dual-panel-active");

        // Hide all tab contents
        document.getElementById("tab-empty-state").classList.add("hidden");
        document.getElementById("tab-content-chart").classList.add("hidden");
        document.getElementById("tab-content-news").classList.add("hidden");
        document.getElementById("tab-content-analysis").classList.add("hidden");

        // Show selected content
        document.getElementById(`tab-content-${tabId}`).classList.remove("hidden");

        // If dual panel is active, chart MUST also be visible
        if (isDual) {
          document.getElementById("tab-content-chart").classList.remove("hidden");
        }

        // Update button states
        document.querySelectorAll(".sidebar-tab-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        const activeBtn = document.getElementById(`tab-btn-${tabId}`);
        activeBtn.classList.add("active");

        // Animate indicator
        updateTabIndicator(activeBtn);

        // Handle chart resize for chart tab
        if (tabId === "chart") {
          setTimeout(() => {
            window.dispatchEvent(new Event("resize"));
            refreshCharts();
          }, 50);
        } else if (tabId === "analysis") {
          // Resize analysis chart when switching to analysis tab
          setTimeout(() => {
            window.dispatchEvent(new Event("resize"));
            refreshAnalysisChart();
          }, 50);
        }

        // Trigger news analysis if switching to news tab and it hasn't been loaded for current stock
        if (tabId === "news" && selectedStock) {
          triggerNewsAnalysis(selectedStock, selectedStockCompanyName);
        }

        // Handle analysis tab switch logic (fetch data if needed, show containers)
        if (tabId === "analysis") {
          handleAnalysisTabSwitch(selectedStock, selectedStockCompanyName);
        }
      }

      function updateTabIndicator(btn) {
        const indicator = document.getElementById("tab-indicator");
        const tabBar = document.getElementById("tab-bar");

        if (btn && indicator && tabBar) {
          indicator.style.width = `${btn.offsetWidth}px`;
          indicator.style.height = `${btn.offsetHeight}px`;
          indicator.style.left = `${btn.offsetLeft}px`;
          indicator.style.top = `${btn.offsetTop}px`;
        }
      }

      // Initialize Tab Indicator on load
      window.addEventListener("load", () => {
        const activeBtn = document.querySelector(".sidebar-tab-btn.active");
        if (activeBtn) updateTabIndicator(activeBtn);
      });

      // Update Tab Indicator using ResizeObserver for accurate measurements after layout
      const tabBar = document.getElementById("tab-bar");
      if (tabBar) {
        const tabBarResizeObserver = new ResizeObserver(() => {
          const activeBtn = document.getElementById(`tab-btn-${currentTabId}`);
          if (activeBtn) updateTabIndicator(activeBtn);
        });
        tabBarResizeObserver.observe(tabBar);
      }

      // Layout Controls
      function toggleSidebar() {
        document.body.classList.toggle("sidebar-collapsed");
        const rightColumn = document.getElementById("right-column");
        if (rightColumn) {
          rightColumn.classList.toggle("dual-panel-active");
          // Re-trigger switchTab to ensure correct visibility in dual mode
          switchTab(currentTabId);
        }

        // Update icons
        lucide.createIcons();

        // Trigger resize for charts
        setTimeout(() => {
          window.dispatchEvent(new Event("resize"));
          refreshCharts();
          refreshAnalysisChart();
        }, 50);
      }

      // Initialize Lucide Icons
      lucide.createIcons();

      // Resizer Logic
      const resizer = document.getElementById("resizer");
      const leftColumn = document.getElementById("left-column");
      const mainContainer = document.getElementById("main-container");

      let isResizing = false;

      resizer.addEventListener("mousedown", (e) => {
        isResizing = true;
        resizer.classList.add("resizing");
        document.body.style.cursor = "col-resize";
        // Disable text selection and pointer events in iframe/content during resize
        document.body.classList.add("select-none");
      });

      document.addEventListener("mousemove", (e) => {
        if (!isResizing || window.innerWidth < 1024) return;

        const containerWidth = mainContainer.offsetWidth;
        let newLeftWidth = (e.clientX / containerWidth) * 100;

        // Constraints
        if (newLeftWidth < 20) newLeftWidth = 20;
        if (newLeftWidth > 80) newLeftWidth = 80;

        leftColumn.style.width = `${newLeftWidth}%`;

        // Re-sync tab indicator in real-time
        const activeBtn = document.querySelector(".sidebar-tab-btn.active");
        if (activeBtn) updateTabIndicator(activeBtn);
      });

      // Reset layout for mobile on window resize
      window.addEventListener("resize", () => {
        // If mobile view, reset the inline width usage to let CSS classes take over
        if (window.innerWidth < 1024) {
          leftColumn.style.width = "";
        }
      });

      document.addEventListener("mouseup", () => {
        isResizing = false;
        resizer.classList.remove("resizing");
        document.body.style.cursor = "default";
        document.body.classList.remove("select-none");
      });

      let selectedStock = null;
      let selectedStockCompanyName = null;

      function selectStock(symbol) {
        // Update selected state
        selectedStock = symbol;
        const stockInfo = getStockInfo(symbol);
        const companyName = stockInfo.name;
        selectedStockCompanyName = companyName;
        resetNewsState();
        resetAnalysisState();

        const exchange = stockInfo.exchange;

        // Remove selected class from all tickers
        document.querySelectorAll(".stock-ticker.selected").forEach((el) => {
          el.classList.remove("selected");
        });

        // Add selected class to all instances of the clicked ticker
        document.querySelectorAll(`.stock-ticker[data-symbol="${symbol}"]`).forEach((el) => {
          el.classList.add("selected");
        });

        // Show and update Stock Header
        updateStockHeader(symbol, companyName, exchange);

        // Initialize chart with controls
        triggerChartDisplay(symbol);

        // Trigger news analysis if currently on news tab
        if (currentTabId === "news") {
          triggerNewsAnalysis(symbol, companyName);
        }

        // Trigger technical analysis if currently on analysis tab
        if (currentTabId === "analysis") {
          triggerTechnicalAnalysis(symbol, companyName);
        }
      }
    </script>
  </body>
</html>
