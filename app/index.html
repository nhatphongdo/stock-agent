<!doctype html>
<html lang="vi" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trade Agent - Professional Stock Assistant</title>
    <link rel="icon" type="image/svg+xml" href="/static/logo.svg" />
    <link rel="stylesheet" href="/static/css/share.css" />
    <link rel="stylesheet" href="/static/css/settings.css" />
    <link rel="stylesheet" href="/static/css/portfolio.css" />
    <link rel="stylesheet" href="/static/css/chat.css" />
    <link rel="stylesheet" href="/static/css/user.css" />
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Lightweight Charts (TradingView) for Stock Charts - v4 for stable API -->
    <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#f5f7ff",
                100: "#ebf0fe",
                200: "#dce4fd",
                300: "#c5d0fb",
                400: "#a3b3f8",
                500: "#7e8ef3",
                600: "#5c64eb",
                700: "#4c4dd8",
                800: "#3f3fb1",
                900: "#37388d",
                950: "#212152",
              },
              accent: {
                cyan: "#06b6d4",
                emerald: "#10b981",
                amber: "#f59e0b",
                rose: "#f43f5e",
                violet: "#8b5cf6",
              },
            },
            backgroundImage: {
              "premium-gradient": "linear-gradient(135deg, #5c64eb 0%, #8b5cf6 100%)",
              "dark-premium-gradient": "linear-gradient(135deg, #37388d 0%, #5c64eb 100%)",
            },
          },
        },
      };
    </script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap");

      html,
      body {
        font-family: "Inter", sans-serif;
        background-color: #f8fafc;
        overflow-x: hidden;
        width: 100%;
        max-width: 100vw;
      }

      .dark body {
        background-color: #020617;
      }

      .sidebar-tab-btn {
        color: #64748b;
        background: transparent;
        position: relative;
        z-index: 10;
      }

      .dark .sidebar-tab-btn {
        color: #94a3b8;
      }

      .sidebar-tab-btn.active {
        color: #ffffff !important;
      }

      .dark .sidebar-tab-btn.active {
        color: #ffffff !important;
      }

      #tab-indicator {
        position: absolute;
        background: linear-gradient(135deg, #8b5cf6, #3b82f6);
        border: 1px solid rgba(255, 255, 255, 0.25);
        box-shadow:
          0 10px 25px -5px rgba(59, 130, 246, 0.3),
          0 8px 10px -6px rgba(139, 92, 246, 0.2);
        transition: all 0.5s cubic-bezier(0.2, 1, 0.2, 1);
        z-index: 5;
        overflow: hidden;
      }

      /* Dual Panel Mode Styles */
      #right-column.dual-panel-active #tab-content-container {
        display: flex !important;
        flex-direction: row !important;
        gap: 1.5rem;
        overflow: hidden !important;
      }

      /* In dual panel, any tab content that isn't hidden takes flex: 1 */
      #right-column.dual-panel-active .tab-content-item {
        flex: 1 !important;
        min-width: 0;
        display: none; /* Default for hidden */
      }

      /* Override hidden behavior for active components in dual mode */
      #right-column.dual-panel-active .tab-content-item:not(.hidden) {
        display: flex !important;
        flex-direction: column;
      }

      /* Ensure chart is always visible ONLY IF it's not the primary tab to avoid double column same content icon */
      /* Actually, the switchTab logic already ensures this. */

      #dual-panel-container {
        display: none;
      }

      /* Mini Charts & S/R Lines */
      .mini-sparkline {
        width: 100%;
        height: 48px;
        margin-top: 8px;
        opacity: 0.8;
        position: relative;
        overflow: hidden;
      }

      /* Analysis Chart Area */
      #analysis-chart-wrapper {
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      }

      #analysis-chart-wrapper.collapsed {
        display: none !important;
      }

      #tab-indicator::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 60%;
        height: 100%;
        background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.4), transparent);
        animation: shimmer-pill 2.5s infinite linear;
      }

      .dark #tab-indicator {
        background: linear-gradient(135deg, #7c3aed, #2563eb);
        border: 1px solid rgba(255, 255, 255, 0.35);
        box-shadow:
          0 0 20px rgba(37, 99, 235, 0.25),
          0 0 40px rgba(124, 58, 237, 0.1);
      }

      .dark #tab-indicator::after {
        background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.3), transparent);
      }

      /* Indicator Tooltip Styles */
      .indicator-tooltip {
        position: relative;
        display: inline-flex;
        align-items: center;
        cursor: help;
      }

      .indicator-tooltip .tooltip-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        margin-left: 4px;
        color: #64748b;
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      .indicator-tooltip .tooltip-icon svg {
        width: 14px;
        height: 14px;
      }

      .dark .indicator-tooltip .tooltip-icon {
        color: #94a3b8;
      }

      .indicator-tooltip:hover .tooltip-icon {
        color: #6366f1;
      }

      .dark .indicator-tooltip:hover .tooltip-icon {
        color: #818cf8;
      }

      /* Hide the inline tooltip-content, we use global tooltip instead */
      .indicator-tooltip .tooltip-content {
        display: none !important;
      }

      /* Resizer Styles */
      #resizer {
        width: 4px;
        cursor: col-resize;
        background-color: transparent;
        transition: background-color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 50;
      }

      #resizer:hover,
      #resizer.resizing,
      #analysis-chart-resizer:hover,
      #analysis-chart-resizer.resizing {
        background-color: rgba(99, 102, 241, 0.2);
      }

      #analysis-chart-resizer.resizing div {
        background-color: #6366f1;
      }
    </style>
  </head>

  <body
    class="bg-[#f8fafc] dark:bg-[#020617] text-slate-900 dark:text-slate-100 transition-colors duration-300 h-screen overflow-hidden flex flex-col relative w-full max-w-full"
    style="overflow-x: hidden"
  >
    <!-- Global Tooltip Container -->
    <div id="global-tooltip"></div>

    <!-- Background Blobs -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
      <div
        class="absolute top-0 left-0 w-[40%] h-[40%] bg-primary-500/10 dark:bg-primary-500/5 rounded-full blur-[120px] animate-pulse"
      ></div>
      <div
        class="absolute top-[20%] right-0 w-[35%] h-[35%] bg-accent-violet/10 dark:bg-accent-violet/5 rounded-full blur-[120px] animate-pulse"
        style="animation-delay: 2s"
      ></div>
      <div
        class="absolute bottom-0 left-[20%] w-[50%] h-[50%] bg-accent-cyan/10 dark:bg-accent-cyan/5 rounded-full blur-[120px] animate-pulse"
        style="animation-delay: 4s"
      ></div>
    </div>

    <!-- Header -->
    <header
      class="border-b border-white/40 dark:border-white/5 bg-white/40 dark:bg-slate-950/40 backdrop-blur-2xl px-4 lg:px-8 py-4 flex items-center justify-between z-[60] sticky top-0"
    >
      <div class="flex items-center gap-3 relative">
        <div
          class="bg-white dark:bg-slate-900 border border-indigo-100 dark:border-indigo-900/30 p-1.5 rounded-xl shadow-lg shadow-indigo-500/10 ring-1 ring-indigo-500/10 dark:ring-white/10"
        >
          <img src="/static/logo.svg" alt="Trade Agent Logo" class="w-7 h-7 object-contain" />
        </div>
        <div>
          <h1 class="text-2xl font-black bg-clip-text text-transparent bg-premium-gradient tracking-tight">
            Trade Agent
          </h1>
          <p
            class="text-[10px] uppercase tracking-[0.2em] font-bold text-slate-400 dark:text-slate-500 leading-none mt-1"
          >
            AI-Powered Intelligence
          </p>
        </div>
      </div>
      <div class="flex items-center gap-4 relative">
        <button
          id="theme-toggle"
          class="p-2.5 rounded-xl transition-all bg-gradient-to-r from-slate-100/60 to-slate-200/60 dark:from-slate-700/80 dark:to-slate-800/80 backdrop-blur-xl backdrop-saturate-150 border border-white/40 dark:border-white/10 shadow-lg ring-1 ring-inset ring-white/20 hover:from-amber-100/80 hover:to-orange-100/80 dark:hover:from-indigo-800/80 dark:hover:to-purple-800/80 hover:shadow-xl hover:scale-105"
        >
          <i data-lucide="moon" id="theme-icon-dark" class="w-5 h-5 hidden"></i>
          <i data-lucide="sun" id="theme-icon-light" class="w-5 h-5"></i>
        </button>
        <div id="user-avatar-btn" class="user-avatar">??</div>

        <!-- COMPONENT: user-menu -->
      </div>
    </header>

    <!-- COMPONENT: settings -->

    <!-- COMPONENT: portfolio -->

    <!-- Main Content -->
    <main class="flex-1 flex flex-col lg:flex-row overflow-y-auto lg:overflow-hidden relative z-10" id="main-container">
      <!-- Left Column (initially 50%) -->
      <aside
        id="left-column"
        class="pb-8 flex flex-col border-b lg:border-b-0 lg:border-r border-white/20 dark:border-white/5 bg-white/20 dark:bg-slate-950/20 backdrop-blur-xl relative w-full h-auto min-h-[85vh] lg:h-full lg:w-[50%] lg:min-h-0 overflow-hidden shrink-0 max-w-full"
      >
        <!-- COMPONENT: chat -->
      </aside>

      <!-- Vertical Resizer -->
      <div id="resizer" class="hidden lg:block h-full"></div>

      <!-- Right Column (initially 50%) -->
      <div
        id="right-column"
        class="w-full h-auto min-h-[85vh] lg:flex-1 lg:h-full lg:min-h-0 bg-white/10 dark:bg-slate-950/20 backdrop-blur-sm flex flex-col relative overflow-hidden shrink-0 max-w-full"
      >
        <!-- Background Decoration -->
        <div class="absolute inset-0 opacity-[0.05] pointer-events-none dark:opacity-[0.02]">
          <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                <path d="M 40 0 L 0 0 0 40" fill="none" stroke="currentColor" stroke-width="0.5" />
              </pattern>
            </defs>
            <rect width="100%" height="100%" fill="url(#grid)" />
          </svg>
        </div>

        <!-- Floating Shapes -->
        <div class="absolute top-0 right-0 w-64 h-64 bg-primary-500/10 rounded-full blur-3xl"></div>
        <div class="absolute bottom-0 left-0 w-64 h-64 bg-accent-cyan/10 rounded-full blur-3xl"></div>

        <!-- Tab Header -->
        <div class="z-30 px-4 pt-4 lg:px-8 lg:pt-5">
          <div
            class="flex w-full p-1 gap-1 bg-white/40 dark:bg-slate-900/40 backdrop-blur-3xl rounded-2xl border border-slate-200 dark:border-white/5 shadow-lg relative"
            id="tab-bar"
          >
            <!-- iOS Style Indicator -->
            <div id="tab-indicator" class="rounded-xl"></div>

            <button
              onclick="switchTab('chart')"
              id="tab-btn-chart"
              class="flex-1 py-2.5 px-4 rounded-xl text-xs font-black uppercase tracking-widest transition-all sidebar-tab-btn active"
            >
              <div class="flex items-center justify-center gap-2">
                <i data-lucide="line-chart" class="w-4 h-4"></i>
                <span class="hidden xl:block">Bi·ªÉu ƒë·ªì</span>
              </div>
            </button>
            <button
              onclick="switchTab('news')"
              id="tab-btn-news"
              class="flex-1 py-2.5 px-4 rounded-xl text-xs font-black uppercase tracking-widest transition-all sidebar-tab-btn"
            >
              <div class="flex items-center justify-center gap-2">
                <i data-lucide="newspaper" class="w-4 h-4"></i>
                <span class="hidden xl:block">Tin t·ª©c</span>
              </div>
            </button>
            <button
              onclick="switchTab('analysis')"
              id="tab-btn-analysis"
              class="flex-1 py-2.5 px-4 rounded-xl text-xs font-black uppercase tracking-widest transition-all sidebar-tab-btn"
            >
              <div class="flex items-center justify-center gap-2">
                <i data-lucide="microscope" class="w-4 h-4"></i>
                <span class="hidden xl:block">Ph√¢n t√≠ch</span>
              </div>
            </button>
          </div>
        </div>

        <!-- COMPONENT: stock-header -->

        <!-- Technical Chart Tab (Visible by default) -->
        <div
          id="tab-content-chart"
          class="h-full w-full flex flex-col tab-content-item px-4 pt-4 pb-4 lg:px-8 lg:pb-8 overflow-hidden z-10"
        >
          <div
            id="chart-tab-content-empty"
            class="flex-1 bg-white/20 dark:bg-slate-900/20 rounded-3xl border border-slate-400 dark:border-white/20 backdrop-blur-sm flex flex-col items-center justify-center p-8 text-center border-dashed"
          >
            <div
              class="w-20 h-20 bg-gradient-to-br from-primary-500/20 to-blue-500/20 dark:from-primary-500/10 dark:to-blue-500/10 rounded-3xl flex items-center justify-center mb-6 text-primary-500"
            >
              <i data-lucide="candlestick-chart" class="w-10 h-10"></i>
            </div>
            <h4 class="text-lg font-bold text-slate-700 dark:text-slate-300 mb-3">Bi·ªÉu ƒë·ªì k·ªπ thu·∫≠t</h4>
            <p class="text-sm text-slate-500 dark:text-slate-400 max-w-xs leading-relaxed">
              Xem bi·ªÉu ƒë·ªì gi√° v√† ph√¢n t√≠ch k·ªπ thu·∫≠t c·ªßa c·ªï phi·∫øu. H·ªó tr·ª£ m·ªü chart tr·ª±c ti·∫øp tr√™n TradingView ho·∫∑c
              Investing.com.
            </p>
            <div class="mt-6 px-4 py-2 bg-primary-50 dark:bg-primary-900/20 rounded-xl">
              <p class="text-xs text-primary-600 dark:text-primary-400 font-medium">
                üí° Click v√†o m√£ c·ªï phi·∫øu trong cu·ªôc tr√≤ chuy·ªán ƒë·ªÉ xem bi·ªÉu ƒë·ªì
              </p>
            </div>
          </div>
          <div id="chart-tab-content-container" class="animate-fade-in-up p-1 hidden h-full">
            <div id="chart-wrapper" class="w-full h-full flex flex-col gap-3 overflow-hidden">
              <!-- Chart Controls -->
              <div
                id="chart-control-container"
                class="flex flex-wrap items-center gap-2 p-3 bg-white/30 dark:bg-slate-900/30 rounded-2xl border border-slate-200 dark:border-white/10 backdrop-blur-sm relative z-20"
              >
                <!-- Timeframe Selector -->
                <div class="flex items-center gap-1">
                  <span class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">Kho·∫£ng:</span>
                  <select
                    id="chart-timeframe"
                    class="text-xs font-bold bg-white/60 dark:bg-slate-800/60 border border-slate-200 dark:border-slate-700 rounded-lg px-2 py-1 outline-none focus:ring-2 focus:ring-primary-500/30"
                  >
                    <option value="1D">1 Ng√†y</option>
                    <option value="1W">1 Tu·∫ßn</option>
                    <option value="1M">1 Th√°ng</option>
                    <option value="3M">3 Th√°ng</option>
                    <option value="6M" selected>6 Th√°ng</option>
                    <option value="9M">9 Th√°ng</option>
                    <option value="1Y">1 NƒÉm</option>
                    <option value="2Y">2 NƒÉm</option>
                    <option value="5Y">5 NƒÉm</option>
                    <option value="10Y">10 NƒÉm</option>
                  </select>
                </div>
                <!-- Interval Selector -->
                <div class="flex items-center gap-1">
                  <span class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">Chu k·ª≥:</span>
                  <select
                    id="chart-interval"
                    class="text-xs font-bold bg-white/60 dark:bg-slate-800/60 border border-slate-200 dark:border-slate-700 rounded-lg px-2 py-1 outline-none focus:ring-2 focus:ring-primary-500/30"
                  >
                    <option value="5m">5 ph√∫t</option>
                    <option value="15m">15 ph√∫t</option>
                    <option value="30m">30 ph√∫t</option>
                    <option value="1H">1 gi·ªù</option>
                    <option value="1D" selected>1 ng√†y</option>
                    <option value="1W">1 tu·∫ßn</option>
                    <option value="1M">1 th√°ng</option>
                  </select>
                </div>
                <!-- Indicator Toggles with Mobile Dropdown -->
                <div class="relative ml-auto">
                  <!-- Mobile Trigger Button -->
                  <button
                    onclick="document.getElementById('mobile-indicators').classList.toggle('hidden')"
                    class="lg:hidden flex items-center gap-1 text-xs font-bold px-2 py-1 bg-white/60 dark:bg-slate-800/60 rounded-lg border border-slate-200 dark:border-slate-700"
                  >
                    <span>Ch·ªâ b√°o</span>
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  </button>

                  <!-- Indicators List -->
                  <div
                    id="mobile-indicators"
                    class="hidden lg:flex lg:items-center lg:gap-3 absolute lg:static top-full right-0 mt-2 lg:mt-0 p-3 lg:p-0 bg-white/90 dark:bg-slate-900/90 lg:bg-transparent backdrop-blur-xl lg:backdrop-blur-none border border-white/20 lg:border-0 rounded-xl lg:rounded-none shadow-xl lg:shadow-none flex-col lg:flex-row gap-3 min-w-[120px] z-50"
                  >
                    <label class="flex items-center gap-1.5 cursor-pointer group whitespace-nowrap">
                      <input
                        type="checkbox"
                        id="indicator-ma"
                        class="w-4 h-4 rounded border-slate-300 accent-blue-500 transition-transform group-hover:scale-110"
                      />
                      <span class="text-xs font-bold text-blue-500">MA20</span>
                    </label>
                    <label class="flex items-center gap-1.5 cursor-pointer group whitespace-nowrap">
                      <input
                        type="checkbox"
                        id="indicator-ema"
                        class="w-4 h-4 rounded border-slate-300 accent-orange-500 transition-transform group-hover:scale-110"
                      />
                      <span class="text-xs font-bold text-orange-500">EMA9</span>
                    </label>
                    <label class="flex items-center gap-1.5 cursor-pointer group whitespace-nowrap">
                      <input
                        type="checkbox"
                        id="indicator-bb"
                        class="w-4 h-4 rounded border-slate-300 accent-purple-500 transition-transform group-hover:scale-110"
                      />
                      <span class="text-xs font-bold text-purple-500">BB</span>
                    </label>
                    <label class="flex items-center gap-1.5 cursor-pointer group whitespace-nowrap">
                      <input
                        type="checkbox"
                        id="indicator-rsi"
                        class="w-4 h-4 rounded border-slate-300 accent-amber-500 transition-transform group-hover:scale-110"
                      />
                      <span class="text-xs font-bold text-amber-500">RSI</span>
                    </label>
                    <label class="flex items-center gap-1.5 cursor-pointer group whitespace-nowrap">
                      <input
                        type="checkbox"
                        id="indicator-macd"
                        class="w-4 h-4 rounded border-slate-300 accent-blue-500 transition-transform group-hover:scale-110"
                      />
                      <span class="text-xs font-bold text-blue-500">MACD</span>
                    </label>
                    <label class="flex items-center gap-1.5 cursor-pointer group whitespace-nowrap">
                      <input
                        type="checkbox"
                        id="indicator-vol-sma"
                        class="w-4 h-4 rounded border-slate-300 accent-violet-500 transition-transform group-hover:scale-110"
                      />
                      <span class="text-xs font-bold text-violet-500">Vol SMA</span>
                    </label>
                  </div>
                </div>
              </div>

              <!-- Candlestick Chart (70%) -->
              <div
                id="price-chart-container"
                class="flex-[7] bg-white/40 dark:bg-slate-900/40 rounded-2xl border border-slate-200 dark:border-white/10 backdrop-blur-sm p-3 min-h-0"
              >
                <div id="candlestick-chart" style="width: 100%; height: 100%"></div>
              </div>

              <!-- Volume Chart (30%) -->
              <div
                id="volume-chart-container"
                class="flex-[3] bg-white/40 dark:bg-slate-900/40 rounded-2xl border border-slate-200 dark:border-white/10 backdrop-blur-sm p-3 min-h-0"
              >
                <div id="volume-chart" style="width: 100%; height: 100%"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Related News Tab -->
        <div
          id="tab-content-news"
          class="hidden h-full w-full tab-content-item px-4 pt-4 pb-4 lg:px-8 lg:pb-8 overflow-hidden z-10 flex flex-col"
        >
          <div
            id="news-tab-content-empty"
            class="flex-1 bg-white/20 dark:bg-slate-900/20 rounded-3xl border border-slate-400 dark:border-white/20 backdrop-blur-sm flex flex-col items-center justify-center p-8 text-center border-dashed min-h-full"
          >
            <div
              class="w-20 h-20 bg-gradient-to-br from-orange-500/20 to-red-500/20 dark:from-orange-500/10 dark:to-red-500/10 rounded-3xl flex items-center justify-center mb-6 text-orange-500"
            >
              <i data-lucide="newspaper" class="w-10 h-10"></i>
            </div>
            <h4 class="text-lg font-bold text-slate-700 dark:text-slate-300 mb-3">Tin t·ª©c li√™n quan</h4>
            <p class="text-sm text-slate-500 dark:text-slate-400 max-w-xs leading-relaxed">
              T·ªïng h·ª£p tin t·ª©c m·ªõi nh·∫•t v·ªÅ c·ªï phi·∫øu ƒë∆∞·ª£c ch·ªçn t·ª´ c√°c ngu·ªìn uy t√≠n, gi√∫p b·∫°n c·∫≠p nh·∫≠t th√¥ng tin th·ªã
              tr∆∞·ªùng nhanh ch√≥ng.
            </p>
            <div class="mt-6 px-4 py-2 bg-orange-50 dark:bg-orange-900/20 rounded-xl">
              <p class="text-xs text-orange-600 dark:text-orange-400 font-medium">
                üì∞ Ch·ªçn m√£ c·ªï phi·∫øu ƒë·ªÉ xem tin t·ª©c li√™n quan
              </p>
            </div>
          </div>
          <div
            id="news-tab-content-container"
            class="space-y-5 animate-fade-in-up p-1 hidden flex-1 min-h-0 overflow-y-auto custom-scrollbar"
          >
            <!-- AI Analysis Container -->
            <div
              class="p-5 bg-gradient-to-br from-white/60 to-white/40 dark:from-slate-900/60 dark:to-slate-900/40 rounded-3xl border border-slate-200 dark:border-white/10 shadow-xl backdrop-blur-xl"
            >
              <div class="flex items-center gap-3 mb-4 border-b border-slate-200 dark:border-white/10 pb-3">
                <div
                  class="w-8 h-8 rounded-full bg-indigo-600/10 flex items-center justify-center text-indigo-600 dark:text-indigo-400"
                >
                  <i data-lucide="brain-circuit" class="w-4 h-4"></i>
                </div>
                <h4 class="font-bold text-slate-800 dark:text-white text-sm">T·ªïng h·ª£p & Nh·∫≠n ƒë·ªãnh AI</h4>
                <div class="flex-1 flex justify-end">
                  <div
                    id="news-sentiment-badge"
                    class="h-7 w-24 bg-slate-200/50 dark:bg-slate-800/50 rounded-full skeleton-shimmer text-transparent border border-transparent"
                  ></div>
                </div>
              </div>
              <div
                id="news-analysis-content"
                class="text-sm text-slate-600 dark:text-slate-300 leading-relaxed min-h-[100px] markdown-content prose-sm dark:prose-invert max-w-none"
              >
                <div class="flex items-center gap-2 text-slate-400 mb-2">
                  <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                  <span class="text-sm">ƒêang ph√¢n t√≠ch tin t·ª©c v√† s·ª± ki·ªán...</span>
                </div>
              </div>
            </div>

            <!-- News List Section -->
            <div class="space-y-4">
              <div class="flex items-center justify-between">
                <h4 class="font-bold text-slate-800 dark:text-white text-sm flex items-center gap-2">
                  <i data-lucide="list-filter" class="w-4 h-4 text-primary-500"></i>
                  Lu·ªìng tin chi ti·∫øt
                  <span
                    id="news-count-badge"
                    class="hidden px-2 py-0.5 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-[10px] font-bold rounded-md border border-slate-200 dark:border-slate-700 shadow-sm ml-1"
                    >0</span
                  >
                </h4>
              </div>
              <div id="news-list-container" class="grid grid-cols-1 gap-3">
                <div
                  class="flex gap-4 p-4 bg-white/30 dark:bg-slate-900/30 rounded-2xl border border-slate-200 dark:border-white/5"
                >
                  <div
                    class="flex-shrink-0 w-12 h-12 rounded-xl bg-slate-200/50 dark:bg-slate-800/50 skeleton-shimmer"
                  ></div>
                  <div class="flex-1 space-y-2.5">
                    <div class="h-4 bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-3/4 skeleton-shimmer"></div>
                    <div
                      class="h-3 bg-slate-200/50 dark:bg-slate-800/40 rounded-md w-full opacity-60 skeleton-shimmer"
                    ></div>
                    <div class="flex gap-2 pt-1">
                      <div class="h-3 bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 skeleton-shimmer"></div>
                      <div class="h-3 bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-24 skeleton-shimmer"></div>
                    </div>
                  </div>
                </div>
                <div
                  class="flex gap-4 p-4 bg-white/30 dark:bg-slate-900/30 rounded-2xl border border-slate-200 dark:border-white/5"
                >
                  <div
                    class="flex-shrink-0 w-12 h-12 rounded-xl bg-slate-200/50 dark:bg-slate-800/50 skeleton-shimmer"
                  ></div>
                  <div class="flex-1 space-y-2.5">
                    <div class="h-4 bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-3/4 skeleton-shimmer"></div>
                    <div
                      class="h-3 bg-slate-200/50 dark:bg-slate-800/40 rounded-md w-full opacity-60 skeleton-shimmer"
                    ></div>
                    <div class="flex gap-2 pt-1">
                      <div class="h-3 bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 skeleton-shimmer"></div>
                      <div class="h-3 bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-24 skeleton-shimmer"></div>
                    </div>
                  </div>
                </div>
                <div
                  class="flex gap-4 p-4 bg-white/30 dark:bg-slate-900/30 rounded-2xl border border-slate-200 dark:border-white/5"
                >
                  <div
                    class="flex-shrink-0 w-12 h-12 rounded-xl bg-slate-200/50 dark:bg-slate-800/50 skeleton-shimmer"
                  ></div>
                  <div class="flex-1 space-y-2.5">
                    <div class="h-4 bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-3/4 skeleton-shimmer"></div>
                    <div
                      class="h-3 bg-slate-200/50 dark:bg-slate-800/40 rounded-md w-full opacity-60 skeleton-shimmer"
                    ></div>
                    <div class="flex gap-2 pt-1">
                      <div class="h-3 bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 skeleton-shimmer"></div>
                      <div class="h-3 bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-24 skeleton-shimmer"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Deep Analysis Tab -->
        <div
          id="tab-content-analysis"
          class="hidden h-full w-full tab-content-item px-4 pt-4 pb-4 lg:px-8 lg:pb-8 overflow-hidden z-10 flex flex-col"
        >
          <div
            id="analysis-tab-content-empty"
            class="flex-1 bg-white/20 dark:bg-slate-900/20 rounded-3xl border border-slate-400 dark:border-white/20 backdrop-blur-sm flex flex-col items-center justify-center p-8 text-center border-dashed min-h-full"
          >
            <div
              class="w-20 h-20 bg-gradient-to-br from-cyan-500/20 to-teal-500/20 dark:from-cyan-500/10 dark:to-teal-500/10 rounded-3xl flex items-center justify-center mb-6 text-cyan-500"
            >
              <i data-lucide="microscope" class="w-10 h-10"></i>
            </div>
            <h4 class="text-lg font-bold text-slate-700 dark:text-slate-300 mb-3">Ph√¢n t√≠ch chuy√™n s√¢u</h4>
            <p class="text-sm text-slate-500 dark:text-slate-400 max-w-xs leading-relaxed">
              B√°o c√°o ph√¢n t√≠ch ƒëa chi·ªÅu v·ªÅ doanh nghi·ªáp, bao g·ªìm ƒë·ªãnh gi√°, d·ª± b√°o xu h∆∞·ªõng v√† ƒë√°nh gi√° r·ªßi ro do AI
              t·ªïng h·ª£p.
            </p>
            <div class="mt-6 px-4 py-2 bg-cyan-50 dark:bg-cyan-900/20 rounded-xl">
              <p class="text-xs text-cyan-600 dark:text-cyan-400 font-medium">
                üî¨ Ch·ªçn m√£ c·ªï phi·∫øu ƒë·ªÉ xem ph√¢n t√≠ch chi ti·∫øt
              </p>
            </div>
          </div>
          <!-- Timeframe Selector Cards (inside tab) -->
          <div id="analysis-content-timeframe" class="hidden w-full z-30">
            <div class="w-full animate-fade-in-up">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 p-1">
                <!-- Short Term Summary -->
                <div
                  id="tech-card-short"
                  class="cursor-pointer transition-all duration-300 p-4 rounded-3xl border-2 border-indigo-400/60 bg-gradient-to-br from-indigo-100 via-indigo-50 to-purple-100 dark:from-indigo-600/30 dark:via-indigo-500/20 dark:to-purple-600/20 backdrop-blur-xl shadow-[0_8px_32px_rgba(99,102,241,0.3)] scale-[1.03]"
                >
                  <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                      <div
                        class="w-8 h-8 rounded-full bg-white dark:bg-indigo-500/20 flex items-center justify-center text-indigo-600 dark:text-indigo-400 shadow-sm border border-slate-200 dark:border-transparent"
                      >
                        <i data-lucide="zap" class="w-4 h-4"></i>
                      </div>
                      <span class="text-base font-bold text-slate-700 dark:text-indigo-200"
                        >Xu h∆∞·ªõng ng·∫Øn h·∫°n trong 1 nƒÉm</span
                      >
                    </div>
                    <span
                      id="tech-short-trend-badge"
                      class="h-6 w-16 bg-slate-200/50 dark:bg-slate-800/50 rounded-full skeleton-shimmer text-transparent border border-transparent"
                    ></span>
                  </div>
                  <div class="flex flex-wrap gap-x-8 gap-y-3">
                    <div class="min-w-0">
                      <p class="text-xs uppercase tracking-wider text-slate-500 dark:text-slate-400 font-bold mb-0.5">
                        Xu h∆∞·ªõng
                      </p>
                      <p
                        id="tech-short-trend"
                        class="text-base font-bold text-slate-700 dark:text-indigo-100 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md min-w-[4rem] h-6 whitespace-nowrap"
                      ></p>
                    </div>
                    <div class="min-w-0">
                      <p class="text-xs uppercase tracking-wider text-slate-500 dark:text-slate-400 font-bold mb-0.5">
                        T√≠n hi·ªáu
                      </p>
                      <p
                        id="tech-short-signal"
                        class="text-base font-bold text-slate-700 dark:text-indigo-100 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md min-w-[4rem] h-6 whitespace-nowrap"
                      ></p>
                    </div>
                    <div class="col-span-2">
                      <div class="flex justify-between items-center gap-2 mb-1.5">
                        <p class="text-xs uppercase tracking-wider text-slate-500 dark:text-slate-400 font-bold">
                          ƒê·ªô tin c·∫≠y
                        </p>
                        <span
                          id="tech-short-confidence"
                          class="text-xs font-bold text-slate-700 dark:text-slate-200 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-10 h-4"
                        ></span>
                      </div>
                      <div
                        id="tech-short-confidence-container"
                        class="relative h-3 w-full rounded-full overflow-visible"
                      >
                        <!-- Skeleton overlay -->
                        <div
                          id="tech-short-confidence-skeleton"
                          class="absolute inset-0 bg-slate-300/90 dark:bg-slate-600/90 rounded-full skeleton-shimmer z-20"
                        ></div>
                        <!-- Gradient bar -->
                        <div
                          class="absolute inset-0 rounded-full"
                          style="background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #22c55e 100%)"
                        ></div>
                        <div
                          id="tech-short-confidence-bar"
                          class="absolute top-1/2 -translate-y-1/2 w-4 h-4 rounded-full shadow-lg z-10 transition-all duration-1000 opacity-0"
                          style="
                            left: 0%;
                            background: linear-gradient(135deg, #ffffff 0%, #e2e8f0 100%);
                            border: 3px solid #ef4444;
                            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
                          "
                        ></div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Long Term Summary -->
                <div
                  id="tech-card-long"
                  class="cursor-pointer transition-all duration-300 p-4 rounded-3xl border border-slate-200 dark:border-white/10 bg-gradient-to-br from-slate-100 via-white to-slate-50 dark:from-slate-800/60 dark:via-slate-900/40 dark:to-slate-800/40 backdrop-blur-md shadow-sm opacity-60 hover:opacity-100 hover:scale-[1.01]"
                >
                  <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                      <div
                        class="w-8 h-8 rounded-full bg-white dark:bg-emerald-500/20 flex items-center justify-center text-emerald-600 dark:text-emerald-400 shadow-sm border border-slate-200 dark:border-transparent"
                      >
                        <i data-lucide="anchor" class="w-4 h-4"></i>
                      </div>
                      <span class="text-base font-bold text-slate-700 dark:text-emerald-200"
                        >Xu h∆∞·ªõng d√†i h·∫°n trong 5 nƒÉm</span
                      >
                    </div>
                    <span
                      id="tech-long-trend-badge"
                      class="h-6 w-16 bg-slate-200/50 dark:bg-slate-800/50 rounded-full skeleton-shimmer text-transparent border border-transparent"
                    ></span>
                  </div>
                  <div class="flex flex-wrap gap-x-8 gap-y-3">
                    <div class="min-w-0">
                      <p class="text-xs uppercase tracking-wider text-slate-500 dark:text-slate-400 font-bold mb-0.5">
                        Xu h∆∞·ªõng
                      </p>
                      <p
                        id="tech-long-trend"
                        class="text-base font-bold text-slate-700 dark:text-emerald-100 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md min-w-[4rem] h-6 whitespace-nowrap"
                      ></p>
                    </div>
                    <div class="min-w-0">
                      <p class="text-xs uppercase tracking-wider text-slate-500 dark:text-slate-400 font-bold mb-0.5">
                        T√≠n hi·ªáu
                      </p>
                      <p
                        id="tech-long-signal"
                        class="text-base font-bold text-slate-700 dark:text-emerald-100 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md min-w-[4rem] h-6 whitespace-nowrap"
                      ></p>
                    </div>
                    <div class="col-span-2">
                      <div class="flex justify-between items-center gap-2 mb-1.5">
                        <p class="text-xs uppercase tracking-wider text-slate-500 dark:text-slate-400 font-bold">
                          ƒê·ªô tin c·∫≠y
                        </p>
                        <span
                          id="tech-long-confidence"
                          class="text-xs font-bold text-slate-700 dark:text-slate-200 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-10 h-4"
                        ></span>
                      </div>
                      <div
                        id="tech-long-confidence-container"
                        class="relative h-3 w-full rounded-full overflow-visible"
                      >
                        <!-- Skeleton overlay -->
                        <div
                          id="tech-long-confidence-skeleton"
                          class="absolute inset-0 bg-slate-300/90 dark:bg-slate-600/90 rounded-full skeleton-shimmer z-20"
                        ></div>
                        <!-- Gradient bar -->
                        <div
                          class="absolute inset-0 rounded-full"
                          style="background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #22c55e 100%)"
                        ></div>
                        <div
                          id="tech-long-confidence-bar"
                          class="absolute top-1/2 -translate-y-1/2 w-4 h-4 rounded-full shadow-lg z-10 transition-all duration-1000 opacity-0"
                          style="
                            left: 0%;
                            background: linear-gradient(135deg, #ffffff 0%, #e2e8f0 100%);
                            border: 3px solid #ef4444;
                            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
                          "
                        ></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Collapsible Analysis Chart Area -->
          <div id="analysis-chart-collapsible" class="hidden w-full mb-4 p-1">
            <div class="flex items-center justify-between mb-2">
              <h5
                class="text-[11px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-[0.2em] flex items-center gap-2"
              >
                <i data-lucide="line-chart" class="w-4 h-4 text-primary-500"></i> Di·ªÖn bi·∫øn gi√°
              </h5>
              <button
                onclick="toggleAnalysisChart()"
                class="p-1.5 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-800 transition-all text-slate-400 hover:text-primary-500"
                title="Thu g·ªçn/M·ªü r·ªông bi·ªÉu ƒë·ªì"
              >
                <i
                  data-lucide="chevron-up"
                  class="w-4 h-4 transition-transform duration-300"
                  id="analysis-chart-toggle-icon"
                ></i>
              </button>
            </div>
            <div id="analysis-chart-wrapper" class="w-full h-full flex flex-col gap-3 overflow-hidden">
              <!-- Analysis Price Chart Only -->
              <div
                id="analysis-price-chart-container"
                class="bg-white/40 dark:bg-slate-900/40 rounded-2xl border border-slate-200 dark:border-white/10 backdrop-blur-sm p-3 h-[400px] relative transition-none"
              >
                <div id="analysis-candlestick-chart" style="width: 100%; height: 100%"></div>
                <!-- Vertical Resizer Handle -->
                <div
                  id="analysis-chart-resizer"
                  class="absolute bottom-0 left-0 right-0 h-2 cursor-ns-resize flex items-center justify-center hover:bg-primary-500/20 group transition-colors rounded-b-2xl z-20"
                >
                  <div
                    class="w-12 h-1 bg-slate-300 dark:bg-slate-700 rounded-full group-hover:bg-primary-500/50 transition-colors"
                  ></div>
                </div>
              </div>
            </div>
          </div>
          <div
            id="analysis-tab-content-container"
            class="hidden space-y-5 animate-fade-in-up p-1 flex-1 min-h-0 overflow-y-auto custom-scrollbar"
          >
            <!-- Main Indicators Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">
              <!-- Left Column: Primary Indicators -->
              <div class="space-y-4">
                <!-- Momentum Box -->
                <div
                  class="p-5 bg-white/30 dark:bg-slate-900/40 backdrop-blur-md rounded-3xl border border-slate-200 dark:border-white/10 shadow-lg hover:shadow-xl transition-shadow duration-300"
                >
                  <h5
                    class="flex items-center gap-2 text-[11px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-4"
                  >
                    <i data-lucide="gauge" class="w-4 h-4"></i> ƒê·ªông l∆∞·ª£ng
                    <span class="indicator-tooltip"
                      ><span class="tooltip-icon"><i data-lucide="info"></i></span
                      ><span class="tooltip-content"
                        >Nh√≥m ch·ªâ b√°o ƒëo l∆∞·ªùng t·ªëc ƒë·ªô v√† s·ª©c m·∫°nh bi·∫øn ƒë·ªông gi√°, gi√∫p x√°c ƒë·ªãnh ƒëi·ªÉm qu√° mua/qu√° b√°n v√†
                        ƒë·∫£o chi·ªÅu xu h∆∞·ªõng</span
                      ></span
                    >
                  </h5>
                  <div class="space-y-4">
                    <!-- RSI -->
                    <div class="space-y-1.5">
                      <div class="flex justify-between text-sm font-medium">
                        <span class="text-slate-500 indicator-tooltip"
                          >RSI (14)<span class="tooltip-icon"><i data-lucide="info"></i></span
                          ><span class="tooltip-content"
                            >Relative Strength Index - Ch·ªâ s·ªë S·ª©c m·∫°nh T∆∞∆°ng ƒë·ªëi. ƒêo l∆∞·ªùng t·ªëc ƒë·ªô thay ƒë·ªïi gi√°. RSI &lt;
                            30 = Qu√° b√°n (c√≥ th·ªÉ tƒÉng), RSI &gt; 70 = Qu√° mua (c√≥ th·ªÉ gi·∫£m)</span
                          ></span
                        >
                        <span
                          id="tech-rsi-value"
                          class="font-bold text-slate-700 dark:text-slate-200 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-10 h-5 indicator-tooltip"
                          ><span class="tooltip-content">Ch·ªâ s·ªë RSI hi·ªán t·∫°i. > 70: Qu√° mua, < 30: Qu√° b√°n</span></span
                        >
                      </div>
                      <!-- RSI Bar with clear zones -->
                      <div id="tech-rsi-bar-container" class="relative mt-2 mb-4">
                        <!-- Skeleton overlay -->
                        <div
                          id="tech-rsi-bar-skeleton"
                          class="absolute inset-0 bg-slate-100 dark:bg-slate-900 rounded-lg skeleton-shimmer z-20"
                        ></div>
                        <!-- Labels -->
                        <div
                          class="flex justify-between text-[10px] font-medium text-slate-400 dark:text-slate-500 mb-1"
                        >
                          <span>0</span>
                          <span class="ml-[25%]">30</span>
                          <span class="ml-auto mr-[25%]">70</span>
                          <span>100</span>
                        </div>
                        <!-- Bar -->
                        <div class="relative h-3 w-full mt-2">
                          <!-- Background Bar with Overflow Hidden for Corners -->
                          <div class="absolute inset-0 rounded-full overflow-hidden shadow-inner">
                            <!-- Oversold zone (0-30) - Green -->
                            <div
                              class="absolute inset-y-0 left-0 w-[30%] bg-gradient-to-r from-green-400 to-green-300 dark:from-green-600 dark:to-green-500"
                            ></div>
                            <!-- Neutral zone (30-70) - Amber/Yellow -->
                            <div
                              class="absolute inset-y-0 left-[30%] w-[40%] bg-gradient-to-r from-amber-300 via-yellow-200 to-amber-300 dark:from-amber-600/60 dark:via-yellow-500/50 dark:to-amber-600/60"
                            ></div>
                            <!-- Overbought zone (70-100) - Red -->
                            <div
                              class="absolute inset-y-0 right-0 w-[30%] bg-gradient-to-r from-red-300 to-red-400 dark:from-red-500 dark:to-red-600"
                            ></div>
                            <!-- Zone separators -->
                            <div class="absolute inset-y-0 left-[30%] w-0.5 bg-white/60 dark:bg-white/20"></div>
                            <div class="absolute inset-y-0 left-[70%] w-0.5 bg-white/60 dark:bg-white/20"></div>
                          </div>
                          <!-- Marker (Outside the bar's overflow-hidden container) -->
                          <div
                            id="tech-rsi-marker"
                            class="absolute top-1/2 -translate-y-1/2 w-4 h-4 bg-white dark:bg-slate-200 rounded-full border-2 border-slate-700 dark:border-slate-900 shadow-lg z-10 transition-all duration-500"
                            style="left: calc(50% - 8px)"
                          ></div>
                        </div>
                        <!-- Zone labels -->
                        <div class="flex justify-between text-[9px] font-semibold mt-1">
                          <span class="text-green-600 dark:text-green-400 w-[30%] text-center">Qu√° b√°n</span>
                          <span class="text-yellow-600 dark:text-yellow-400 w-[40%] text-center">Trung t√≠nh</span>
                          <span class="text-red-600 dark:text-red-400 w-[30%] text-center">Qu√° mua</span>
                        </div>
                      </div>
                      <div
                        id="tech-rsi-sparkline"
                        class="mini-sparkline h-[60px] skeleton-shimmer bg-slate-200/50 dark:bg-slate-800/40 rounded-xl"
                      ></div>
                      <div
                        id="tech-rsi-signal"
                        class="text-sm font-bold flex items-center justify-center skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-full w-24 h-6 ml-auto"
                      ></div>
                    </div>
                    <!-- Stochastic -->
                    <div class="space-y-1.5">
                      <div class="flex justify-between text-sm font-medium flex-wrap gap-1">
                        <span class="text-slate-500 indicator-tooltip"
                          >Stochastic<span class="tooltip-icon"><i data-lucide="info"></i></span
                          ><span class="tooltip-content"
                            >Stochastic Oscillator - So s√°nh gi√° ƒë√≥ng c·ª≠a v·ªõi ph·∫°m vi gi√° trong 14 phi√™n. K &lt; 20 =
                            Qu√° b√°n, K &gt; 80 = Qu√° mua. Giao c·∫Øt K/D b√°o hi·ªáu ƒë·∫£o chi·ªÅu</span
                          ></span
                        >
                        <div class="flex gap-2">
                          <span
                            id="tech-stoch-k"
                            class="font-bold text-slate-700 dark:text-slate-200 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md min-w-10 h-5 indicator-tooltip"
                            ><span class="tooltip-content"
                              >ƒê∆∞·ªùng %K (nhanh) c·ªßa Stochastic. > 80: Qu√° mua, < 20: Qu√° b√°n</span
                            ></span
                          >
                          <span
                            id="tech-stoch-d"
                            class="text-slate-400 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md min-w-10 h-5 ml-1 indicator-tooltip"
                            ><span class="tooltip-content"
                              >ƒê∆∞·ªùng %D (ch·∫≠m) c·ªßa Stochastic. Th∆∞·ªùng d√πng l√†m ƒë∆∞·ªùng t√≠n hi·ªáu</span
                            ></span
                          >
                        </div>
                      </div>
                      <div
                        id="tech-stoch-signal"
                        class="text-sm font-bold flex items-center justify-center skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-full w-24 h-6"
                      ></div>
                      <div
                        id="tech-stoch-sparkline"
                        class="mini-sparkline h-[60px] skeleton-shimmer bg-slate-200/50 dark:bg-slate-800/40 rounded-xl"
                      ></div>
                    </div>
                    <!-- MACD -->
                    <div class="space-y-1.5">
                      <div class="flex justify-between text-sm font-medium flex-wrap gap-1">
                        <span class="text-slate-500 indicator-tooltip"
                          >MACD (12, 26, 9)<span class="tooltip-icon"><i data-lucide="info"></i></span
                          ><span class="tooltip-content"
                            >Moving Average Convergence Divergence - ƒêo ƒë·ªông l∆∞·ª£ng xu h∆∞·ªõng. Histogram d∆∞∆°ng = xu h∆∞·ªõng
                            tƒÉng m·∫°nh, √¢m = xu h∆∞·ªõng gi·∫£m. Giao c·∫Øt MACD/Signal b√°o hi·ªáu mua/b√°n</span
                          ></span
                        >
                        <div class="flex gap-2">
                          <span
                            id="tech-macd-line"
                            class="font-bold text-slate-700 dark:text-slate-200 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md min-w-10 h-5 indicator-tooltip"
                            ><span class="tooltip-content"
                              >Gi√° tr·ªã ƒë∆∞·ªùng MACD (12-26). MACD > 0: Xu h∆∞·ªõng tƒÉng</span
                            ></span
                          >
                          <span
                            id="tech-macd-signal-val"
                            class="text-slate-400 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md min-w-10 h-5 ml-1 indicator-tooltip"
                            ><span class="tooltip-content"
                              >Gi√° tr·ªã ƒë∆∞·ªùng T√≠n hi·ªáu (Signal 9). Giao c·∫Øt v·ªõi MACD b√°o hi·ªáu mua/b√°n</span
                            ></span
                          >
                        </div>
                      </div>
                      <div class="flex justify-between text-sm font-bold">
                        <span
                          id="tech-macd-hist"
                          class="skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-14 h-4 indicator-tooltip"
                          ><span class="tooltip-content"
                            >ƒê·ªô ch√™nh l·ªách gi·ªØa MACD v√† Signal. Histogram cao = ƒë·ªông l∆∞·ª£ng m·∫°nh</span
                          ></span
                        >
                        <span
                          id="tech-macd-signal"
                          class="text-sm font-bold flex items-center justify-center skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-full w-24 h-6"
                        ></span>
                      </div>
                      <div
                        id="tech-macd-sparkline"
                        class="mini-sparkline h-[60px] skeleton-shimmer bg-slate-200/50 dark:bg-slate-800/40 rounded-xl"
                      ></div>
                    </div>
                    <!-- Williams %R -->
                    <div class="flex justify-between text-sm font-medium">
                      <span class="text-slate-500 indicator-tooltip"
                        >Williams %R<span class="tooltip-icon"><i data-lucide="info"></i></span
                        ><span class="tooltip-content"
                          >Williams Percent Range - ƒêo v·ªã tr√≠ gi√° trong ph·∫°m vi cao/th·∫•p. Gi√° tr·ªã t·ª´ -100 ƒë·∫øn 0. &lt;
                          -80 = Qu√° b√°n, &gt; -20 = Qu√° mua</span
                        ></span
                      >
                      <span
                        id="tech-willr"
                        class="font-bold text-slate-700 dark:text-slate-200 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-10 h-5 indicator-tooltip"
                        ><span class="tooltip-content"
                          >V·ªã tr√≠ gi√° hi·ªán t·∫°i trong ph·∫°m vi cao/th·∫•p. < -80: Qu√° b√°n, > -20: Qu√° mua</span
                        ></span
                      >
                    </div>
                  </div>
                </div>

                <!-- Trend Indicators -->
                <div
                  class="p-5 bg-white/30 dark:bg-slate-900/40 backdrop-blur-md rounded-3xl border border-slate-200 dark:border-white/10 shadow-lg hover:shadow-xl transition-shadow duration-300"
                >
                  <h5
                    class="flex items-center gap-2 text-[11px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-4"
                  >
                    <i data-lucide="move-up-right" class="w-4 h-4"></i> Xu h∆∞·ªõng
                    <span class="indicator-tooltip"
                      ><span class="tooltip-icon"><i data-lucide="info"></i></span
                      ><span class="tooltip-content"
                        >Nh√≥m ch·ªâ b√°o x√°c ƒë·ªãnh chi·ªÅu h∆∞·ªõng v√† s·ª©c m·∫°nh xu h∆∞·ªõng gi√°, bao g·ªìm ƒë∆∞·ªùng trung b√¨nh ƒë·ªông (MA)
                        v√† ADX</span
                      ></span
                    >
                  </h5>
                  <div class="space-y-4">
                    <div id="tech-ma-list" class="space-y-2 text-sm">
                      <div class="flex justify-between">
                        <span class="text-slate-500 indicator-tooltip"
                          >SMA20:<span class="tooltip-icon"><i data-lucide="info"></i></span
                          ><span class="tooltip-content"
                            >Simple Moving Average 20 - Trung b√¨nh gi√° ƒë√≥ng c·ª≠a 20 phi√™n g·∫ßn nh·∫•t. D√πng ƒë·ªÉ x√°c ƒë·ªãnh xu
                            h∆∞·ªõng ng·∫Øn h·∫°n</span
                          ></span
                        ><span
                          id="tech-sma20"
                          class="font-bold text-slate-700 dark:text-slate-200 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 h-5 indicator-tooltip"
                          ><span class="tooltip-content"
                            >ƒê∆∞·ªùng trung b√¨nh ƒë·ªông ƒë∆°n gi·∫£n 20 phi√™n. D√πng cho xu h∆∞·ªõng ng·∫Øn h·∫°n</span
                          ></span
                        >
                      </div>
                      <div class="flex justify-between">
                        <span class="text-slate-500 indicator-tooltip"
                          >SMA50:<span class="tooltip-icon"><i data-lucide="info"></i></span
                          ><span class="tooltip-content"
                            >Simple Moving Average 50 - Trung b√¨nh gi√° ƒë√≥ng c·ª≠a 50 phi√™n. D√πng ƒë·ªÉ x√°c ƒë·ªãnh xu h∆∞·ªõng
                            trung h·∫°n</span
                          ></span
                        ><span
                          id="tech-sma50"
                          class="font-bold text-slate-700 dark:text-slate-200 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 h-5 indicator-tooltip"
                          ><span class="tooltip-content"
                            >ƒê∆∞·ªùng trung b√¨nh ƒë·ªông ƒë∆°n gi·∫£n 50 phi√™n. D√πng cho xu h∆∞·ªõng trung h·∫°n</span
                          ></span
                        >
                      </div>
                      <div class="flex justify-between">
                        <span class="text-slate-500 indicator-tooltip"
                          >SMA100:<span class="tooltip-icon"><i data-lucide="info"></i></span
                          ><span class="tooltip-content"
                            >Simple Moving Average 100 - Trung b√¨nh gi√° 100 phi√™n. H·ªó tr·ª£/kh√°ng c·ª± quan tr·ªçng cho xu
                            h∆∞·ªõng trung-d√†i h·∫°n</span
                          ></span
                        ><span
                          id="tech-sma100"
                          class="font-bold text-slate-700 dark:text-slate-200 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 h-5 indicator-tooltip"
                          ><span class="tooltip-content"
                            >ƒê∆∞·ªùng trung b√¨nh ƒë·ªông ƒë∆°n gi·∫£n 100 phi√™n. H·ªó tr·ª£/kh√°ng c·ª± trung h·∫°n</span
                          ></span
                        >
                      </div>
                      <div class="flex justify-between">
                        <span class="text-slate-500 indicator-tooltip"
                          >SMA200:<span class="tooltip-icon"><i data-lucide="info"></i></span
                          ><span class="tooltip-content"
                            >Simple Moving Average 200 - Trung b√¨nh gi√° 200 phi√™n. Ch·ªâ b√°o quan tr·ªçng nh·∫•t cho xu h∆∞·ªõng
                            d√†i h·∫°n</span
                          ></span
                        ><span
                          id="tech-sma200"
                          class="font-bold text-slate-700 dark:text-slate-200 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 h-5 indicator-tooltip"
                          ><span class="tooltip-content"
                            >ƒê∆∞·ªùng trung b√¨nh ƒë·ªông ƒë∆°n gi·∫£n 200 phi√™n. Ch·ªâ b√°o xu th·∫ø d√†i h·∫°n c·ª±c k·ª≥ quan tr·ªçng</span
                          ></span
                        >
                      </div>
                      <div class="flex justify-between">
                        <span class="text-slate-500 indicator-tooltip"
                          >EMA20:<span class="tooltip-icon"><i data-lucide="info"></i></span
                          ><span class="tooltip-content"
                            >Exponential Moving Average 20 - Trung b√¨nh l≈©y th·ª´a 20 phi√™n. Nh·∫°y h∆°n SMA, ph·∫£n √°nh nhanh
                            bi·∫øn ƒë·ªông gi√°</span
                          ></span
                        ><span
                          id="tech-ema20"
                          class="font-bold text-slate-700 dark:text-slate-200 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 h-5 indicator-tooltip"
                          ><span class="tooltip-content"
                            >ƒê∆∞·ªùng trung b√¨nh ƒë·ªông l≈©y th·ª´a 20 phi√™n. Nh·∫°y b√©n h∆°n SMA v·ªõi c√°c bi·∫øn ƒë·ªông gi√° g·∫ßn
                            ƒë√¢y</span
                          ></span
                        >
                      </div>
                      <div class="flex justify-between">
                        <span class="text-slate-500 indicator-tooltip"
                          >EMA50:<span class="tooltip-icon"><i data-lucide="info"></i></span
                          ><span class="tooltip-content"
                            >Exponential Moving Average 50 - Trung b√¨nh l≈©y th·ª´a 50 phi√™n. K·∫øt h·ª£p ƒë·ªô nh·∫°y v√† xu h∆∞·ªõng
                            trung h·∫°n</span
                          ></span
                        ><span
                          id="tech-ema50"
                          class="font-bold text-slate-700 dark:text-slate-200 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 h-5 indicator-tooltip"
                          ><span class="tooltip-content"
                            >ƒê∆∞·ªùng trung b√¨nh ƒë·ªông l≈©y th·ª´a 50 phi√™n. C√¢n b·∫±ng gi·ªØa ƒë·ªô nh·∫°y v√† xu h∆∞·ªõng trung h·∫°n</span
                          ></span
                        >
                      </div>
                    </div>
                    <div class="pt-3 border-t border-slate-200 dark:border-white/5">
                      <div class="flex justify-between text-sm font-medium mb-1">
                        <span class="text-slate-500 indicator-tooltip"
                          >ADX<span class="tooltip-icon"><i data-lucide="info"></i></span
                          ><span class="tooltip-content"
                            >Average Directional Index - Ch·ªâ s·ªë ƒê·ªãnh h∆∞·ªõng Trung b√¨nh. ƒêo s·ª©c m·∫°nh xu h∆∞·ªõng. ADX &gt; 25
                            = xu h∆∞·ªõng m·∫°nh, &lt; 20 = ƒëi ngang. +DI/-DI x√°c ƒë·ªãnh chi·ªÅu tƒÉng/gi·∫£m</span
                          ></span
                        >
                        <span
                          id="tech-adx-val"
                          class="font-bold text-indigo-500 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-10 h-5 indicator-tooltip"
                          ><span class="tooltip-content"
                            >Ch·ªâ s·ªë ADX ƒëo s·ª©c m·∫°nh c·ªßa xu h∆∞·ªõng. > 25: Xu h∆∞·ªõng m·∫°nh, < 20: Kh√¥ng r√µ xu h∆∞·ªõng</span
                          ></span
                        >
                      </div>
                      <div class="flex items-center gap-2 mb-2">
                        <span
                          id="tech-adx-dmp"
                          class="text-sm font-bold text-emerald-500 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-10 h-4 indicator-tooltip"
                          ><span class="tooltip-content"
                            >Directional Movement Positive (+DI). Khi n·∫±m tr√™n -DI b√°o hi·ªáu √°p l·ª±c tƒÉng gi√°</span
                          ></span
                        >
                        <span class="text-slate-300">/</span>
                        <span
                          id="tech-adx-dmn"
                          class="text-sm font-bold text-rose-500 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-10 h-4 indicator-tooltip"
                          ><span class="tooltip-content"
                            >Directional Movement Negative (-DI). Khi n·∫±m tr√™n +DI b√°o hi·ªáu √°p l·ª±c gi·∫£m gi√°</span
                          ></span
                        >
                      </div>
                      <div
                        id="tech-adx-signal"
                        class="text-sm font-bold flex items-center justify-center skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-full w-32 h-6"
                      ></div>
                    </div>
                  </div>
                </div>

                <!-- Volatility -->
                <div
                  class="p-5 bg-white/30 dark:bg-slate-900/40 backdrop-blur-md rounded-3xl border border-slate-200 dark:border-white/10 shadow-lg hover:shadow-xl transition-shadow duration-300"
                >
                  <h5
                    class="flex items-center gap-2 text-[11px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-4"
                  >
                    <i data-lucide="waves" class="w-4 h-4"></i> Bi·∫øn ƒë·ªông
                    <span class="indicator-tooltip"
                      ><span class="tooltip-icon"><i data-lucide="info"></i></span
                      ><span class="tooltip-content"
                        >Nh√≥m ch·ªâ b√°o ƒëo l∆∞·ªùng m·ª©c ƒë·ªô dao ƒë·ªông gi√°, gi√∫p x√°c ƒë·ªãnh ng∆∞·ª°ng h·ªó tr·ª£/kh√°ng c·ª± v√† ƒë√°nh gi√° r·ªßi
                        ro</span
                      ></span
                    >
                  </h5>
                  <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                      <span class="text-slate-500 indicator-tooltip"
                        >BB Tr√™n:<span class="tooltip-icon"><i data-lucide="info"></i></span
                        ><span class="tooltip-content"
                          >Bollinger Band Upper - D·∫£i Bollinger tr√™n. Gi√° ch·∫°m BB tr√™n th∆∞·ªùng cho th·∫•y qu√° mua, c√≥ th·ªÉ
                          ƒëi·ªÅu ch·ªânh</span
                        ></span
                      ><span
                        id="tech-bb-upper"
                        class="font-bold text-slate-700 dark:text-slate-200 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 h-5 indicator-tooltip"
                        ><span class="tooltip-content"
                          >D·∫£i Bollinger tr√™n. Gi√° v∆∞·ª£t qua d·∫£i n√†y th∆∞·ªùng b√°o hi·ªáu tr·∫°ng th√°i qu√° mua</span
                        ></span
                      >
                    </div>
                    <div class="flex justify-between">
                      <span class="text-slate-500 indicator-tooltip"
                        >BB Gi·ªØa:<span class="tooltip-icon"><i data-lucide="info"></i></span
                        ><span class="tooltip-content"
                          >Bollinger Band Middle - ƒê∆∞·ªùng trung b√¨nh 20 phi√™n, l√† m·ª©c h·ªó tr·ª£/kh√°ng c·ª± ƒë·ªông c·ªßa d·∫£i
                          Bollinger</span
                        ></span
                      ><span
                        id="tech-bb-middle"
                        class="font-bold text-slate-700 dark:text-slate-200 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 h-5 indicator-tooltip"
                        ><span class="tooltip-content"
                          >ƒê∆∞·ªùng trung t√¢m d·∫£i Bollinger (SMA 20). ƒê√≥ng vai tr√≤ l√† m·ª©c c√¢n b·∫±ng ƒë·ªông</span
                        ></span
                      >
                    </div>
                    <div class="flex justify-between">
                      <span class="text-slate-500 indicator-tooltip"
                        >BB D∆∞·ªõi:<span class="tooltip-icon"><i data-lucide="info"></i></span
                        ><span class="tooltip-content"
                          >Bollinger Band Lower - D·∫£i Bollinger d∆∞·ªõi. Gi√° ch·∫°m BB d∆∞·ªõi th∆∞·ªùng cho th·∫•y qu√° b√°n, c√≥ th·ªÉ
                          h·ªìi ph·ª•c</span
                        ></span
                      ><span
                        id="tech-bb-lower"
                        class="font-bold text-slate-700 dark:text-slate-200 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 h-5 indicator-tooltip"
                        ><span class="tooltip-content"
                          >D·∫£i Bollinger d∆∞·ªõi. Gi√° r∆°i d∆∞·ªõi d·∫£i n√†y th∆∞·ªùng b√°o hi·ªáu tr·∫°ng th√°i qu√° b√°n</span
                        ></span
                      >
                    </div>
                    <div
                      id="tech-bb-signal"
                      class="text-sm font-bold flex items-center justify-center skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-full w-24 h-6"
                    ></div>
                    <div class="pt-2 border-t border-slate-200 dark:border-white/5 flex justify-between">
                      <span class="text-slate-500 indicator-tooltip"
                        >ATR:<span class="tooltip-icon"><i data-lucide="info"></i></span
                        ><span class="tooltip-content"
                          >Average True Range - Ph·∫°m vi Th·ª±c Trung b√¨nh. ƒêo bi√™n ƒë·ªô dao ƒë·ªông gi√° trung b√¨nh. ATR cao =
                          bi·∫øn ƒë·ªông m·∫°nh</span
                        ></span
                      >
                      <span
                        id="tech-atr"
                        class="font-bold text-slate-700 dark:text-slate-200 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 h-5 indicator-tooltip"
                        ><span class="tooltip-content"
                          >Average True Range ƒëo l∆∞·ªùng m·ª©c ƒë·ªô bi·∫øn ƒë·ªông tuy·ªát ƒë·ªëi c·ªßa gi√°. ATR cao = r·ªßi ro cao</span
                        ></span
                      >
                    </div>
                  </div>
                </div>

                <!-- Kh·ªëi l∆∞·ª£ng & D√≤ng ti·ªÅn -->
                <div
                  class="p-5 bg-white/30 dark:bg-slate-900/40 backdrop-blur-md rounded-3xl border border-slate-200 dark:border-white/10 shadow-lg hover:shadow-xl transition-shadow duration-300"
                >
                  <h5
                    class="flex items-center gap-2 text-[11px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-4"
                  >
                    <i data-lucide="bar-chart-3" class="w-4 h-4"></i> Kh·ªëi l∆∞·ª£ng & D√≤ng ti·ªÅn
                    <span class="indicator-tooltip"
                      ><span class="tooltip-icon"><i data-lucide="info"></i></span
                      ><span class="tooltip-content"
                        >Nh√≥m ch·ªâ b√°o ph√¢n t√≠ch kh·ªëi l∆∞·ª£ng giao d·ªãch v√† d√≤ng ti·ªÅn, gi√∫p x√°c nh·∫≠n xu h∆∞·ªõng</span
                      ></span
                    >
                  </h5>
                  <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                      <span class="text-slate-500 indicator-tooltip"
                        >OBV:<span class="tooltip-icon"><i data-lucide="info"></i></span
                        ><span class="tooltip-content"
                          >On-Balance Volume - Kh·ªëi l∆∞·ª£ng C√¢n b·∫±ng. TƒÉng = d√≤ng ti·ªÅn v√†o, Gi·∫£m = d√≤ng ti·ªÅn ra. X√°c nh·∫≠n
                          s·ª©c m·∫°nh xu h∆∞·ªõng</span
                        ></span
                      >
                      <span
                        id="tech-obv-trend"
                        class="font-bold text-slate-700 dark:text-slate-200 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-14 h-5 indicator-tooltip"
                        ><span class="tooltip-content"
                          >Xu h∆∞·ªõng c·ªßa On-Balance Volume. OBV tƒÉng x√°c nh·∫≠n s·ª± t√≠ch l≈©y c·ªßa d√≤ng ti·ªÅn</span
                        ></span
                      >
                    </div>
                    <div class="flex justify-between">
                      <span class="text-slate-500 indicator-tooltip"
                        >CMF:<span class="tooltip-icon"><i data-lucide="info"></i></span
                        ><span class="tooltip-content"
                          >Chaikin Money Flow - D√≤ng ti·ªÅn Chaikin. CMF > 0 = √°p l·ª±c mua, CMF < 0 = √°p l·ª±c b√°n</span
                        ></span
                      >
                      <span
                        id="tech-cmf"
                        class="font-bold text-slate-700 dark:text-slate-200 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-14 h-5 text-right indicator-tooltip"
                        ><span class="tooltip-content"
                          >Chaikin Money Flow ƒëo l∆∞·ªùng l·ª±c mua/b√°n t√≠ch l≈©y. CMF > 0: D√≤ng ti·ªÅn ƒëang v√†o</span
                        ></span
                      >
                    </div>
                    <div
                      id="tech-vol-signal"
                      class="text-sm font-bold flex items-center justify-center skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-full w-32 h-6"
                    ></div>
                  </div>
                </div>

                <!-- Pivot Points -->
                <div
                  class="p-5 bg-white/30 dark:bg-slate-900/40 backdrop-blur-md rounded-3xl border border-slate-200 dark:border-white/10 shadow-lg hover:shadow-xl transition-shadow duration-300"
                >
                  <h5
                    class="flex items-center gap-2 text-[11px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-4"
                  >
                    <i data-lucide="target" class="w-4 h-4"></i> ƒêi·ªÉm Pivot
                    <span class="indicator-tooltip"
                      ><span class="tooltip-icon"><i data-lucide="info"></i></span
                      ><span class="tooltip-content"
                        >C√°c m·ª©c gi√° quan tr·∫≠ng t√≠nh t·ª´ gi√° Cao/Th·∫•p/ƒê√≥ng c·ª≠a phi√™n tr∆∞·ªõc. H·ªó tr·ª£ (S) v√† Kh√°ng c·ª± (R) l√†
                        c√°c m·ª©c gi√° ti·ªÅm nƒÉng ƒë·∫£o chi·ªÅu</span
                      ></span
                    >
                  </h5>
                  <div class="space-y-2 text-sm">
                    <div class="flex justify-between font-bold text-indigo-500 mb-1">
                      <span class="text-slate-500 font-medium">Pivot</span
                      ><span
                        id="tech-pivot"
                        class="skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 h-5 indicator-tooltip"
                        ><span class="tooltip-content"
                          >ƒêi·ªÉm xoay trung t√¢m. L√† gi√° tr·ªã trung b√¨nh c·ªßa Cao, Th·∫•p v√† ƒê√≥ng c·ª≠a phi√™n tr∆∞·ªõc</span
                        ></span
                      >
                    </div>
                    <div class="flex justify-between">
                      <span class="text-slate-500">Kh√°ng c·ª± 1</span
                      ><span
                        id="tech-pivot-r1"
                        class="text-rose-500 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 h-5 indicator-tooltip"
                        ><span class="tooltip-content">M·ª©c kh√°ng c·ª± 1. V√πng gi√° phe b√°n th∆∞·ªùng tr·ª±c ch·ªù</span></span
                      >
                    </div>
                    <div class="flex justify-between">
                      <span class="text-slate-500">Kh√°ng c·ª± 2</span
                      ><span
                        id="tech-pivot-r2"
                        class="text-rose-500 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 h-5 indicator-tooltip"
                        ><span class="tooltip-content">M·ª©c kh√°ng c·ª± 2. V√πng gi√° m·ª•c ti√™u n·∫øu v∆∞·ª£t qua R1</span></span
                      >
                    </div>
                    <div class="flex justify-between">
                      <span class="text-slate-500">Kh√°ng c·ª± 3</span
                      ><span
                        id="tech-pivot-r3"
                        class="text-rose-500 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 h-5 indicator-tooltip"
                        ><span class="tooltip-content">M·ª©c kh√°ng c·ª± 3. Ng∆∞·ª°ng kh√°ng c·ª± m·∫°nh nh·∫•t trong ng√†y</span></span
                      >
                    </div>
                    <div class="flex justify-between">
                      <span class="text-slate-500">H·ªó tr·ª£ 1</span
                      ><span
                        id="tech-pivot-s1"
                        class="text-emerald-500 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 h-5 indicator-tooltip"
                        ><span class="tooltip-content">M·ª©c h·ªó tr·ª£ 1. V√πng gi√° phe mua th∆∞·ªùng tr·ª±c ch·ªù</span></span
                      >
                    </div>
                    <div class="flex justify-between">
                      <span class="text-slate-500">H·ªó tr·ª£ 2</span
                      ><span
                        id="tech-pivot-s2"
                        class="text-emerald-500 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 h-5 indicator-tooltip"
                        ><span class="tooltip-content">M·ª©c h·ªó tr·ª£ 2. V√πng gi√° m·ª•c ti√™u n·∫øu xuy√™n th·ªßng S1</span></span
                      >
                    </div>
                    <div class="flex justify-between">
                      <span class="text-slate-500">H·ªó tr·ª£ 3</span
                      ><span
                        id="tech-pivot-s3"
                        class="text-emerald-500 skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 h-5 indicator-tooltip"
                        ><span class="tooltip-content">M·ª©c h·ªó tr·ª£ 3. Ng∆∞·ª°ng h·ªó tr·ª£ m·∫°nh nh·∫•t trong ng√†y</span></span
                      >
                    </div>
                  </div>
                </div>
                <!-- Fibonacci -->
                <div
                  class="p-5 bg-white/30 dark:bg-slate-900/40 backdrop-blur-md rounded-3xl border border-slate-200 dark:border-white/10 shadow-lg hover:shadow-xl transition-shadow duration-300"
                >
                  <h5
                    class="flex items-center gap-2 text-[11px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-4"
                  >
                    <i data-lucide="layers" class="w-4 h-4"></i> Fibonacci
                    <span class="indicator-tooltip"
                      ><span class="tooltip-icon"><i data-lucide="info"></i></span
                      ><span class="tooltip-content"
                        >C√°c m·ª©c t·ªâ l·ªá Fibonacci (0%, 23.6%, 38.2%, 50%, 61.8%, 78.6%, 100%) d·ª±a tr√™n bi√™n ƒë·ªô gi√°.
                        Th∆∞·ªùng d√πng ƒë·ªÉ x√°c ƒë·ªãnh m·ª©c h·ªìi/ƒëi·ªÅu ch·ªânh</span
                      ></span
                    >
                  </h5>
                  <div class="space-y-2 text-sm pt-1">
                    <div class="flex justify-between">
                      <span class="text-slate-500">M·ª©c 0.0%</span
                      ><span
                        id="tech-fib-0"
                        class="skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 h-5 indicator-tooltip"
                        ><span class="tooltip-content">M·ª©c th·∫•p nh·∫•t trong ph·∫°m vi xu h∆∞·ªõng ƒëang x√©t</span></span
                      >
                    </div>
                    <div class="flex justify-between text-yellow-500 font-medium">
                      <span class="text-slate-500 font-normal">M·ª©c 23.6%</span
                      ><span
                        id="tech-fib-236"
                        class="skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 h-5 indicator-tooltip"
                        ><span class="tooltip-content">Ng∆∞·ª°ng h·ªìi quy Fibonacci 23.6%. M·ª©c ƒëi·ªÅu ch·ªânh n√¥ng</span></span
                      >
                    </div>
                    <div class="flex justify-between text-amber-500 font-medium">
                      <span class="text-slate-500 font-normal">M·ª©c 38.2%</span
                      ><span
                        id="tech-fib-382"
                        class="skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 h-5 indicator-tooltip"
                        ><span class="tooltip-content"
                          >Ng∆∞·ª°ng h·ªìi quy Fibonacci 38.2%. M·ª©c h·ªó tr·ª£/kh√°ng c·ª± th∆∞·ªùng g·∫∑p</span
                        ></span
                      >
                    </div>
                    <div class="flex justify-between text-indigo-500 font-bold">
                      <span class="text-slate-500 font-normal">M·ª©c 50.0%</span
                      ><span
                        id="tech-fib-500"
                        class="skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 h-5 indicator-tooltip"
                        ><span class="tooltip-content"
                          >M·ª©c 50.0%. Kh√¥ng ph·∫£i t·ªâ l·ªá Fib nh∆∞ng l√† ng∆∞·ª°ng t√¢m l√Ω quan tr·ªçng</span
                        ></span
                      >
                    </div>
                    <div class="flex justify-between text-emerald-500 font-medium">
                      <span class="text-slate-500 font-normal">M·ª©c 61.8%</span
                      ><span
                        id="tech-fib-618"
                        class="skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 h-5 indicator-tooltip"
                        ><span class="tooltip-content"
                          >T·ªâ l·ªá V√†ng (Golden Ratio). Ng∆∞·ª°ng quan tr·ªçng ƒë·ªÉ x√°c ƒë·ªãnh xu h∆∞·ªõng c√≤n ti·∫øp di·ªÖn hay
                          kh√¥ng</span
                        ></span
                      >
                    </div>
                    <div class="flex justify-between text-teal-500 font-medium">
                      <span class="text-slate-500 font-normal">M·ª©c 78.6%</span
                      ><span
                        id="tech-fib-786"
                        class="skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 h-5 indicator-tooltip"
                        ><span class="tooltip-content">Ng∆∞·ª°ng h·ªìi quy Fibonacci 78.6%. M·ª©c ƒëi·ªÅu ch·ªânh s√¢u</span></span
                      >
                    </div>
                    <div class="flex justify-between">
                      <span class="text-slate-500">M·ª©c 100.0%</span
                      ><span
                        id="tech-fib-100"
                        class="skeleton-shimmer text-transparent bg-slate-200/50 dark:bg-slate-800/50 rounded-md w-16 h-5 indicator-tooltip"
                        ><span class="tooltip-content">M·ª©c cao nh·∫•t trong ph·∫°m vi xu h∆∞·ªõng ƒëang x√©t</span></span
                      >
                    </div>
                  </div>
                </div>
              </div>

              <!-- Right Columns: AI -->
              <div class="lg:col-span-2 space-y-4">
                <!-- AI Core Analysis -->
                <div
                  class="p-6 bg-white/40 dark:bg-slate-900/50 backdrop-blur-xl rounded-3xl border border-white/50 dark:border-white/10 shadow-2xl relative overflow-hidden"
                >
                  <div
                    class="absolute inset-0 bg-gradient-to-br from-indigo-500/5 to-purple-500/5 pointer-events-none"
                  ></div>
                  <div class="flex items-center gap-2 mb-4 border-b border-slate-200 dark:border-white/10 pb-3">
                    <div
                      class="w-10 h-10 rounded-full bg-indigo-50 dark:bg-indigo-500/20 flex items-center justify-center text-indigo-600 dark:text-indigo-400 shadow-sm border border-indigo-100 dark:border-transparent"
                    >
                      <i data-lucide="brain-circuit" class="w-5 h-5"></i>
                    </div>
                    <h4 class="font-bold text-slate-800 dark:text-white text-lg">T·ªïng h·ª£p t·ª´ AI</h4>
                    <div class="flex-1 text-right flex items-center justify-end gap-2 text-xs flex-wrap">
                      <div
                        id="tech-recommendation-badge"
                        class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold transition-all border border-transparent opacity-0"
                      ></div>
                      <span
                        id="tech-gauge-ma"
                        class="inline-flex items-center gap-1 px-2.5 py-1 bg-gradient-to-r from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg shadow-sm text-[11px] font-semibold text-slate-600 dark:text-slate-300 skeleton-shimmer text-transparent min-w-[70px] h-6 indicator-tooltip"
                        ><span class="tooltip-content">ƒêi·ªÉm t·ªïng h·ª£p t·ª´ c√°c ch·ªâ b√°o xu h∆∞·ªõng (MA)</span
                        ><i data-lucide="trending-up" class="w-3 h-3"></i><span class="gauge-text">MA: --</span></span
                      >
                      <span
                        id="tech-gauge-osc"
                        class="inline-flex items-center gap-1 px-2.5 py-1 bg-gradient-to-r from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg shadow-sm text-[11px] font-semibold text-slate-600 dark:text-slate-300 skeleton-shimmer text-transparent min-w-[70px] h-6 indicator-tooltip"
                        ><span class="tooltip-content"
                          >ƒêi·ªÉm t·ªïng h·ª£p t·ª´ c√°c ch·ªâ b√°o ƒë·ªông l∆∞·ª£ng (RSI, Stochastic...)</span
                        ><i data-lucide="activity" class="w-3 h-3"></i><span class="gauge-text">OSC: --</span></span
                      >
                      <span
                        id="tech-gauge-summary"
                        class="inline-flex items-center gap-1 px-2.5 py-1 bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/40 dark:to-purple-900/40 border border-indigo-200 dark:border-indigo-500/30 rounded-lg shadow-sm text-[11px] font-bold text-indigo-600 dark:text-indigo-400 skeleton-shimmer text-transparent min-w-[80px] h-6 indicator-tooltip"
                        ><span class="tooltip-content">Khuy·∫øn ngh·ªã t·ªïng h·ª£p t·ª´ s·ª± k·∫øt h·ª£p c·ªßa t·∫•t c·∫£ c√°c ch·ªâ b√°o</span
                        ><i data-lucide="bar-chart-2" class="w-3 h-3"></i><span class="gauge-text">--</span></span
                      >
                    </div>
                  </div>
                  <div
                    id="tech-analysis-content"
                    class="text-[15px] text-slate-600 dark:text-slate-300 leading-relaxed max-h-[480px] overflow-y-auto custom-scrollbar pr-2 markdown-content prose prose-sm dark:prose-invert max-w-none"
                  >
                    <div class="flex items-center gap-2 text-slate-400 mb-2">
                      <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                      <span class="text-sm">ƒêang t·∫£i d·ªØ li·ªáu ph√¢n t√≠ch...</span>
                    </div>
                  </div>
                </div>

                <!-- Strategy Methods -->
                <div
                  class="p-5 bg-white/30 dark:bg-slate-900/40 backdrop-blur-md rounded-3xl border border-slate-200 dark:border-white/10 shadow-lg hover:shadow-xl transition-shadow duration-300"
                >
                  <h5
                    class="flex items-center gap-2 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-3"
                  >
                    <i data-lucide="crosshair" class="w-4 h-4"></i> Chi·∫øn l∆∞·ª£c √°p d·ª•ng
                  </h5>
                  <div id="tech-methods-list" class="space-y-3">
                    <div class="h-24 bg-slate-200/50 dark:bg-slate-800/50 skeleton-shimmer rounded-2xl"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="/static/js/utils.js"></script>
    <script src="/static/js/user.js"></script>
    <script src="/static/js/settings.js"></script>
    <script src="/static/js/portfolio.js"></script>
    <script src="/static/js/chat.js"></script>
    <script>
      let currentTabId = "chart";
      function switchTab(tabId) {
        currentTabId = tabId;
        const rightColumn = document.getElementById("right-column");
        const isDual = rightColumn && rightColumn.classList.contains("dual-panel-active");

        // Hide all tab contents
        document.getElementById("tab-empty-state").classList.add("hidden");
        document.getElementById("tab-content-chart").classList.add("hidden");
        document.getElementById("tab-content-news").classList.add("hidden");
        document.getElementById("tab-content-analysis").classList.add("hidden");

        // Show selected content
        document.getElementById(`tab-content-${tabId}`).classList.remove("hidden");

        // If dual panel is active, chart MUST also be visible
        if (isDual) {
          document.getElementById("tab-content-chart").classList.remove("hidden");
        }

        // Update button states
        document.querySelectorAll(".sidebar-tab-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        const activeBtn = document.getElementById(`tab-btn-${tabId}`);
        activeBtn.classList.add("active");

        // Animate indicator
        updateTabIndicator(activeBtn);

        // Handle chart resize for chart tab
        if (tabId === "chart") {
          setTimeout(() => {
            window.dispatchEvent(new Event("resize"));
            if (typeof priceChart !== "undefined" && priceChart) priceChart.timeScale().fitContent();
            if (typeof volumeChart !== "undefined" && volumeChart) volumeChart.timeScale().fitContent();
          }, 50);
        } else if (tabId === "analysis") {
          // Resize analysis chart when switching to analysis tab
          setTimeout(() => {
            window.dispatchEvent(new Event("resize"));
            if (typeof analysisChart !== "undefined" && analysisChart) analysisChart.timeScale().fitContent();
          }, 50);
        }

        // Trigger news analysis if switching to news tab and it hasn't been loaded for current stock
        if (tabId === "news" && selectedStock && selectedStock !== lastFetchedNewsSymbol) {
          fetchNewsAnalysis(selectedStock, selectedStockCompanyName);
          lastFetchedNewsSymbol = selectedStock;
        }

        // Trigger technical analysis if switching to analysis tab
        if (tabId === "analysis" && lastFetchedTechnicalSymbol) {
          document.getElementById("analysis-content-timeframe").classList.remove("hidden");
          document.getElementById("analysis-chart-collapsible").classList.remove("hidden");
        }
        if (tabId === "analysis" && selectedStock && selectedStock !== lastFetchedTechnicalSymbol) {
          fetchTechnicalAnalysis(selectedStock, selectedStockCompanyName);
          lastFetchedTechnicalSymbol = selectedStock;
        }
      }

      function updateTabIndicator(btn) {
        const indicator = document.getElementById("tab-indicator");
        const tabBar = document.getElementById("tab-bar");

        if (btn && indicator && tabBar) {
          indicator.style.width = `${btn.offsetWidth}px`;
          indicator.style.height = `${btn.offsetHeight}px`;
          indicator.style.left = `${btn.offsetLeft}px`;
          indicator.style.top = `${btn.offsetTop}px`;
        }
      }

      // Initialize Tab Indicator on load
      window.addEventListener("load", () => {
        const activeBtn = document.querySelector(".sidebar-tab-btn.active");
        if (activeBtn) updateTabIndicator(activeBtn);
      });

      // Update Tab Indicator using ResizeObserver for accurate measurements after layout
      const tabBar = document.getElementById("tab-bar");
      if (tabBar) {
        const tabBarResizeObserver = new ResizeObserver(() => {
          const activeBtn = document.getElementById(`tab-btn-${currentTabId}`);
          if (activeBtn) updateTabIndicator(activeBtn);
        });
        tabBarResizeObserver.observe(tabBar);
      }

      // Layout Controls
      function toggleSidebar() {
        document.body.classList.toggle("sidebar-collapsed");
        const rightColumn = document.getElementById("right-column");
        if (rightColumn) {
          rightColumn.classList.toggle("dual-panel-active");
          // Re-trigger switchTab to ensure correct visibility in dual mode
          switchTab(currentTabId);
        }

        // Update icons
        lucide.createIcons();

        // Trigger resize for charts
        setTimeout(() => {
          window.dispatchEvent(new Event("resize"));
          if (typeof priceChart !== "undefined" && priceChart) priceChart.timeScale().fitContent();
          if (typeof analysisChart !== "undefined" && analysisChart) techAnalysisChart.timeScale().fitContent();
        }, 50);
      }

      function toggleAnalysisChart() {
        const wrapper = document.getElementById("analysis-chart-wrapper");
        const analysisIcon = document.getElementById("analysis-chart-toggle-icon");

        if (wrapper) {
          wrapper.classList.toggle("collapsed");
          if (analysisIcon) {
            analysisIcon.style.transform = wrapper.classList.contains("collapsed") ? "rotate(180deg)" : "rotate(0deg)";
          }
        }
      }

      // Initialize Lucide Icons
      lucide.createIcons();

      // Resizer Logic
      const resizer = document.getElementById("resizer");
      const leftColumn = document.getElementById("left-column");
      const mainContainer = document.getElementById("main-container");

      let isResizing = false;

      resizer.addEventListener("mousedown", (e) => {
        isResizing = true;
        resizer.classList.add("resizing");
        document.body.style.cursor = "col-resize";
        // Disable text selection and pointer events in iframe/content during resize
        document.body.classList.add("select-none");
      });

      document.addEventListener("mousemove", (e) => {
        if (!isResizing || window.innerWidth < 1024) return;

        const containerWidth = mainContainer.offsetWidth;
        let newLeftWidth = (e.clientX / containerWidth) * 100;

        // Constraints
        if (newLeftWidth < 20) newLeftWidth = 20;
        if (newLeftWidth > 80) newLeftWidth = 80;

        leftColumn.style.width = `${newLeftWidth}%`;

        // Re-sync tab indicator in real-time
        const activeBtn = document.querySelector(".sidebar-tab-btn.active");
        if (activeBtn) updateTabIndicator(activeBtn);
      });

      // Reset layout for mobile on window resize
      window.addEventListener("resize", () => {
        // If mobile view, reset the inline width usage to let CSS classes take over
        if (window.innerWidth < 1024) {
          leftColumn.style.width = "";
        }
      });

      document.addEventListener("mouseup", () => {
        isResizing = false;
        resizer.classList.remove("resizing");
        document.body.style.cursor = "default";
        document.body.classList.remove("select-none");
      });

      // Analysis Chart Vertical Resizer
      const analysisChartResizer = document.getElementById("analysis-chart-resizer");
      const analysisChartContainer = document.getElementById("analysis-price-chart-container");

      let isResizingAnalysisChart = false;

      if (analysisChartResizer && analysisChartContainer) {
        analysisChartResizer.addEventListener("mousedown", (e) => {
          isResizingAnalysisChart = true;
          analysisChartResizer.classList.add("resizing");
          document.body.style.cursor = "ns-resize";
          document.body.classList.add("select-none");
        });

        document.addEventListener("mousemove", (e) => {
          if (!isResizingAnalysisChart) return;

          const rect = analysisChartContainer.getBoundingClientRect();
          const newHeight = e.clientY - rect.top;

          // Constraints: Min 200px, Max 800px
          if (newHeight >= 200 && newHeight <= 800) {
            analysisChartContainer.style.height = `${newHeight}px`;
            // Call fitContent during resizing for real-time scaling
            if (typeof analysisChart !== "undefined" && analysisChart) {
              analysisChart.timeScale().fitContent();
            }
          }
        });

        document.addEventListener("mouseup", () => {
          if (isResizingAnalysisChart) {
            isResizingAnalysisChart = false;
            analysisChartResizer.classList.remove("resizing");
            document.body.style.cursor = "default";
            document.body.classList.remove("select-none");

            // Optional: Save height preference
            localStorage.setItem("analysis-chart-height", analysisChartContainer.style.height);
          }
        });

        // Load saved height if exists
        const savedHeight = localStorage.getItem("analysis-chart-height");
        if (savedHeight) {
          analysisChartContainer.style.height = savedHeight;
        }
      }

      // --- Valid Stock Symbols (fetched from backend) ---
      let symbolsMap = {}; // symbol -> {name, exchange}
      const VALID_EXCHANGES = ["HOSE", "HNX", "UPCOM", "HSX", "VN30", "HNX30"];

      async function fetchValidSymbols() {
        try {
          const response = await fetch("/symbols");
          if (response.ok) {
            const data = await response.json();
            // Filter to cache only valid stocks
            symbolsMap = {};
            for (const [symbol, info] of Object.entries(data.symbols || {})) {
              const exchange = (info?.exchange || "HOSE").toUpperCase();
              if (VALID_EXCHANGES.includes(exchange) && ["STOCK", "ETF"].includes(info.type)) {
                symbolsMap[symbol] = info;
              }
            }
          }
        } catch (error) {
          console.error("Failed to fetch stock symbols:", error);
        }
      }

      // Helper to get stock info
      function getStockInfo(symbol) {
        const info = symbolsMap[symbol];
        if (info && typeof info === "object") {
          return {
            name: info.name || symbol,
            exchange: info.exchange || "HOSE",
          };
        }
        // Fallback for old format (string)
        return { name: info || symbol, exchange: "HOSE" };
      }

      // Fetch symbols on page load
      fetchValidSymbols();

      let selectedStock = null;
      let selectedStockCompanyName = null;
      let lastFetchedNewsSymbol = null;
      let lastFetchedTechnicalSymbol = null;

      // Global chart instances for cleanup (Lightweight Charts)
      let priceChart = null;
      let volumeChart = null;
      let candleSeries = null;
      let volumeSeries = null;
      let indicatorSeries = []; // Array to hold indicator line series
      let indicatorValues = {}; // Store raw indicator values mapping time -> {key: value}
      let currentChartSymbol = null;

      // Analysis chart instances (separate from main chart)
      let analysisChart = null;
      let analysisCandleSeries = null;
      let currentAnalysisTimeframe = "short_term"; // "short_term" or "long_term"

      // Calculate Moving Average
      function calculateMA(data, period) {
        return data.map((_, i, arr) => {
          if (i < period - 1) return null;
          const slice = arr.slice(i - period + 1, i + 1);
          return slice.reduce((sum, d) => sum + d.c, 0) / period;
        });
      }

      // Calculate EMA
      function calculateEMA(data, period) {
        const k = 2 / (period + 1);
        const ema = [data[0].c];
        for (let i = 1; i < data.length; i++) {
          ema.push(data[i].c * k + ema[i - 1] * (1 - k));
        }
        return ema;
      }

      // Calculate Bollinger Bands
      function calculateBB(data, period = 20, stdDev = 2) {
        const ma = calculateMA(data, period);
        return ma.map((mean, i) => {
          if (mean === null) return { upper: null, middle: null, lower: null };
          const slice = data.slice(Math.max(0, i - period + 1), i + 1);
          const variance = slice.reduce((sum, d) => sum + Math.pow(d.c - mean, 2), 0) / period;
          const std = Math.sqrt(variance);
          return {
            upper: mean + stdDev * std,
            middle: mean,
            lower: mean - stdDev * std,
          };
        });
      }

      // Calculate RSI (Relative Strength Index)
      function calculateRSI(data, period = 14) {
        const changes = data.map((d, i) => (i === 0 ? 0 : d.c - data[i - 1].c));
        const gains = changes.map((c) => (c > 0 ? c : 0));
        const losses = changes.map((c) => (c < 0 ? -c : 0));

        let avgGain = gains.slice(1, period + 1).reduce((a, b) => a + b, 0) / period;
        let avgLoss = losses.slice(1, period + 1).reduce((a, b) => a + b, 0) / period;

        return data.map((_, i) => {
          if (i < period) return null;
          if (i === period) {
            return avgLoss === 0 ? 100 : 100 - 100 / (1 + avgGain / avgLoss);
          }
          avgGain = (avgGain * (period - 1) + gains[i]) / period;
          avgLoss = (avgLoss * (period - 1) + losses[i]) / period;
          return avgLoss === 0 ? 100 : 100 - 100 / (1 + avgGain / avgLoss);
        });
      }

      // Calculate MACD (Moving Average Convergence Divergence)
      function calculateMACD(data, fast = 12, slow = 26, signal = 9) {
        const emaFast = calculateEMA(data, fast);
        const emaSlow = calculateEMA(data, slow);
        const macdLine = emaFast.map((f, i) => (i < slow - 1 ? null : f - emaSlow[i]));

        // Calculate signal line (EMA of MACD line)
        const validMacd = macdLine.filter((v) => v !== null);
        const k = 2 / (signal + 1);
        const signalLine = [];
        let signalEma = validMacd[0];

        let validIndex = 0;
        for (let i = 0; i < macdLine.length; i++) {
          if (macdLine[i] === null) {
            signalLine.push(null);
          } else {
            if (validIndex === 0) {
              signalLine.push(signalEma);
            } else if (validIndex < signal) {
              signalEma = (macdLine[i] + signalEma * validIndex) / (validIndex + 1);
              signalLine.push(null);
            } else {
              signalEma = macdLine[i] * k + signalEma * (1 - k);
              signalLine.push(signalEma);
            }
            validIndex++;
          }
        }

        const histogram = macdLine.map((m, i) => (m === null || signalLine[i] === null ? null : m - signalLine[i]));

        return { macdLine, signalLine, histogram };
      }

      // Calculate Volume SMA
      function calculateVolumeSMA(data, period = 20) {
        return data.map((_, i, arr) => {
          if (i < period - 1) return null;
          const slice = arr.slice(i - period + 1, i + 1);
          return slice.reduce((sum, d) => sum + d.v, 0) / period;
        });
      }

      // Initialize Advanced Chart
      function initAdvancedChart(symbol) {
        currentChartSymbol = symbol;
        const timeframe = document.getElementById("chart-timeframe")?.value || "1M";
        const interval = document.getElementById("chart-interval")?.value || "1D";

        renderAdvancedChart(symbol, timeframe, interval);

        // Add event listeners for controls
        document.getElementById("chart-timeframe")?.addEventListener("change", () => {
          renderAdvancedChart(
            currentChartSymbol,
            document.getElementById("chart-timeframe").value,
            document.getElementById("chart-interval").value,
          );
        });
        document.getElementById("chart-interval")?.addEventListener("change", () => {
          renderAdvancedChart(
            currentChartSymbol,
            document.getElementById("chart-timeframe").value,
            document.getElementById("chart-interval").value,
          );
        });
        [
          "indicator-ma",
          "indicator-ema",
          "indicator-bb",
          "indicator-rsi",
          "indicator-macd",
          "indicator-vol-sma",
        ].forEach((id) => {
          document.getElementById(id)?.addEventListener("change", () => {
            renderAdvancedChart(
              currentChartSymbol,
              document.getElementById("chart-timeframe").value,
              document.getElementById("chart-interval").value,
            );
          });
        });
      }

      // Render both charts (async - fetches real data from API)
      async function renderAdvancedChart(symbol, timeframe, interval) {
        const candleCanvas = document.getElementById("candlestick-chart");
        const volumeCanvas = document.getElementById("volume-chart");
        if (!candleCanvas || !volumeCanvas) return;

        // Destroy previous instances
        if (priceChart) {
          priceChart.remove();
          priceChart = null;
        }
        if (volumeChart) {
          volumeChart.remove();
          volumeChart = null;
        }
        candleSeries = null;
        volumeSeries = null;
        indicatorSeries = [];
        indicatorValues = {};

        // Calculate date range from timeframe
        const end = new Date();
        const start = new Date();
        if (timeframe.endsWith("M")) {
          start.setMonth(start.getMonth() - parseInt(timeframe));
        } else if (timeframe.endsWith("Y")) {
          start.setFullYear(start.getFullYear() - parseInt(timeframe));
        } else {
          start.setDate(start.getDate() - (CONFIG.TIMEFRAME_DAYS[timeframe] || 30));
        }

        const formatDate = (d) => d.toISOString().split("T")[0];
        const startStr = formatDate(start);
        const endStr = formatDate(end);

        // Interval is passed directly to API (ONE_MINUTE, ONE_DAY)
        const apiInterval = interval;

        const skeletonHTML = `
                      <div class="h-full w-full flex flex-col gap-2 p-2 chart-skeleton">
                          <div class="flex-1 flex items-end gap-1">
                              ${Array(20)
                                .fill(0)
                                .map(
                                  () =>
                                    `<div class="flex-1 skeleton-shimmer rounded" style="height: ${
                                      30 + Math.random() * 60
                                    }%"></div>`,
                                )
                                .join("")}
                          </div>
                          <div class="h-2 skeleton-shimmer rounded w-full"></div>
                      </div>
                  `;

        // Stable container management: don't nuke parents, just toggle contents
        const candleParent = candleCanvas.parentElement;
        const volumeParent = volumeCanvas.parentElement;

        if (candleParent) {
          candleParent.querySelectorAll(".chart-skeleton").forEach((el) => el.remove());
          candleCanvas.classList.add("hidden");
          candleCanvas.insertAdjacentHTML("beforebegin", skeletonHTML);
        }
        if (volumeParent) {
          volumeParent.querySelectorAll(".chart-skeleton").forEach((el) => el.remove());
          volumeCanvas.classList.add("hidden");
          volumeCanvas.insertAdjacentHTML("beforebegin", skeletonHTML);
        }

        let data;
        try {
          const response = await fetch(`/chart/${symbol}?start=${startStr}&end=${endStr}&interval=${apiInterval}`);
          if (response.ok) {
            const result = await response.json();
            // Convert API data to chart format
            data = result.data.map((d) => ({
              x: new Date(d.time),
              o: d.open,
              h: d.high,
              l: d.low,
              c: d.close,
              v: d.volume,
            }));
          } else {
            throw new Error("API error");
          }
        } catch (err) {
          console.error("Chart API error:", err);
          // Show error message with links to external charts
          const candleParent = document.getElementById("candlestick-chart")?.parentElement;
          const volumeParent = document.getElementById("volume-chart")?.parentElement;
          const stockInfo = getStockInfo(symbol);
          const exchange = stockInfo?.exchange || "HOSE";
          const errorHTML = `
                  <div class="flex flex-col items-center justify-center h-full text-center p-6">
                    <i data-lucide="alert-circle" class="w-12 h-12 text-amber-500 mb-4"></i>
                    <p class="text-slate-600 dark:text-slate-400 mb-4">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu bi·ªÉu ƒë·ªì cho <strong>${symbol}</strong></p>
                    <p class="text-sm text-slate-500 dark:text-slate-500 mb-6">Vui l√≤ng s·ª≠ d·ª•ng c√°c n·ªÅn t·∫£ng b√™n d∆∞·ªõi ƒë·ªÉ xem bi·ªÉu ƒë·ªì:</p>
                    <div class="flex gap-3">
                      <a href="https://www.tradingview.com/chart/?symbol=${exchange}:${symbol}" target="_blank" rel="noreferrer noopener"
                         class="flex items-center gap-1.5 px-3 py-2 bg-gradient-to-r from-[#2962FF]/60 to-[#1E88E5]/60 dark:from-[#2962FF]/90 dark:to-[#1E88E5]/90 hover:from-[#2962FF] hover:to-[#1E88E5] backdrop-blur-xl backdrop-saturate-150 text-white text-xs font-bold rounded-xl transition-all shadow-lg shadow-blue-500/20 dark:shadow-blue-500/30 border border-white/30 dark:border-white/10 ring-1 ring-inset ring-white/10 hover:shadow-xl hover:scale-105">
                        <svg class="w-4 h-4" viewBox="0 0 36 28" fill="currentColor"><path d="M14 22H7V6h7v16zm8-16h-7v16h7V6zm8 16h-7V6h7v16z"/></svg>
                        TradingView
                      </a>
                      <a href="https://vn.investing.com/search?q=${symbol}" target="_blank" rel="noreferrer noopener"
                         class="flex items-center gap-1.5 px-3 py-2 bg-gradient-to-r from-[#EF6C35]/60 to-[#FF8A50]/60 dark:from-[#EF6C35]/90 dark:to-[#FF8A50]/90 hover:from-[#EF6C35] hover:to-[#FF8A50] backdrop-blur-xl backdrop-saturate-150 text-white text-xs font-bold rounded-xl transition-all shadow-lg shadow-orange-500/20 dark:shadow-orange-500/30 border border-white/30 dark:border-white/10 ring-1 ring-inset ring-white/10 hover:shadow-xl hover:scale-105">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3v18h18V3H3zm16 16H5V5h14v14zM7 7v10h2V7H7zm4 4v6h2v-6h-2zm4-2v8h2V9h-2z"/></svg>
                        Investing
                      </a>
                    </div>
                  </div>
                `;
          if (candleParent) candleParent.innerHTML = errorHTML;
          if (volumeParent) volumeParent.innerHTML = "";
          lucide.createIcons();
          return; // Exit early, don't try to render chart
        }

        // Show chart containers, remove skeletons
        const candleParentUpdate = document.getElementById("candlestick-chart")?.parentElement;
        const volumeParentUpdate = document.getElementById("volume-chart")?.parentElement;
        if (candleParentUpdate) {
          candleParentUpdate.querySelectorAll(".chart-skeleton").forEach((el) => el.remove());
          document.getElementById("candlestick-chart")?.classList.remove("hidden");
        }
        if (volumeParentUpdate) {
          volumeParentUpdate.querySelectorAll(".chart-skeleton").forEach((el) => el.remove());
          document.getElementById("volume-chart")?.classList.remove("hidden");
        }

        const isDark = document.documentElement.classList.contains("dark");

        // Full theme presets for Lightweight Charts
        const darkTheme = {
          layout: {
            background: { type: "solid", color: "#0f172a" },
            textColor: "#94a3b8",
          },
          grid: {
            vertLines: { color: "rgba(148, 163, 184, 0.1)" },
            horzLines: { color: "rgba(148, 163, 184, 0.1)" },
          },
          rightPriceScale: {
            borderColor: "rgba(148, 163, 184, 0.2)",
          },
          timeScale: {
            borderColor: "rgba(148, 163, 184, 0.2)",
          },
          crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
            vertLine: {
              color: "rgba(148, 163, 184, 0.5)",
              width: 1,
              style: LightweightCharts.LineStyle.Dashed,
              labelBackgroundColor: "#334155",
            },
            horzLine: {
              color: "rgba(148, 163, 184, 0.5)",
              width: 1,
              style: LightweightCharts.LineStyle.Dashed,
              labelBackgroundColor: "#334155",
            },
          },
        };

        const lightTheme = {
          layout: {
            background: { type: "solid", color: "#ffffff" },
            textColor: "#334155",
          },
          grid: {
            vertLines: { color: "rgba(100, 116, 139, 0.1)" },
            horzLines: { color: "rgba(100, 116, 139, 0.1)" },
          },
          rightPriceScale: {
            borderColor: "rgba(100, 116, 139, 0.2)",
          },
          timeScale: {
            borderColor: "rgba(100, 116, 139, 0.2)",
          },
          crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
            vertLine: {
              color: "rgba(100, 116, 139, 0.5)",
              width: 1,
              style: LightweightCharts.LineStyle.Dashed,
              labelBackgroundColor: "#f1f5f9",
            },
            horzLine: {
              color: "rgba(100, 116, 139, 0.5)",
              width: 1,
              style: LightweightCharts.LineStyle.Dashed,
              labelBackgroundColor: "#f1f5f9",
            },
          },
        };

        const theme = isDark ? darkTheme : lightTheme;

        // Get chart containers
        const priceContainer = document.getElementById("candlestick-chart");
        const volumeContainer = document.getElementById("volume-chart");
        if (!priceContainer || !volumeContainer) return;

        // Create Price Chart with theme
        priceChart = LightweightCharts.createChart(priceContainer, {
          autoSize: true,
          ...theme,
          timeScale: {
            ...theme.timeScale,
            timeVisible: apiInterval.includes("m") || apiInterval === "1H",
            secondsVisible: false,
          },
        });

        // Create Volume Chart with theme
        volumeChart = LightweightCharts.createChart(volumeContainer, {
          autoSize: true,
          ...theme,
          timeScale: {
            ...theme.timeScale,
            timeVisible: false,
          },
        });

        // Convert data to Lightweight Charts format (Unix timestamp in seconds)
        const chartData = data.map((d) => ({
          time: Math.floor(d.x.getTime() / 1000),
          open: d.o,
          high: d.h,
          low: d.l,
          close: d.c,
        }));

        const volumeData = data.map((d) => ({
          time: Math.floor(d.x.getTime() / 1000),
          value: d.v,
          color: d.c >= d.o ? "rgba(16, 185, 129, 0.6)" : "rgba(239, 68, 68, 0.6)",
        }));

        // Add Candlestick Series
        candleSeries = priceChart.addCandlestickSeries({
          upColor: CONFIG.COLORS.UP,
          downColor: CONFIG.COLORS.DOWN,
          borderUpColor: CONFIG.COLORS.UP,
          borderDownColor: CONFIG.COLORS.DOWN,
          wickUpColor: CONFIG.COLORS.UP,
          wickDownColor: CONFIG.COLORS.DOWN,
        });
        candleSeries.setData(chartData);

        // Add Volume Series (Histogram)
        volumeSeries = volumeChart.addHistogramSeries({
          priceFormat: { type: "volume" },
          priceScaleId: "right",
        });
        volumeSeries.setData(volumeData);

        // Add Indicators
        const showMA = document.getElementById("indicator-ma")?.checked;
        const showEMA = document.getElementById("indicator-ema")?.checked;
        const showBB = document.getElementById("indicator-bb")?.checked;
        const showRSI = document.getElementById("indicator-rsi")?.checked;
        const showMACD = document.getElementById("indicator-macd")?.checked;
        const showVolSMA = document.getElementById("indicator-vol-sma")?.checked;

        if (showMA) {
          const maData = calculateMA(data, 20)
            .map((v, i) => ({
              time: Math.floor(data[i].x.getTime() / 1000),
              value: v,
            }))
            .filter((d) => d.value !== null);
          const maSeries = priceChart.addLineSeries({
            color: "#3b82f6",
            lineWidth: 1,
            priceLineVisible: false,
            lastValueVisible: false,
          });
          maSeries.setData(maData);
          indicatorSeries.push(maSeries);
          // Store for tooltip
          maData.forEach((d) => {
            if (!indicatorValues[d.time]) indicatorValues[d.time] = {};
            indicatorValues[d.time].ma = d.value;
          });
        }

        if (showEMA) {
          const emaData = calculateEMA(data, 9)
            .map((v, i) => ({
              time: Math.floor(data[i].x.getTime() / 1000),
              value: v,
            }))
            .filter((d) => d.value !== null);
          const emaSeries = priceChart.addLineSeries({
            color: "#f97316",
            lineWidth: 1,
            priceLineVisible: false,
            lastValueVisible: false,
          });
          emaSeries.setData(emaData);
          indicatorSeries.push(emaSeries);
          // Store for tooltip
          emaData.forEach((d) => {
            if (!indicatorValues[d.time]) indicatorValues[d.time] = {};
            indicatorValues[d.time].ema = d.value;
          });
        }

        if (showBB) {
          const bb = calculateBB(data, 20, 2);
          const upperData = bb
            .map((v, i) => ({
              time: Math.floor(data[i].x.getTime() / 1000),
              value: v.upper,
            }))
            .filter((d) => d.value !== null);
          const lowerData = bb
            .map((v, i) => ({
              time: Math.floor(data[i].x.getTime() / 1000),
              value: v.lower,
            }))
            .filter((d) => d.value !== null);

          const upperSeries = priceChart.addLineSeries({
            color: "#a855f7",
            lineWidth: 1,
            lineStyle: LightweightCharts.LineStyle.Dashed,
            priceLineVisible: false,
            lastValueVisible: false,
          });
          upperSeries.setData(upperData);
          indicatorSeries.push(upperSeries);

          const lowerSeries = priceChart.addLineSeries({
            color: "#a855f7",
            lineWidth: 1,
            lineStyle: LightweightCharts.LineStyle.Dashed,
            priceLineVisible: false,
            lastValueVisible: false,
          });
          lowerSeries.setData(lowerData);
          indicatorSeries.push(lowerSeries);
          // Store for tooltip
          bb.forEach((v, i) => {
            if (v.upper !== null) {
              const time = Math.floor(data[i].x.getTime() / 1000);
              if (!indicatorValues[time]) indicatorValues[time] = {};
              indicatorValues[time].bbUpper = v.upper;
              indicatorValues[time].bbMiddle = v.middle;
              indicatorValues[time].bbLower = v.lower;
            }
          });
        }

        if (showRSI) {
          const rsi = calculateRSI(data, 14);
          const prices = data.map((d) => d.c);
          const minPrice = Math.min(...prices);
          const maxPrice = Math.max(...prices);
          const rsiData = rsi
            .map((v, i) => ({
              time: Math.floor(data[i].x.getTime() / 1000),
              value: v === null ? null : minPrice + (v / 100) * (maxPrice - minPrice),
            }))
            .filter((d) => d.value !== null);
          const rsiSeries = priceChart.addLineSeries({
            color: CONFIG.COLORS.RSI,
            lineWidth: 1,
            lineStyle: LightweightCharts.LineStyle.Dotted,
            priceLineVisible: false,
            lastValueVisible: false,
          });
          rsiSeries.setData(rsiData);
          indicatorSeries.push(rsiSeries);
          // Store raw RSI values for tooltip
          rsi.forEach((v, i) => {
            if (v !== null) {
              const time = Math.floor(data[i].x.getTime() / 1000);
              if (!indicatorValues[time]) indicatorValues[time] = {};
              indicatorValues[time].rsi = v;
            }
          });
        }

        if (showMACD) {
          const macd = calculateMACD(data, 12, 26, 9);
          const prices = data.map((d) => d.c);
          const minPrice = Math.min(...prices);
          const maxPrice = Math.max(...prices);
          const priceRange = maxPrice - minPrice;
          const macdValues = macd.macdLine.filter((v) => v !== null);
          const macdMax = Math.max(...macdValues.map(Math.abs)) || 1;
          const scaleMACD = (v) => (v === null ? null : (maxPrice + minPrice) / 2 + (v / macdMax) * (priceRange / 4));

          const macdData = macd.macdLine
            .map((v, i) => ({
              time: Math.floor(data[i].x.getTime() / 1000),
              value: scaleMACD(v),
            }))
            .filter((d) => d.value !== null);
          const signalData = macd.signalLine
            .map((v, i) => ({
              time: Math.floor(data[i].x.getTime() / 1000),
              value: scaleMACD(v),
            }))
            .filter((d) => d.value !== null);

          const macdSeries = priceChart.addLineSeries({
            color: CONFIG.COLORS.MACD_LINE,
            lineWidth: 1,
            priceLineVisible: false,
            lastValueVisible: false,
          });
          macdSeries.setData(macdData);
          indicatorSeries.push(macdSeries);

          const signalSeries = priceChart.addLineSeries({
            color: CONFIG.COLORS.MACD_SIGNAL,
            lineWidth: 1,
            lineStyle: LightweightCharts.LineStyle.Dashed,
            priceLineVisible: false,
            lastValueVisible: false,
          });
          signalSeries.setData(signalData);
          indicatorSeries.push(signalSeries);
          // Store raw MACD values for tooltip
          macd.macdLine.forEach((v, i) => {
            if (v !== null || macd.signalLine[i] !== null || macd.histogram[i] !== null) {
              const time = Math.floor(data[i].x.getTime() / 1000);
              if (!indicatorValues[time]) indicatorValues[time] = {};
              indicatorValues[time].macdLine = v;
              indicatorValues[time].macdSignal = macd.signalLine[i];
              indicatorValues[time].macdHist = macd.histogram[i];
            }
          });
        }

        if (showVolSMA) {
          const volSmaData = calculateVolumeSMA(data, 20)
            .map((v, i) => ({
              time: Math.floor(data[i].x.getTime() / 1000),
              value: v,
            }))
            .filter((d) => d.value !== null);
          const volSmaSeries = volumeChart.addLineSeries({
            color: CONFIG.COLORS.VOLUME_SMA,
            lineWidth: 1,
            priceLineVisible: false,
            lastValueVisible: false,
          });
          volSmaSeries.setData(volSmaData);
          indicatorSeries.push(volSmaSeries);
          // Store for tooltip
          volSmaData.forEach((d) => {
            if (!indicatorValues[d.time]) indicatorValues[d.time] = {};
            indicatorValues[d.time].volSma = d.value;
          });
        }

        // Synchronize time scales between price and volume charts
        priceChart.timeScale().subscribeVisibleLogicalRangeChange((range) => {
          if (range !== null) {
            volumeChart.timeScale().setVisibleLogicalRange(range);
          }
        });
        volumeChart.timeScale().subscribeVisibleLogicalRangeChange((range) => {
          if (range !== null) {
            priceChart.timeScale().setVisibleLogicalRange(range);
          }
        });

        // Create tooltip elements for both charts (follows crosshair)
        const createTooltip = (container) => {
          const tooltip = document.createElement("div");
          tooltip.style.cssText = `
                position: absolute;
                z-index: 100;
                font-size: 12px;
                font-family: sans-serif;
                line-height: 1.5;
                padding: 10px 14px;
                border-radius: 8px;
                pointer-events: none;
                display: none;
                white-space: nowrap;
                ${
                  isDark
                    ? "background: rgba(30, 41, 59, 0.95); color: #e2e8f0; border: 1px solid rgba(148, 163, 184, 0.2);"
                    : "background: rgba(255, 255, 255, 0.95); color: #1e293b; border: 1px solid rgba(100, 116, 139, 0.2);"
                }
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
              `;
          container.style.position = "relative";
          container.appendChild(tooltip);
          return tooltip;
        };

        const priceTooltip = createTooltip(priceContainer);
        const volumeTooltip = createTooltip(volumeContainer);

        // Helper function to format full datetime
        const formatFullDateTime = (timestamp) => {
          const date = new Date(timestamp * 1000);
          return date.toLocaleString("vi-VN", {
            weekday: "long",
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });
        };

        // Helper function to format price with thousands separator
        const formatPrice = (price) => {
          return price.toLocaleString("vi-VN", {
            minimumFractionDigits: 0,
            maximumFractionDigits: 2,
          });
        };

        // Helper function to format volume with thousands separator
        const formatVolume = (vol) => {
          return vol.toLocaleString("vi-VN");
        };

        // Helper for indicator values in tooltip
        const renderTooltipIndicators = (time, isVolumeChart = false) => {
          const values = indicatorValues[time];
          if (!values) return "";
          let html = '<div style="margin-top: 6px; border-top: 1px solid rgba(148, 163, 184, 0.2); padding-top: 4px;">';
          let count = 0;

          if (!isVolumeChart) {
            if (values.ma !== undefined) {
              html += `<div><span style="color: #3b82f6; opacity: 0.8;">MA(20):</span> <strong>${formatPrice(
                values.ma,
              )}</strong></div>`;
              count++;
            }
            if (values.ema !== undefined) {
              html += `<div><span style="color: #f97316; opacity: 0.8;">EMA(9):</span> <strong>${formatPrice(
                values.ema,
              )}</strong></div>`;
              count++;
            }
            if (values.bbUpper !== undefined) {
              html += `<div><span style="color: #a855f7; opacity: 0.8;">BB Upper:</span> <strong>${formatPrice(
                values.bbUpper,
              )}</strong></div>`;
              html += `<div><span style="color: #a855f7; opacity: 0.8;">BB Lower:</span> <strong>${formatPrice(
                values.bbLower,
              )}</strong></div>`;
              count++;
            }
            if (values.rsi !== undefined) {
              html += `<div><span style="color: ${
                CONFIG.COLORS.RSI
              }; opacity: 0.8;">RSI(14):</span> <strong>${values.rsi.toFixed(2)}</strong></div>`;
              count++;
            }
            if (values.macdLine !== undefined) {
              html += `<div><span style="color: ${
                CONFIG.COLORS.MACD_LINE
              }; opacity: 0.8;">MACD:</span> <strong>${values.macdLine.toFixed(2)}</strong></div>`;
              html += `<div><span style="color: ${
                CONFIG.COLORS.MACD_SIGNAL
              }; opacity: 0.8;">Signal:</span> <strong>${values.macdSignal.toFixed(2)}</strong></div>`;
              count++;
            }
          } else {
            if (values.volSma !== undefined) {
              html += `<div><span style="color: ${
                CONFIG.COLORS.VOLUME_SMA
              }; opacity: 0.8;">Vol SMA(20):</span> <strong>${formatVolume(values.volSma)}</strong></div>`;
              count++;
            }
          }

          html += "</div>";
          return count > 0 ? html : "";
        };

        // Update tooltip position to follow crosshair
        const updateTooltipPosition = (tooltip, container, param) => {
          if (!param.point) return;

          const containerRect = container.getBoundingClientRect();
          const tooltipWidth = tooltip.offsetWidth || 200;
          const tooltipHeight = tooltip.offsetHeight || 100;

          let left = param.point.x + 15;
          let top = param.point.y + 15;

          // Keep tooltip within container bounds
          if (left + tooltipWidth > containerRect.width) {
            left = param.point.x - tooltipWidth - 15;
          }
          if (top + tooltipHeight > containerRect.height) {
            top = param.point.y - tooltipHeight - 15;
          }
          if (left < 0) left = 10;
          if (top < 0) top = 10;

          tooltip.style.left = left + "px";
          tooltip.style.top = top + "px";
        };

        // Crosshair sync with moving tooltips
        priceChart.subscribeCrosshairMove((param) => {
          if (param.time && param.point) {
            // Sync crosshair with volume chart
            volumeChart.setCrosshairPosition(volumeSeries.dataByIndex(param.logical), param.time, volumeSeries);

            // Update price tooltip with OHLC
            const candlePrice = param.seriesData.get(candleSeries);
            if (candlePrice) {
              const changePercent = (((candlePrice.close - candlePrice.open) / candlePrice.open) * 100).toFixed(2);
              const changeColor = candlePrice.close >= candlePrice.open ? "#10b981" : "#ef4444";
              const changeSign = candlePrice.close >= candlePrice.open ? "+" : "";
              priceTooltip.innerHTML = `
                    <div style="margin-bottom: 6px; font-weight: 500; opacity: 0.8;">${formatFullDateTime(
                      param.time,
                    )}</div>
                    <div><span style="opacity: 0.6;">Open:</span> <strong>${formatPrice(
                      candlePrice.open,
                    )}</strong></div>
                    <div><span style="opacity: 0.6;">High:</span> <strong>${formatPrice(
                      candlePrice.high,
                    )}</strong></div>
                    <div><span style="opacity: 0.6;">Low:</span> <strong>${formatPrice(candlePrice.low)}</strong></div>
                    <div><span style="opacity: 0.6;">Close:</span> <strong>${formatPrice(
                      candlePrice.close,
                    )}</strong> <span style="color: ${changeColor};">(${changeSign}${changePercent}%)</span></div>
                    ${renderTooltipIndicators(param.time)}
                  `;
              priceTooltip.style.display = "block";
              updateTooltipPosition(priceTooltip, priceContainer, param);
            }

            // Update volume tooltip
            const volData = param.seriesData.get(volumeSeries);
            if (volData) {
              volumeTooltip.innerHTML = `
                    <div style="margin-bottom: 6px; font-weight: 500; opacity: 0.8;">${formatFullDateTime(
                      param.time,
                    )}</div>
                    <div><span style="opacity: 0.6;">Volume:</span> <strong>${formatVolume(
                      volData.value,
                    )}</strong></div>
                    ${renderTooltipIndicators(param.time, true)}
                  `;
              volumeTooltip.style.display = "block";
              updateTooltipPosition(volumeTooltip, volumeContainer, param);
            }
          } else {
            priceTooltip.style.display = "none";
            volumeTooltip.style.display = "none";
          }
        });

        volumeChart.subscribeCrosshairMove((param) => {
          if (param.time && param.point) {
            // Sync crosshair with price chart
            priceChart.setCrosshairPosition(candleSeries.dataByIndex(param.logical), param.time, candleSeries);

            // Update volume tooltip
            const volData = param.seriesData.get(volumeSeries);
            if (volData) {
              volumeTooltip.innerHTML = `
                    <div style="margin-bottom: 6px; font-weight: 500; opacity: 0.8;">${formatFullDateTime(
                      param.time,
                    )}</div>
                    <div><span style="opacity: 0.6;">Volume:</span> <strong>${formatVolume(
                      volData.value,
                    )}</strong></div>
                    ${renderTooltipIndicators(param.time, true)}
                  `;
              volumeTooltip.style.display = "block";
              updateTooltipPosition(volumeTooltip, volumeContainer, param);
            }

            // Update price tooltip from synced data
            const candlePrice = candleSeries.dataByIndex(param.logical);
            if (candlePrice) {
              const changePercent = (((candlePrice.close - candlePrice.open) / candlePrice.open) * 100).toFixed(2);
              const changeColor = candlePrice.close >= candlePrice.open ? "#10b981" : "#ef4444";
              const changeSign = candlePrice.close >= candlePrice.open ? "+" : "";
              priceTooltip.innerHTML = `
                    <div style="margin-bottom: 6px; font-weight: 500; opacity: 0.8;">${formatFullDateTime(
                      param.time,
                    )}</div>
                    <div><span style="opacity: 0.6;">Open:</span> <strong>${formatPrice(
                      candlePrice.open,
                    )}</strong></div>
                    <div><span style="opacity: 0.6;">High:</span> <strong>${formatPrice(
                      candlePrice.high,
                    )}</strong></div>
                    <div><span style="opacity: 0.6;">Low:</span> <strong>${formatPrice(candlePrice.low)}</strong></div>
                    <div><span style="opacity: 0.6;">Close:</span> <strong>${formatPrice(
                      candlePrice.close,
                    )}</strong> <span style="color: ${changeColor};">(${changeSign}${changePercent}%)</span></div>
                    ${renderTooltipIndicators(param.time)}
                  `;
              priceTooltip.style.display = "block";
            }
          } else {
            priceTooltip.style.display = "none";
            volumeTooltip.style.display = "none";
          }
        });

        setTimeout(() => {
          window.dispatchEvent(new Event("resize"));
          if (typeof priceChart !== "undefined" && priceChart) priceChart.timeScale().fitContent();
          if (typeof volumeChart !== "undefined" && volumeChart) volumeChart.timeScale().fitContent();
        }, 50);
      }

      // Render Analysis Chart (separate chart for Analysis tab)
      async function renderAnalysisChart(symbol, analysisTimeframe) {
        const chartContainer = document.getElementById("analysis-candlestick-chart");
        if (!chartContainer) return;

        // Destroy previous instance
        if (analysisChart) {
          analysisChart.remove();
          analysisChart = null;
        }
        analysisCandleSeries = null;
        currentAnalysisTimeframe = analysisTimeframe;

        // Set timeframe and interval based on analysis type
        const timeframe = analysisTimeframe === "short_term" ? "1Y" : "5Y";
        const interval = analysisTimeframe === "short_term" ? "1D" : "1W";

        // Calculate date range
        const end = new Date();
        const start = new Date();
        if (timeframe === "1Y") {
          start.setFullYear(start.getFullYear() - 1);
        } else {
          start.setFullYear(start.getFullYear() - 5);
        }

        const formatDate = (d) => d.toISOString().split("T")[0];
        const startStr = formatDate(start);
        const endStr = formatDate(end);

        // Show skeleton
        const skeletonHTML = `
          <div class="h-full w-full flex flex-col gap-2 p-2 chart-skeleton">
            <div class="flex-1 flex items-end gap-1">
              ${Array(20)
                .fill(0)
                .map(
                  () =>
                    `<div class="flex-1 skeleton-shimmer rounded" style="height: ${30 + Math.random() * 60}%"></div>`,
                )
                .join("")}
            </div>
            <div class="h-2 skeleton-shimmer rounded w-full"></div>
          </div>
        `;

        const parent = chartContainer.parentElement;
        if (parent) {
          parent.querySelectorAll(".chart-skeleton").forEach((el) => el.remove());
          chartContainer.classList.add("hidden");
          chartContainer.insertAdjacentHTML("beforebegin", skeletonHTML);
        }

        let data;
        try {
          const response = await fetch(`/chart/${symbol}?start=${startStr}&end=${endStr}&interval=${interval}`);
          if (response.ok) {
            const result = await response.json();
            data = result.data.map((d) => ({
              x: new Date(d.time),
              o: d.open,
              h: d.high,
              l: d.low,
              c: d.close,
            }));
          } else {
            throw new Error("API error");
          }
        } catch (err) {
          console.error("Analysis chart API error:", err);
          if (parent) {
            parent.innerHTML = `
              <div class="flex items-center justify-center h-full text-center p-4">
                <p class="text-sm text-slate-500 dark:text-slate-400">Kh√¥ng th·ªÉ t·∫£i bi·ªÉu ƒë·ªì</p>
              </div>
            `;
          }
          return;
        }

        // Remove skeleton and show chart
        const parentUpdate = document.getElementById("analysis-candlestick-chart")?.parentElement;
        if (parentUpdate) {
          parentUpdate.querySelectorAll(".chart-skeleton").forEach((el) => el.remove());
          document.getElementById("analysis-candlestick-chart")?.classList.remove("hidden");
        }

        const isDark = document.documentElement.classList.contains("dark");
        const theme = isDark
          ? {
              layout: { background: { type: "solid", color: "#0f172a" }, textColor: "#94a3b8" },
              grid: {
                vertLines: { color: "rgba(148, 163, 184, 0.1)" },
                horzLines: { color: "rgba(148, 163, 184, 0.1)" },
              },
              rightPriceScale: { borderColor: "rgba(148, 163, 184, 0.2)" },
              timeScale: { borderColor: "rgba(148, 163, 184, 0.2)" },
            }
          : {
              layout: { background: { type: "solid", color: "#ffffff" }, textColor: "#334155" },
              grid: {
                vertLines: { color: "rgba(100, 116, 139, 0.1)" },
                horzLines: { color: "rgba(100, 116, 139, 0.1)" },
              },
              rightPriceScale: { borderColor: "rgba(100, 116, 139, 0.2)" },
              timeScale: { borderColor: "rgba(100, 116, 139, 0.2)" },
            };

        const container = document.getElementById("analysis-candlestick-chart");
        if (!container) return;

        analysisChart = LightweightCharts.createChart(container, {
          autoSize: true,
          ...theme,
          timeScale: { ...theme.timeScale, timeVisible: false },
        });

        const chartData = data.map((d) => ({
          time: Math.floor(d.x.getTime() / 1000),
          open: d.o,
          high: d.h,
          low: d.l,
          close: d.c,
        }));

        analysisCandleSeries = analysisChart.addCandlestickSeries({
          upColor: CONFIG.COLORS.UP,
          downColor: CONFIG.COLORS.DOWN,
          borderUpColor: CONFIG.COLORS.UP,
          borderDownColor: CONFIG.COLORS.DOWN,
          wickUpColor: CONFIG.COLORS.UP,
          wickDownColor: CONFIG.COLORS.DOWN,
        });
        analysisCandleSeries.setData(chartData);

        setTimeout(() => {
          window.dispatchEvent(new Event("resize"));
          if (analysisChart) analysisChart.timeScale().fitContent();
        }, 50);
      }

      function selectStock(symbol) {
        // Update selected state
        selectedStock = symbol;
        const stockInfo = getStockInfo(symbol);
        const companyName = stockInfo.name;
        selectedStockCompanyName = companyName;
        lastFetchedNewsSymbol = null;
        lastFetchedTechnicalSymbol = null;

        const exchange = stockInfo.exchange;

        // Remove selected class from all tickers
        document.querySelectorAll(".stock-ticker.selected").forEach((el) => {
          el.classList.remove("selected");
        });

        // Add selected class to all instances of the clicked ticker
        document.querySelectorAll(`.stock-ticker[data-symbol="${symbol}"]`).forEach((el) => {
          el.classList.add("selected");
        });

        // Show and update Stock Header
        const stockHeader = document.getElementById("stock-header");
        stockHeader.classList.remove("hidden");
        document.getElementById("stock-header-symbol").textContent = symbol;
        document.getElementById("stock-header-name").textContent = companyName;
        // Update header links with correct exchange
        document.getElementById("link-tradingview").href =
          `https://www.tradingview.com/chart/?symbol=${exchange}:${symbol}`;
        // Use Investing.com equities search for Vietnamese stocks
        document.getElementById("link-investing").href = `https://vn.investing.com/search?q=${symbol}`;
        lucide.createIcons({ root: stockHeader });

        // Initialize chart with controls
        document.getElementById("chart-tab-content-empty").classList.add("hidden");
        document.getElementById("chart-tab-content-container").classList.remove("hidden");
        initAdvancedChart(symbol);

        // Trigger news analysis if currently on news tab
        if (currentTabId === "news") {
          fetchNewsAnalysis(symbol, companyName);
          lastFetchedNewsSymbol = symbol;
        }

        // Trigger technical analysis if currently on analysis tab
        if (currentTabId === "analysis") {
          fetchTechnicalAnalysis(symbol, companyName);
          lastFetchedTechnicalSymbol = symbol;
        }
      }

      async function fetchNewsAnalysis(symbol, companyName) {
        document.getElementById("news-tab-content-empty").classList.add("hidden");
        document.getElementById("news-tab-content-container").classList.remove("hidden");

        const analysisContentEl = document.getElementById("news-analysis-content");
        const newsListContainer = document.getElementById("news-list-container");
        const newsCountBadge = document.getElementById("news-count-badge");

        let accumulatedText = "";

        try {
          const response = await fetch("/news-analysis", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ symbol: symbol, company_name: companyName }),
          });

          if (!response.ok) throw new Error("API Connection Error: " + response.status);

          const reader = response.body.getReader();
          const decoder = new TextDecoder("utf-8");
          let buffer = "";
          let isFirstChunk = true;

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split("\n");
            buffer = lines.pop();

            for (const line of lines) {
              if (!line.trim()) continue;
              try {
                const evt = JSON.parse(line);
                if (evt.type === "content") {
                  if (isFirstChunk) {
                    if (analysisContentEl) analysisContentEl.innerHTML = "";
                    isFirstChunk = false;
                  }

                  // Update Text
                  accumulatedText += evt.chunk;
                  if (analysisContentEl) {
                    analysisContentEl.innerHTML = processContentNoTickers(accumulatedText);
                  }
                } else if (evt.type === "data") {
                  // Render News List
                  const newsList = evt.news || [];
                  if (newsCountBadge) {
                    newsCountBadge.textContent = newsList.length;
                    newsCountBadge.classList.remove("hidden");
                  }

                  if (newsListContainer) {
                    if (newsList.length === 0) {
                      newsListContainer.innerHTML = `<div class="text-sm text-slate-500 italic p-4">Kh√¥ng t√¨m th·∫•y ngu·ªìn tin chi ti·∫øt.</div>`;
                    } else {
                      newsListContainer.innerHTML = newsList
                        .map((n) => {
                          const isEvent = n.type && n.type !== "Tin t·ª©c" && n.type !== "B√°o c√°o ph√¢n t√≠ch";
                          const isAnalysis = n.type === "B√°o c√°o ph√¢n t√≠ch";
                          const icon = isEvent ? "calendar" : isAnalysis ? "file-text" : "newspaper";
                          const iconColor = isEvent
                            ? "text-amber-500"
                            : isAnalysis
                              ? "text-indigo-500"
                              : "text-primary-500";
                          const typeBadgeClass = isEvent
                            ? "bg-amber-100 text-amber-700 dark:bg-amber-500/10 dark:text-amber-400"
                            : isAnalysis
                              ? "bg-indigo-100 text-indigo-700 dark:bg-indigo-500/10 dark:text-indigo-400"
                              : "bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-300";

                          return `
                            <a href="${
                              n.link
                            }" target="_blank" class="flex gap-4 p-4 bg-white/40 dark:bg-slate-800/40 hover:bg-white/60 dark:hover:bg-slate-800/60 border border-slate-200 dark:border-white/5 rounded-2xl transition-all group shadow-sm hover:shadow-md">
                                <div class="flex-shrink-0 w-12 h-12 rounded-xl bg-white dark:bg-slate-900 border border-slate-100 dark:border-white/5 flex items-center justify-center ${iconColor} shadow-inner">
                                    <i data-lucide="${icon}" class="w-6 h-6"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h5 class="text-sm font-bold text-slate-800 dark:text-slate-200 mb-1 group-hover:text-primary-600 dark:group-hover:text-primary-400 line-clamp-2 leading-snug">${
                                      n.title
                                    }</h5>
                                    ${
                                      n.description
                                        ? `<p class="text-xs text-slate-500 dark:text-slate-400 line-clamp-1 mb-2 font-medium opacity-80">${n.description}</p>`
                                        : ""
                                    }
                                    <div class="flex items-center flex-wrap gap-2 text-[10px]">
                                        <span class="px-2 py-0.5 rounded font-bold uppercase tracking-wider ${typeBadgeClass}">${
                                          n.type || "Tin t·ª©c"
                                        }</span>
                                        <span class="text-slate-400 dark:text-slate-500">‚Ä¢</span>
                                        <span class="font-medium text-slate-500 dark:text-slate-400 italic">${
                                          n.date
                                        }</span>
                                        ${
                                          n.source
                                            ? `<span class="text-slate-400 dark:text-slate-500">‚Ä¢</span><span class="text-slate-500 dark:text-slate-400">${n.source}</span>`
                                            : ""
                                        }
                                    </div>
                                </div>
                                <div class="flex-shrink-0 self-center opacity-0 group-hover:opacity-100 transition-opacity">
                                    <i data-lucide="external-link" class="w-4 h-4 text-slate-400"></i>
                                </div>
                            </a>
                          `;
                        })
                        .join("");
                      lucide.createIcons({ root: newsListContainer });
                    }
                  }
                } else if (evt.type === "sentiment") {
                  const badge = document.getElementById("news-sentiment-badge");
                  if (badge) {
                    badge.textContent = evt.label;
                    // Reset and apply 3D effect classes
                    badge.className =
                      "inline-flex items-center text-sm font-bold px-4 py-1.5 rounded-full border border-slate-200 transition-all animate-fade-in backdrop-blur-md shadow-[0_4px_12px_rgba(0,0,0,0.1)] ring-1 ring-white/40 dark:ring-white/10";

                    const color = evt.color || "gray";
                    if (color === "green") {
                      badge.classList.add(
                        "bg-gradient-to-b",
                        "from-emerald-50",
                        "to-emerald-100/90",
                        "dark:from-emerald-500/10",
                        "dark:to-emerald-500/30",
                        "text-emerald-700",
                        "dark:text-emerald-300",
                        "border-emerald-200",
                        "dark:border-emerald-500/40",
                      );
                    } else if (color === "red") {
                      badge.classList.add(
                        "bg-gradient-to-b",
                        "from-rose-50",
                        "to-rose-100/90",
                        "dark:from-rose-500/10",
                        "dark:to-rose-500/30",
                        "text-rose-700",
                        "dark:text-rose-300",
                        "border-rose-200",
                        "dark:border-rose-500/40",
                      );
                    } else if (color === "yellow") {
                      badge.classList.add(
                        "bg-gradient-to-b",
                        "from-amber-50",
                        "to-amber-100/90",
                        "dark:from-amber-500/10",
                        "dark:to-amber-500/30",
                        "text-amber-800",
                        "dark:text-amber-300",
                        "border-amber-200",
                        "dark:border-amber-500/40",
                      );
                    } else if (color === "orange") {
                      badge.classList.add(
                        "bg-gradient-to-b",
                        "from-orange-50",
                        "to-orange-100/90",
                        "dark:from-orange-500/10",
                        "dark:to-orange-500/30",
                        "text-orange-700",
                        "dark:text-orange-300",
                        "border-orange-200",
                        "dark:border-orange-500/40",
                      );
                    } else if (color === "blue") {
                      badge.classList.add(
                        "bg-gradient-to-b",
                        "from-blue-50",
                        "to-blue-100/90",
                        "dark:from-blue-500/10",
                        "dark:to-blue-500/30",
                        "text-blue-700",
                        "dark:text-blue-300",
                        "border-blue-200",
                        "dark:border-blue-500/40",
                      );
                    } else {
                      badge.classList.add(
                        "bg-gradient-to-b",
                        "from-slate-50",
                        "to-slate-100/90",
                        "dark:from-slate-800/40",
                        "dark:to-slate-800/80",
                        "text-slate-700",
                        "dark:text-slate-300",
                        "border-slate-200",
                        "dark:border-slate-600",
                      );
                    }
                  }
                } else if (evt.type === "error") {
                  console.error("Stream Error:", evt.message);
                  if (analysisContentEl)
                    analysisContentEl.innerHTML += `<div class="text-red-500 text-xs mt-2">‚ö†Ô∏è ${evt.message}</div>`;
                  isFirstChunk = false;
                }
              } catch (parseErr) {
                console.error("JSON Parse Error:", parseErr);
              }
            }
          }

          // End of stream check
          if (isFirstChunk && !accumulatedText) {
            if (analysisContentEl)
              analysisContentEl.innerHTML = `<div class="text-slate-500 italic text-sm">Kh√¥ng c√≥ d·ªØ li·ªáu ph√¢n t√≠ch.</div>`;
          }
        } catch (error) {
          console.error(error);
          if (analysisContentEl)
            analysisContentEl.innerHTML = `<div class="text-red-500 p-4">L·ªói: ${error.message}</div>`;
          if (newsListContainer) newsListContainer.innerHTML = "";
        }
      }

      // --- Technical Analysis Function ---
      let sparklineCharts = {};

      function drawSparkline(containerId, data, color) {
        const container = document.getElementById(containerId);
        if (!container) return;

        // Clear skeleton loading state
        removeSkeleton(containerId);

        if (!data || data.length === 0) return;

        // Clear existing chart if any to avoid leaks/visual bugs
        if (sparklineCharts[containerId]) {
          try {
            sparklineCharts[containerId].remove();
            delete sparklineCharts[containerId];
          } catch (e) {
            console.error("Error removing chart:", e);
          }
        }

        const isDark = document.documentElement.classList.contains("dark");
        const chart = LightweightCharts.createChart(container, {
          layout: {
            background: { type: "solid", color: "transparent" },
            textColor: isDark ? "#94a3b8" : "#64748b",
            fontSize: 10,
          },
          grid: {
            vertLines: { visible: false },
            horzLines: { visible: false },
          },
          timeScale: {
            visible: false,
            borderVisible: false,
          },
          rightPriceScale: {
            visible: false,
            borderVisible: false,
          },
          handleScroll: false,
          handleScale: false,
          crosshair: {
            vertLine: {
              color: isDark ? "rgba(255, 255, 255, 0.3)" : "rgba(0, 0, 0, 0.2)",
              width: 1,
              style: 2,
            },
            horzLine: { visible: false },
          },
        });

        const series = chart.addAreaSeries({
          lineColor: color,
          topColor: color.replace(/, 1\)$/, ", 0.2)"),
          bottomColor: color.replace(/, 1\)$/, ", 0)"),
          lineWidth: 2,
          priceLineVisible: false,
          lastValueVisible: false,
          crosshairMarkerVisible: true,
          autoscaleInfoProvider: () => {
            const values = data.map((d) => (typeof d === "object" ? d.value : d));
            const min = Math.min(...values);
            const max = Math.max(...values);
            const margin = (max - min) * 0.1;
            return {
              priceRange: {
                minValue: min - margin,
                maxValue: max + margin,
              },
            };
          },
        });

        // Prepare data (handle both simple values and objects with time)
        const chartData = data.map((d, i) => {
          if (typeof d === "object" && d.time) return d;
          return { time: i, value: d };
        });

        series.setData(chartData);
        chart.timeScale().fitContent();

        // Add Simple Tooltip
        const tooltip = document.createElement("div");
        tooltip.className = "sparkline-tooltip";
        Object.assign(tooltip.style, {
          position: "absolute",
          display: "none",
          padding: "4px 8px",
          background: isDark ? "rgba(15, 23, 42, 0.95)" : "rgba(255, 255, 255, 0.95)",
          color: isDark ? "#f1f5f9" : "#1e293b",
          fontSize: "11px",
          fontWeight: "bold",
          borderRadius: "6px",
          zIndex: "100",
          pointerEvents: "none",
          backdropFilter: "blur(8px)",
          border: isDark ? "1px solid rgba(255,255,255,0.1)" : "1px solid rgba(0,0,0,0.1)",
          boxShadow: "0 4px 12px rgba(0,0,0,0.3)",
          whiteSpace: "nowrap",
          lineHeight: "1.2",
          textAlign: "center",
        });
        container.appendChild(tooltip);

        chart.subscribeCrosshairMove((param) => {
          if (
            param.point === undefined ||
            !param.time ||
            param.point.x < 0 ||
            param.point.x > container.clientWidth ||
            param.point.y < 0 ||
            param.point.y > container.clientHeight
          ) {
            tooltip.style.display = "none";
          } else {
            const seriesData = param.seriesData.get(series);
            const value = seriesData ? seriesData.value : undefined;
            if (value !== undefined) {
              tooltip.style.display = "block";

              // Format Date
              let dateStr = "";
              if (typeof param.time === "string") {
                const parts = param.time.split("-");
                if (parts.length === 3) {
                  dateStr = `${parts[2]}/${parts[1]}`;
                } else {
                  dateStr = param.time;
                }
              } else {
                dateStr = "Ng√†y " + param.time;
              }

              tooltip.innerHTML = `
                <div style="font-size: 9px; opacity: 0.6; font-weight: medium; margin-bottom: 2px;">${dateStr}</div>
                <div>${value.toFixed(2)}</div>
              `;

              const tooltipWidth = 50;
              let x = param.point.x + 10;
              let y = param.point.y - 35;

              if (x > container.clientWidth - tooltipWidth) {
                x = param.point.x - tooltipWidth - 10;
              }
              if (y < 0) {
                y = param.point.y + 15;
              }

              tooltip.style.left = x + "px";
              tooltip.style.top = y + "px";
            } else {
              tooltip.style.display = "none";
            }
          }
        });

        sparklineCharts[containerId] = chart;
      }

      async function fetchTechnicalAnalysis(symbol, companyName) {
        document.getElementById("analysis-tab-content-empty").classList.add("hidden");
        document.getElementById("analysis-tab-content-container").classList.remove("hidden");
        document.getElementById("analysis-content-timeframe").classList.remove("hidden");
        document.getElementById("analysis-chart-collapsible").classList.remove("hidden");

        // Initialize analysis chart with default short_term timeframe
        renderAnalysisChart(symbol, "short_term");

        const analysisContentEl = document.getElementById("tech-analysis-content");
        const badge = document.getElementById("tech-recommendation-badge");

        // Setup Tab Listeners
        const shortTab = document.getElementById("tech-tab-short");
        const longTab = document.getElementById("tech-tab-long");

        if (shortTab && longTab) {
          const switchTab = (timeframe) => {
            shortTab.className =
              "tech-timeframe-tab px-4 py-2 rounded-full text-sm font-bold transition-all text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700";
            longTab.className =
              "tech-timeframe-tab px-4 py-2 rounded-full text-sm font-bold transition-all text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700";

            const activeBtn = timeframe === "short_term" ? shortTab : longTab;
            activeBtn.className =
              "tech-timeframe-tab px-4 py-2 rounded-full text-sm font-bold transition-all bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-lg shadow-indigo-500/25";

            if (window.techAnalysisData) {
              const data = window.techAnalysisData[timeframe];
              if (data) {
                updateIndicatorsDisplay(data.indicators, data.methods);
              }
            }
          };

          shortTab.onclick = () => switchTab("short_term");
          longTab.onclick = () => switchTab("long_term");
        }

        let accumulatedText = "";

        try {
          const response = await fetch("/technical-analysis", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ symbol: symbol, company_name: companyName }),
          });

          if (!response.ok) throw new Error("API Connection Error: " + response.status);

          const reader = response.body.getReader();
          const decoder = new TextDecoder("utf-8");
          let buffer = "";
          let isFirstChunk = false;

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split("\n");
            buffer = lines.pop();

            for (const line of lines) {
              if (!line.trim()) continue;
              try {
                const evt = JSON.parse(line);
                if (evt.type === "content") {
                  if (isFirstChunk) {
                    if (analysisContentEl) analysisContentEl.innerHTML = "";
                    isFirstChunk = false;
                  }
                  accumulatedText += evt.chunk;
                  if (analysisContentEl) {
                    analysisContentEl.innerHTML = processContentNoTickers(accumulatedText);
                  }
                } else if (evt.type === "recommendation") {
                  // Update recommendation badge
                  if (badge) {
                    badge.innerHTML = `<i data-lucide="sparkles" class="w-3.5 h-3.5 text-current"></i> ${evt.label}`;
                    badge.classList.remove("opacity-0", "scale-95");
                    badge.classList.add("opacity-100", "scale-100", "animate-fade-in");

                    badge.classList.remove(
                      "bg-slate-50",
                      "dark:bg-slate-800",
                      "text-slate-500",
                      "dark:text-slate-400",
                      "border-slate-200",
                      "dark:border-slate-700",
                    );

                    const color = evt.color;
                    if (color === "emerald" || color === "green") {
                      badge.classList.add(
                        "bg-gradient-to-b",
                        "from-emerald-50",
                        "to-emerald-100/90",
                        "dark:from-emerald-500/10",
                        "dark:to-emerald-500/30",
                        "text-emerald-700",
                        "dark:text-emerald-300",
                        "border-emerald-200",
                        "dark:border-emerald-500/40",
                      );
                    } else if (color === "rose" || color === "red") {
                      badge.classList.add(
                        "bg-gradient-to-b",
                        "from-rose-50",
                        "to-rose-100/90",
                        "dark:from-rose-500/10",
                        "dark:to-rose-500/30",
                        "text-rose-700",
                        "dark:text-rose-300",
                        "border-rose-200",
                        "dark:border-rose-500/40",
                      );
                    } else if (color === "blue") {
                      badge.classList.add(
                        "bg-gradient-to-b",
                        "from-blue-50",
                        "to-blue-100/90",
                        "dark:from-blue-500/10",
                        "dark:to-blue-500/30",
                        "text-blue-700",
                        "dark:text-blue-300",
                        "border-blue-200",
                        "dark:border-blue-500/40",
                      );
                    } else if (color === "yellow") {
                      badge.classList.add(
                        "bg-gradient-to-b",
                        "from-amber-50",
                        "to-amber-100/90",
                        "dark:from-amber-500/10",
                        "dark:to-amber-500/30",
                        "text-amber-700",
                        "dark:text-amber-300",
                        "border-amber-200",
                        "dark:border-amber-500/40",
                      );
                    }
                    lucide.createIcons({ root: badge });
                  }
                } else if (evt.type === "data") {
                  // Store data for timeframe switching
                  window.techAnalysisData = evt;

                  // Update indicator cards with data (default to short_term)
                  const shortTerm = evt.short_term || {};
                  const longTerm = evt.long_term || {};
                  const indicators = evt.indicators || shortTerm.indicators || {};
                  const gauges = evt.gauges || {};
                  const fibonacci = evt.fibonacci || indicators.fibonacci || {};
                  const pivotPoints = indicators.pivot_points || {};
                  const methods = shortTerm.methods || [];

                  // Update Analysis Chart
                  if (evt.ohlcv_data) {
                    renderAnalysisChart(evt.ohlcv_data, indicators.pivot_points);
                  }

                  // Draw Sparklines
                  if (indicators.rsi && indicators.rsi.series) {
                    drawSparkline("tech-rsi-sparkline", indicators.rsi.series, "rgba(99, 102, 241, 1)");
                  } else if (indicators.rsi_series) {
                    // Fallback for old data if any
                    drawSparkline("tech-rsi-sparkline", indicators.rsi_series, "rgba(99, 102, 241, 1)");
                  } else {
                    // Still call it to remove skeleton
                    removeSkeleton("tech-rsi-sparkline");
                  }
                  if (indicators.stochastic && indicators.stochastic.series) {
                    drawSparkline("tech-stoch-sparkline", indicators.stochastic.series, "rgba(16, 185, 129, 1)");
                  } else {
                    removeSkeleton("tech-stoch-sparkline");
                  }
                  if (indicators.macd && indicators.macd.series) {
                    drawSparkline("tech-macd-sparkline", indicators.macd.series, "rgba(139, 92, 246, 1)");
                  } else {
                    removeSkeleton("tech-macd-sparkline");
                  }

                  // Helper functions
                  const formatPrice = (p) => (p !== null && p !== undefined ? p.toLocaleString("vi-VN") : "--");
                  const formatNum = (n, decimals = 2) => (n !== null && n !== undefined ? n.toFixed(decimals) : "--");

                  // Update indicator display function
                  const updateIndicatorsDisplay = (ind, meth) => {
                    // RSI
                    const rsiData = ind.rsi || {};
                    const rsiValue = typeof rsiData === "object" ? rsiData.value : rsiData;
                    if (rsiValue !== null && rsiValue !== undefined) {
                      removeSkeleton("tech-rsi-value");
                      updateValueWithTooltip("tech-rsi-value", rsiValue.toFixed(1));
                      const marker = document.getElementById("tech-rsi-marker");
                      if (marker) marker.style.left = `calc(${rsiValue}% - 8px)`;
                      // Remove RSI bar skeleton
                      const rsiBarSkeleton = document.getElementById("tech-rsi-bar-skeleton");
                      if (rsiBarSkeleton) rsiBarSkeleton.remove();

                      const rsiSignal = document.getElementById("tech-rsi-signal");
                      if (rsiSignal) {
                        removeSkeleton("tech-rsi-signal");
                        rsiSignal.className =
                          "text-sm font-bold px-3 py-1 rounded-full flex items-center justify-center ml-auto";
                        if (rsiValue < 30) {
                          rsiSignal.textContent = "Qu√° b√°n";
                          rsiSignal.classList.add(
                            "bg-green-100",
                            "text-green-700",
                            "dark:bg-green-500/20",
                            "dark:text-green-400",
                          );
                        } else if (rsiValue > 70) {
                          rsiSignal.textContent = "Qu√° mua";
                          rsiSignal.classList.add(
                            "bg-red-100",
                            "text-red-700",
                            "dark:bg-red-500/20",
                            "dark:text-red-400",
                          );
                        } else {
                          rsiSignal.textContent = "Trung t√≠nh";
                          rsiSignal.classList.add(
                            "bg-yellow-100",
                            "text-yellow-700",
                            "dark:bg-yellow-500/20",
                            "dark:text-yellow-400",
                          );
                        }
                      }
                    } else {
                      // Ensure skeletons are removed even if data is null
                      removeSkeleton("tech-rsi-value");
                      removeSkeleton("tech-rsi-signal");
                    }

                    // Stochastic
                    const stoch = ind.stochastic || {};
                    const stochK = document.getElementById("tech-stoch-k");
                    const stochD = document.getElementById("tech-stoch-d");
                    const stochSignal = document.getElementById("tech-stoch-signal");
                    if (stochK) {
                      removeSkeleton("tech-stoch-k");
                      updateValueWithTooltip("tech-stoch-k", formatNum(stoch.k, 1));
                    }
                    if (stochD) {
                      removeSkeleton("tech-stoch-d");
                      updateValueWithTooltip("tech-stoch-d", formatNum(stoch.d, 1));
                    }
                    if (stochSignal && stoch.k !== null) {
                      removeSkeleton("tech-stoch-signal");
                      stochSignal.className =
                        "text-sm font-bold px-3 py-1 rounded-full flex items-center justify-center";
                      if (stoch.k < 20) {
                        stochSignal.textContent = "Qu√° b√°n";
                        stochSignal.classList.add(
                          "bg-green-100",
                          "text-green-700",
                          "dark:bg-green-500/20",
                          "dark:text-green-400",
                        );
                      } else if (stoch.k > 80) {
                        stochSignal.textContent = "Qu√° mua";
                        stochSignal.classList.add(
                          "bg-red-100",
                          "text-red-700",
                          "dark:bg-red-500/20",
                          "dark:text-red-400",
                        );
                      } else {
                        stochSignal.textContent = "Trung t√≠nh";
                        stochSignal.classList.add(
                          "bg-yellow-100",
                          "text-yellow-700",
                          "dark:bg-yellow-500/20",
                          "dark:text-yellow-400",
                        );
                      }
                    }

                    // Williams %R
                    if (ind.willr !== undefined) {
                      removeSkeleton("tech-willr");
                      updateValueWithTooltip("tech-willr", formatNum(ind.willr, 1));
                    }

                    // MACD
                    const macd = ind.macd || {};
                    const macdLine = document.getElementById("tech-macd-line");
                    const macdSignalVal = document.getElementById("tech-macd-signal-val");
                    const macdHist = document.getElementById("tech-macd-hist");
                    const macdSignal = document.getElementById("tech-macd-signal");
                    if (macdLine) {
                      removeSkeleton("tech-macd-line");
                      updateValueWithTooltip("tech-macd-line", formatNum(macd.line));
                    }
                    if (macdSignalVal) {
                      removeSkeleton("tech-macd-signal-val");
                      updateValueWithTooltip("tech-macd-signal-val", formatNum(macd.signal));
                    }
                    if (macdHist) {
                      removeSkeleton("tech-macd-hist");
                      updateValueWithTooltip("tech-macd-hist", formatNum(macd.histogram));
                      if (macd.histogram !== null) {
                        macdHist.classList.remove(
                          "text-green-600",
                          "text-red-600",
                          "dark:text-green-400",
                          "dark:text-red-400",
                        );
                        if (macd.histogram > 0) {
                          macdHist.classList.add("text-green-600", "dark:text-green-400");
                        } else {
                          macdHist.classList.add("text-red-600", "dark:text-red-400");
                        }
                      }
                    }
                    if (macdSignal && macd.histogram !== null) {
                      removeSkeleton("tech-macd-signal");
                      macdSignal.className =
                        "text-sm font-bold px-3 py-1 rounded-full flex items-center justify-center";
                      if (macd.histogram > 0) {
                        macdSignal.textContent = "T√≠ch c·ª±c";
                        macdSignal.classList.add(
                          "bg-green-100",
                          "text-green-700",
                          "dark:bg-green-500/20",
                          "dark:text-green-400",
                        );
                      } else {
                        macdSignal.textContent = "Ti√™u c·ª±c";
                        macdSignal.classList.add(
                          "bg-red-100",
                          "text-red-700",
                          "dark:bg-red-500/20",
                          "dark:text-red-400",
                        );
                      }
                    }

                    // ADX
                    const adx = ind.adx || {};
                    const adxVal = document.getElementById("tech-adx-val");
                    const adxDmp = document.getElementById("tech-adx-dmp");
                    const adxDmn = document.getElementById("tech-adx-dmn");
                    const adxSignal = document.getElementById("tech-adx-signal");
                    if (adxVal) {
                      removeSkeleton("tech-adx-val");
                      updateValueWithTooltip("tech-adx-val", formatNum(adx.adx, 1));
                    }
                    if (adxDmp) {
                      removeSkeleton("tech-adx-dmp");
                      updateValueWithTooltip("tech-adx-dmp", formatNum(adx.dmp, 1));
                    }
                    if (adxDmn) {
                      removeSkeleton("tech-adx-dmn");
                      updateValueWithTooltip("tech-adx-dmn", formatNum(adx.dmn, 1));
                    }
                    if (adxSignal && adx.adx !== null) {
                      removeSkeleton("tech-adx-signal");
                      adxSignal.className = "text-sm font-bold px-3 py-1 rounded-full flex items-center justify-center";
                      if (adx.adx > 25) {
                        adxSignal.textContent = "Xu h∆∞·ªõng m·∫°nh";
                        adxSignal.classList.add(
                          "bg-blue-100",
                          "text-blue-700",
                          "dark:bg-blue-500/20",
                          "dark:text-blue-400",
                        );
                      } else {
                        adxSignal.textContent = "ƒêi ngang";
                        adxSignal.classList.add(
                          "bg-yellow-100",
                          "text-yellow-700",
                          "dark:bg-yellow-500/20",
                          "dark:text-yellow-400",
                        );
                      }
                    }

                    // Moving Averages
                    const maConfig = [
                      { id: "tech-sma20", val: ind.sma20 },
                      { id: "tech-sma50", val: ind.sma50 },
                      { id: "tech-sma100", val: ind.sma100 },
                      { id: "tech-sma200", val: ind.sma200 },
                      { id: "tech-ema20", val: ind.ema20 },
                      { id: "tech-ema50", val: ind.ema50 },
                    ];

                    maConfig.forEach((ma) => {
                      if (ma.val !== undefined && ma.val !== null) {
                        removeSkeleton(ma.id);
                        updateValueWithTooltip(ma.id, formatPrice(ma.val));
                      }
                    });

                    // Bollinger Bands
                    const bb = ind.bollinger_bands || {};
                    const bbUpper = document.getElementById("tech-bb-upper");
                    const bbMiddle = document.getElementById("tech-bb-middle");
                    const bbLower = document.getElementById("tech-bb-lower");
                    const bbSignal = document.getElementById("tech-bb-signal");
                    if (bbUpper) {
                      removeSkeleton("tech-bb-upper");
                      updateValueWithTooltip("tech-bb-upper", formatPrice(bb.upper));
                    }
                    if (bbMiddle) {
                      removeSkeleton("tech-bb-middle");
                      updateValueWithTooltip("tech-bb-middle", formatPrice(bb.middle));
                    }
                    if (bbLower) {
                      removeSkeleton("tech-bb-lower");
                      updateValueWithTooltip("tech-bb-lower", formatPrice(bb.lower));
                    }
                    if (bbSignal && ind.current_price && bb.upper && bb.lower) {
                      bbSignal.className = "text-sm font-bold px-3 py-1 rounded-full flex items-center justify-center";
                      if (ind.current_price > bb.upper) {
                        bbSignal.textContent = "Qu√° mua";
                        bbSignal.classList.add("bg-red-100", "text-red-700", "dark:bg-red-500/20", "dark:text-red-400");
                      } else if (ind.current_price < bb.lower) {
                        bbSignal.textContent = "Qu√° b√°n";
                        bbSignal.classList.add(
                          "bg-green-100",
                          "text-green-700",
                          "dark:bg-green-500/20",
                          "dark:text-green-400",
                        );
                      } else {
                        bbSignal.textContent = "Trong bi√™n";
                        bbSignal.classList.add(
                          "bg-yellow-100",
                          "text-yellow-700",
                          "dark:bg-yellow-500/20",
                          "dark:text-yellow-400",
                        );
                      }
                    }

                    // ATR
                    if (ind.atr !== undefined) {
                      removeSkeleton("tech-atr");
                      updateValueWithTooltip("tech-atr", formatPrice(ind.atr));
                    }

                    // Volume Indicators
                    const obvTrend = document.getElementById("tech-obv-trend");
                    const cmf = document.getElementById("tech-cmf");
                    const volSignal = document.getElementById("tech-vol-signal");
                    if (obvTrend) {
                      removeSkeleton("tech-obv-trend");
                      const trend = ind.obv_trend;
                      updateValueWithTooltip(
                        "tech-obv-trend",
                        trend === "increasing" ? "TƒÉng" : trend === "decreasing" ? "Gi·∫£m" : "Trung t√≠nh",
                      );
                      obvTrend.classList.remove(
                        "text-green-600",
                        "text-red-600",
                        "dark:text-green-400",
                        "dark:text-red-400",
                      );
                      if (trend === "increasing") {
                        obvTrend.classList.add("text-green-600", "dark:text-green-400");
                      } else if (trend === "decreasing") {
                        obvTrend.classList.add("text-red-600", "dark:text-red-400");
                      }
                    }
                    if (cmf) {
                      removeSkeleton("tech-cmf");
                      updateValueWithTooltip("tech-cmf", formatNum(ind.cmf, 3));
                    }
                    if (volSignal && ind.obv_trend && ind.cmf !== null) {
                      removeSkeleton("tech-vol-signal");
                      volSignal.className = "text-sm font-bold px-3 py-1 rounded-full flex items-center justify-center";
                      if (ind.obv_trend === "increasing" && ind.cmf > 0) {
                        volSignal.textContent = "D√≤ng ti·ªÅn v√†o";
                        volSignal.classList.add(
                          "bg-green-100",
                          "text-green-700",
                          "dark:bg-green-500/20",
                          "dark:text-green-400",
                        );
                      } else if (ind.obv_trend === "decreasing" && ind.cmf < 0) {
                        volSignal.textContent = "D√≤ng ti·ªÅn ra";
                        volSignal.classList.add(
                          "bg-red-100",
                          "text-red-700",
                          "dark:bg-red-500/20",
                          "dark:text-red-400",
                        );
                      } else {
                        volSignal.textContent = "Trung t√≠nh";
                        volSignal.classList.add(
                          "bg-yellow-100",
                          "text-yellow-700",
                          "dark:bg-yellow-500/20",
                          "dark:text-yellow-400",
                        );
                      }
                    }

                    // Pivot Points
                    const pp = ind.pivot_points || {};
                    const pivot = document.getElementById("tech-pivot");
                    const pivotR1 = document.getElementById("tech-pivot-r1");
                    const pivotR2 = document.getElementById("tech-pivot-r2");
                    const pivotR3 = document.getElementById("tech-pivot-r3");
                    const pivotS1 = document.getElementById("tech-pivot-s1");
                    const pivotS2 = document.getElementById("tech-pivot-s2");
                    const pivotS3 = document.getElementById("tech-pivot-s3");
                    const pivotIds = ["pivot", "pivot-r1", "pivot-r2", "pivot-r3", "pivot-s1", "pivot-s2", "pivot-s3"];
                    pivotIds.forEach((id) => removeSkeleton("tech-" + id));

                    if (pivot) pivot.textContent = formatPrice(pp.pivot);
                    if (pivotR1) pivotR1.textContent = formatPrice(pp.r1);
                    if (pivotR2) pivotR2.textContent = formatPrice(pp.r2);
                    if (pivotR3) pivotR3.textContent = formatPrice(pp.r3);
                    if (pivotS1) pivotS1.textContent = formatPrice(pp.s1);
                    if (pivotS2) pivotS2.textContent = formatPrice(pp.s2);
                    if (pivotS3) pivotS3.textContent = formatPrice(pp.s3);

                    // Fibonacci Levels
                    const fib = ind.fibonacci || {};
                    const fib0 = document.getElementById("tech-fib-0");
                    const fib236 = document.getElementById("tech-fib-236");
                    const fib382 = document.getElementById("tech-fib-382");
                    const fib500 = document.getElementById("tech-fib-500");
                    const fib618 = document.getElementById("tech-fib-618");
                    const fib786 = document.getElementById("tech-fib-786");
                    const fib100 = document.getElementById("tech-fib-100");
                    const fibIds = ["fib-0", "fib-236", "fib-382", "fib-500", "fib-618", "fib-786", "fib-100"];
                    fibIds.forEach((id) => removeSkeleton("tech-" + id));

                    if (fib0) fib0.textContent = formatPrice(fib.level_0);
                    if (fib236) fib236.textContent = formatPrice(fib.level_236);
                    if (fib382) fib382.textContent = formatPrice(fib.level_382);
                    if (fib500) fib500.textContent = formatPrice(fib.level_500);
                    if (fib618) fib618.textContent = formatPrice(fib.level_618);
                    if (fib786) fib786.textContent = formatPrice(fib.level_786);
                    if (fib100) fib100.textContent = formatPrice(fib.level_100);

                    // Methods List
                    const methodsList = document.getElementById("tech-methods-list");
                    if (methodsList) {
                      removeSkeleton("tech-methods-list");
                      if (meth && meth.length > 0) {
                        methodsList.innerHTML = meth
                          .map((m) => {
                            const signalColor =
                              m.signal === "Bullish" ? "emerald" : m.signal === "Bearish" ? "rose" : "amber";
                            const signalIcon =
                              m.signal === "Bullish"
                                ? "trending-up"
                                : m.signal === "Bearish"
                                  ? "trending-down"
                                  : "minus";
                            return `
                          <div class="p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl">
                            <div class="flex items-center justify-between mb-1">
                              <span class="text-sm font-bold text-slate-700 dark:text-slate-200">${m.name}</span>
                              <span class="inline-flex items-center gap-1 text-xs font-bold px-2 py-0.5 rounded-full bg-${signalColor}-100 dark:bg-${signalColor}-500/20 text-${signalColor}-700 dark:text-${signalColor}-400">
                                <i data-lucide="${signalIcon}" class="w-3 h-3"></i>
                                ${m.signal}
                              </span>
                            </div>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mb-1">${m.category}</p>
                            <p class="text-xs text-slate-600 dark:text-slate-300">${m.evaluation}</p>
                          </div>
                        `;
                          })
                          .join("");
                      }
                      lucide.createIcons({ root: methodsList });
                    }
                  };

                  // Initialize display with short-term data
                  updateIndicatorsDisplay(indicators, methods);

                  // Gauges
                  const summary = gauges.summary || {};
                  const gaugeSummary = document.getElementById("tech-gauge-summary");
                  if (gaugeSummary) {
                    removeSkeleton("tech-gauge-summary");
                    gaugeSummary.innerHTML = `<i data-lucide="bar-chart-2" class="w-3 h-3"></i><span class="gauge-text">${
                      summary.label || "--"
                    }</span>`;
                    lucide.createIcons({ root: gaugeSummary });
                  }

                  const gaugeMA = document.getElementById("tech-gauge-ma");
                  if (gaugeMA) {
                    removeSkeleton("tech-gauge-ma");
                    gaugeMA.innerHTML = `<i data-lucide="trending-up" class="w-3 h-3"></i><span class="gauge-text">MA: ${
                      gauges.movingAverage?.label || "--"
                    }</span>`;
                    lucide.createIcons({ root: gaugeMA });
                  }

                  const gaugeOsc = document.getElementById("tech-gauge-osc");
                  if (gaugeOsc) {
                    removeSkeleton("tech-gauge-osc");
                    gaugeOsc.innerHTML = `<i data-lucide="activity" class="w-3 h-3"></i><span class="gauge-text">OSC: ${
                      gauges.oscillator?.label || "--"
                    }</span>`;
                    lucide.createIcons({ root: gaugeOsc });
                  }

                  // Setup timeframe card switching
                  const cardShort = document.getElementById("tech-card-short");
                  const cardLong = document.getElementById("tech-card-long");

                  if (cardShort && cardLong) {
                    const activeShortClass =
                      "cursor-pointer transition-all duration-300 p-4 rounded-3xl border-2 border-indigo-400/60 bg-gradient-to-br from-indigo-100 via-indigo-50 to-purple-100 dark:from-indigo-600/30 dark:via-indigo-500/20 dark:to-purple-600/20 backdrop-blur-xl shadow-[0_8px_32px_rgba(99,102,241,0.3)] scale-[1.03] z-10";
                    const inactiveShortClass =
                      "cursor-pointer transition-all duration-300 p-4 rounded-3xl border border-slate-200 dark:border-white/10 bg-gradient-to-br from-slate-100 via-white to-slate-50 dark:from-slate-800/60 dark:via-slate-900/40 dark:to-slate-800/40 backdrop-blur-md shadow-sm opacity-60 hover:opacity-100 hover:scale-[1.01]";

                    const activeLongClass =
                      "cursor-pointer transition-all duration-300 p-4 rounded-3xl border-2 border-emerald-400/60 bg-gradient-to-br from-emerald-100 via-emerald-50 to-teal-100 dark:from-emerald-600/30 dark:via-emerald-500/20 dark:to-teal-600/20 backdrop-blur-xl shadow-[0_8px_32px_rgba(16,185,129,0.3)] scale-[1.03] z-10";
                    const inactiveLongClass =
                      "cursor-pointer transition-all duration-300 p-4 rounded-3xl border border-slate-200 dark:border-white/10 bg-gradient-to-br from-slate-100 via-white to-slate-50 dark:from-slate-800/60 dark:via-slate-900/40 dark:to-slate-800/40 backdrop-blur-md shadow-sm opacity-60 hover:opacity-100 hover:scale-[1.01]";

                    cardShort.onclick = () => {
                      cardShort.className = activeShortClass;
                      cardLong.className = inactiveLongClass;
                      updateIndicatorsDisplay(shortTerm.indicators || indicators, shortTerm.methods || []);
                      // Re-render analysis chart with short_term timeframe (1Y, 1D)
                      if (selectedStock) renderAnalysisChart(selectedStock, "short_term");
                    };
                    cardLong.onclick = () => {
                      cardLong.className = activeLongClass;
                      cardShort.className = inactiveShortClass;
                      updateIndicatorsDisplay(longTerm.indicators || {}, longTerm.methods || []);
                      // Re-render analysis chart with long_term timeframe (5Y, 1W)
                      if (selectedStock) renderAnalysisChart(selectedStock, "long_term");
                    };
                  }
                } else if (evt.type === "analysis_summary") {
                  // Handle the new analysis_summary event from agent
                  const summary = evt.summary || {};

                  // Update short-term summary
                  const shortTrend = document.getElementById("tech-short-trend");
                  const shortSignal = document.getElementById("tech-short-signal");
                  const shortConfidence = document.getElementById("tech-short-confidence");
                  const shortConfidenceBar = document.getElementById("tech-short-confidence-bar");
                  const shortTrendBadge = document.getElementById("tech-short-trend-badge");

                  if (summary.short_term) {
                    removeSkeleton("tech-short-trend");
                    removeSkeleton("tech-short-signal");
                    removeSkeleton("tech-short-confidence");
                    removeSkeleton("tech-short-trend-badge");
                    if (shortTrend) shortTrend.textContent = summary.short_term.trend || "--";
                    if (shortSignal) shortSignal.textContent = summary.short_term.signal || "--";
                    if (shortConfidence && summary.short_term.confidence) {
                      const conf = (summary.short_term.confidence * 100).toFixed(0);
                      shortConfidence.textContent = `${conf}%`;
                    }
                    if (shortConfidenceBar && summary.short_term.confidence) {
                      const confPercent = summary.short_term.confidence * 100;
                      // Remove skeleton overlay
                      const shortSkeleton = document.getElementById("tech-short-confidence-skeleton");
                      if (shortSkeleton) shortSkeleton.remove();
                      // Show and move pointer to position (accounting for pointer width)
                      shortConfidenceBar.style.opacity = "1";
                      shortConfidenceBar.style.left = `calc(${confPercent}% - 8px)`;
                      // Color pointer based on confidence: red (0%) -> yellow (50%) -> green (100%)
                      const hue = (confPercent / 100) * 120;
                      shortConfidenceBar.style.background = `linear-gradient(135deg, hsl(${hue}, 85%, 65%), hsl(${hue}, 80%, 45%))`;
                      shortConfidenceBar.style.borderColor = `hsl(${hue}, 80%, 40%)`;
                      shortConfidenceBar.style.boxShadow = `0 2px 8px hsla(${hue}, 80%, 50%, 0.6), 0 0 0 2px hsla(${hue}, 80%, 50%, 0.2)`;
                    }
                    if (shortTrendBadge) {
                      shortTrendBadge.className = "text-xs font-bold px-2 py-1 rounded-full";
                      const sig = summary.short_term.signal?.toLowerCase() || "";
                      if (sig.includes("mua")) {
                        shortTrendBadge.textContent = "Mua";
                        shortTrendBadge.classList.add(
                          "bg-green-100",
                          "text-green-700",
                          "dark:bg-green-500/20",
                          "dark:text-green-400",
                        );
                      } else if (sig.includes("b√°n") || sig.includes("ph√¢n ph·ªëi")) {
                        shortTrendBadge.textContent = "B√°n";
                        shortTrendBadge.classList.add(
                          "bg-red-100",
                          "text-red-700",
                          "dark:bg-red-500/20",
                          "dark:text-red-400",
                        );
                      } else {
                        shortTrendBadge.textContent = summary.short_term.signal || "--";
                        shortTrendBadge.classList.add(
                          "bg-yellow-100",
                          "text-yellow-700",
                          "dark:bg-yellow-500/20",
                          "dark:text-yellow-400",
                        );
                      }
                    }
                  }

                  // Update long-term summary
                  const longTrend = document.getElementById("tech-long-trend");
                  const longSignal = document.getElementById("tech-long-signal");
                  const longConfidence = document.getElementById("tech-long-confidence");
                  const longConfidenceBar = document.getElementById("tech-long-confidence-bar");
                  const longTrendBadge = document.getElementById("tech-long-trend-badge");

                  if (summary.long_term) {
                    removeSkeleton("tech-long-trend");
                    removeSkeleton("tech-long-signal");
                    removeSkeleton("tech-long-confidence");
                    removeSkeleton("tech-long-trend-badge");
                    if (longTrend) longTrend.textContent = summary.long_term.trend || "--";
                    if (longSignal) longSignal.textContent = summary.long_term.signal || "--";
                    if (longConfidence && summary.long_term.confidence) {
                      const conf = (summary.long_term.confidence * 100).toFixed(0);
                      longConfidence.textContent = `${conf}%`;
                    }
                    if (longConfidenceBar && summary.long_term.confidence) {
                      const confPercent = summary.long_term.confidence * 100;
                      // Remove skeleton overlay
                      const longSkeleton = document.getElementById("tech-long-confidence-skeleton");
                      if (longSkeleton) longSkeleton.remove();
                      // Show and move pointer to position (accounting for pointer width)
                      longConfidenceBar.style.opacity = "1";
                      longConfidenceBar.style.left = `calc(${confPercent}% - 8px)`;
                      // Color pointer based on confidence: red (0%) -> yellow (50%) -> green (100%)
                      const hue = (confPercent / 100) * 120;
                      longConfidenceBar.style.background = `linear-gradient(135deg, hsl(${hue}, 85%, 65%), hsl(${hue}, 80%, 45%))`;
                      longConfidenceBar.style.borderColor = `hsl(${hue}, 80%, 40%)`;
                      longConfidenceBar.style.boxShadow = `0 2px 8px hsla(${hue}, 80%, 50%, 0.6), 0 0 0 2px hsla(${hue}, 80%, 50%, 0.2)`;
                    }
                    if (longTrendBadge) {
                      longTrendBadge.className = "text-xs font-bold px-2 py-1 rounded-full";
                      const sig = summary.long_term.signal?.toLowerCase() || "";
                      if (sig.includes("t√≠ch l≈©y")) {
                        longTrendBadge.textContent = "T√≠ch l≈©y";
                        longTrendBadge.classList.add(
                          "bg-green-100",
                          "text-green-700",
                          "dark:bg-green-500/20",
                          "dark:text-green-400",
                        );
                      } else if (sig.includes("ph√¢n ph·ªëi")) {
                        longTrendBadge.textContent = "Ph√¢n ph·ªëi";
                        longTrendBadge.classList.add(
                          "bg-red-100",
                          "text-red-700",
                          "dark:bg-red-500/20",
                          "dark:text-red-400",
                        );
                      } else {
                        longTrendBadge.textContent = summary.long_term.signal || "--";
                        longTrendBadge.classList.add(
                          "bg-yellow-100",
                          "text-yellow-700",
                          "dark:bg-yellow-500/20",
                          "dark:text-yellow-400",
                        );
                      }
                    }
                  }
                } else if (evt.type === "error") {
                  console.error("Stream Error:", evt.message);
                  if (analysisContentEl)
                    analysisContentEl.innerHTML += `<div class="text-red-500 text-xs mt-2">‚ö†Ô∏è ${evt.message}</div>`;
                }
              } catch (parseErr) {
                console.error("JSON Parse Error:", parseErr);
                if (analysisContentEl)
                  analysisContentEl.innerHTML += `<div class="text-red-500 text-xs mt-2">‚ö†Ô∏è ${parseErr}</div>`;
              }
            }
          }

          // End of stream check
          if (isFirstChunk && !accumulatedText) {
            if (analysisContentEl)
              analysisContentEl.innerHTML = `<div class="text-slate-500 italic text-sm">Kh√¥ng c√≥ d·ªØ li·ªáu ph√¢n t√≠ch.</div>`;
          }
        } catch (error) {
          console.error(error);
          if (analysisContentEl)
            analysisContentEl.innerHTML = `<div class="text-red-500 p-4">L·ªói: ${error.message}</div>`;
        }
      }
    </script>
  </body>
</html>
