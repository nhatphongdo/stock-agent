<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Agent - Professional Stock Assistant</title>
    <link rel="icon" type="image/svg+xml" href="/static/logo.svg">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f5f7ff',
                            100: '#ebf0fe',
                            200: '#dce4fd',
                            300: '#c5d0fb',
                            400: '#a3b3f8',
                            500: '#7e8ef3',
                            600: '#5c64eb',
                            700: '#4c4dd8',
                            800: '#3f3fb1',
                            900: '#37388d',
                            950: '#212152',
                        },
                        accent: {
                            cyan: '#06b6d4',
                            emerald: '#10b981',
                            amber: '#f59e0b',
                            rose: '#f43f5e',
                            violet: '#8b5cf6',
                        }
                    },
                    backgroundImage: {
                        'premium-gradient': 'linear-gradient(135deg, #5c64eb 0%, #8b5cf6 100%)',
                        'dark-premium-gradient': 'linear-gradient(135deg, #37388d 0%, #5c64eb 100%)',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .dark body { background-color: #020617; }

        .bubble-bot {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
            border-radius: 20px;
        }
        .dark .bubble-bot {
            background: rgba(15, 23, 42, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.3);
        }

        .bubble-user {
            background: linear-gradient(135deg, rgba(92, 100, 235, 0.8) 0%, rgba(139, 92, 246, 0.8) 100%);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            box-shadow: 0 8px 25px -5px rgba(99, 102, 241, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
        }
        .dark .bubble-user {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.8) 0%, rgba(124, 58, 237, 0.8) 100%);
            box-shadow: 0 8px 30px -5px rgba(0, 0, 0, 0.2);
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155;
        }
        .markdown-content h1 { font-size: 1.85rem; font-weight: 700; margin-top: 2rem; margin-bottom: 1.25rem; color: #1e1b4b; letter-spacing: -0.02em; }
        .markdown-content h2 { font-size: 1.5rem; font-weight: 600; margin-top: 1.75rem; margin-bottom: 1rem; color: #312e81; letter-spacing: -0.01em; }
        .dark .markdown-content h1 { color: #e0e7ff; }
        .dark .markdown-content h2 { color: #c7d2fe; }

        .markdown-content p { margin-bottom: 1.25rem; line-height: 1.8; color: #334155; font-size: 1rem; }
        .dark .markdown-content p { color: #f1f5f9; }

        .markdown-content ul { list-style-type: none; padding-left: 0; margin-bottom: 1.5rem; }
        .markdown-content li {
            margin-bottom: 0.75rem;
            padding-left: 1.75rem;
            position: relative;
            color: #475569;
            font-size: 0.95rem;
            line-height: 1.7;
        }
        .dark .markdown-content li { color: #e2e8f0; }
        .markdown-content li::before {
            content: "•";
            position: absolute;
            left: 0.25rem;
            color: #6366f1;
            font-weight: bold;
        }

        .markdown-content a {
            color: #6366f1;
            text-decoration: underline;
            text-underline-offset: 4px;
            font-weight: 600;
            transition: opacity 0.2s;
        }
        .markdown-content a:hover { opacity: 0.8; }
        .dark .markdown-content a { color: #a5b4fc; }

        /* Table Styling */
        .markdown-content table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 2rem 0;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            font-variant-numeric: tabular-nums;
        }
        .dark .markdown-content table { border-color: #1e293b; background: rgba(15, 23, 42, 0.4); }

        .markdown-content th {
            background: #f8fafc;
            font-weight: 700;
            text-align: left;
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            color: #475569;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.1em;
        }
        .dark .markdown-content th {
            background: #1e293b;
            border-bottom-color: #334155;
            color: #f1f5f9;
        }

        .markdown-content td {
            padding: 16px 20px;
            border-bottom: 1px solid #f1f5f9;
            color: #1e293b;
            font-size: 0.925rem;
            font-weight: 500;
            line-height: 1.5;
        }
        .dark .markdown-content td {
            border-bottom-color: #0f172a;
            color: #e2e8f0;
        }

        .markdown-content tr:last-child td { border-bottom: none; }
        .markdown-content tr:nth-child(even) { background-color: rgba(248, 250, 252, 0.5); }
        .dark .markdown-content tr:nth-child(even) { background-color: rgba(15, 23, 42, 0.2); }
        .markdown-content tr:hover { background-color: #f1f5f9; }
        .dark .markdown-content tr:hover { background-color: #1e293b; }

        /* Code Styling */
        .markdown-content code {
            background-color: #f1f5f9;
            padding: 0.2rem 0.5rem;
            border-radius: 8px;
            font-size: 0.85em;
            color: #6366f1;
            font-family: ui-monospace, SFMono-Regular, monospace;
            border: 1px solid #e2e8f0;
        }
        .dark .markdown-content code {
            background-color: #1e293b;
            color: #a5b4fc;
            border-color: #334155;
        }
        .markdown-content pre {
            background-color: #0f172a;
            padding: 1.25rem;
            border-radius: 16px;
            overflow-x: auto;
            margin: 1.5rem 0;
            border: 1px solid #1e293b;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .markdown-content pre code {
            background-color: transparent;
            border: none;
            padding: 0;
            color: #e2e8f0;
            font-size: 0.875rem;
        }

        .markdown-content blockquote {
            border-left: 5px solid #6366f1;
            padding: 0.75rem 1.25rem;
            font-style: italic;
            margin: 2rem 0;
            color: #312e81;
            background: linear-gradient(to right, #eef2ff, transparent);
            border-radius: 4px 16px 16px 4px;
        }
        .dark .markdown-content blockquote {
            color: #c7d2fe;
            background: linear-gradient(to right, rgba(99, 102, 241, 0.1), transparent);
        }

        /* User Bubble Markdown Fix */
        .user-markdown { color: white !important; }
        .user-markdown p { color: white !important; margin-bottom: 0; }
        .user-markdown * { color: white !important; }

        /* Thinking Section Styling */
        details.thinking-section {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            margin: 1rem 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .dark details.thinking-section {
            background-color: rgba(30, 41, 59, 0.3);
            border-color: rgba(99, 102, 241, 0.2);
        }
        details.thinking-section[open] {
            border-color: #6366f1;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
        }
        summary.thinking-header {
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
            font-weight: 700;
            color: #6366f1;
            cursor: pointer;
            list-style: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            user-select: none;
            background: rgba(99, 102, 241, 0.05);
        }
        summary.thinking-header::-webkit-details-marker { display: none; }
        summary.thinking-header::before {
            content: '→';
            display: inline-block;
            transition: transform 0.2s ease;
            font-size: 1rem;
        }
        details.thinking-section[open] summary.thinking-header::before {
            transform: rotate(90deg);
        }
        .thinking-content {
            padding: 1rem;
            font-size: 0.9rem;
            color: #64748b;
            line-height: 1.6;
            font-style: italic;
            border-top: 1px solid rgba(99, 102, 241, 0.1);
        }
        .dark .thinking-content {
            color: #94a3b8;
        }

        /* User Avatar & Menu */
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-500, #6366f1);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
            border: 2px solid white;
        }
        .dark .user-avatar {
            border-color: #1e293b;
        }
        .user-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.3);
        }
        .user-menu {
            position: absolute;
            top: 70px;
            right: 2rem;
            width: 240px;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            padding: 0.75rem;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .dark .user-menu {
            background: rgba(15, 23, 42, 0.2);
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }
        .user-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .menu-item {
            padding: 0.75rem 1rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #1e293b;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .dark .menu-item { color: #cbd5e1; }
        .menu-item:hover {
            background: rgba(99, 102, 241, 0.1);
            color: #6366f1;
        }
        .menu-divider {
            height: 1px;
            background: rgba(0, 0, 0, 0.05);
            margin: 0.5rem 0;
        }
        .dark .menu-divider { background: rgba(255, 255, 255, 0.05); }
        .user-switch-item {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 800;
        }

        /* Modal Styling */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .settings-modal {
            width: 500px;
            max-width: 90vw;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 36px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.2);
            padding: 2.5rem;
            transform: scale(0.9);
            transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .dark .settings-modal {
            background: rgba(15, 23, 42, 0.25);
            border-color: rgba(255, 255, 255, 0.18);
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.6);
        }
        .modal-overlay.show .settings-modal {
            transform: scale(1);
        }

        /* Blacklist Tag Styling */
        .blacklist-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        .blacklist-tag {
            padding: 0.5rem 0.75rem;
            background: rgba(99, 102, 241, 0.1);
            color: #6366f1;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: 1px solid rgba(99, 102, 241, 0.2);
            transition: all 0.2s ease;
        }
        .blacklist-tag:hover {
            background: rgba(99, 102, 241, 0.2);
        }
        .remove-tag {
            cursor: pointer;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            background: rgba(99, 102, 241, 0.2);
            transition: all 0.2s ease;
        }
        .remove-tag:hover {
            background: #ef4444;
            color: white;
        }

        /* Portfolio Modal Styling */
        .portfolio-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .portfolio-table th, .portfolio-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 2px solid rgba(0,0,0,0.1);
        }
        .dark .portfolio-table th, .dark .portfolio-table td {
            border-bottom: 2px solid rgba(255,255,255,0.15);
        }
        .portfolio-table th {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #0f172a;
            font-weight: 800;
            letter-spacing: 0.05em;
        }
        .dark .portfolio-table th {
            color: #f8fafc;
        }
        .portfolio-table tr:hover {
            background: rgba(0,0,0,0.02);
        }
        .dark .portfolio-table tr:hover {
            background: rgba(255,255,255,0.02);
        }

        .sidebar-tab-btn {
            color: #64748b;
            background: transparent;
            position: relative;
            z-index: 10;
        }
        .dark .sidebar-tab-btn {
            color: #94a3b8;
        }
        .sidebar-tab-btn.active {
            color: #ffffff !important;
        }
        .dark .sidebar-tab-btn.active {
            color: #ffffff !important;
        }

        /* Shimmer Animation */
        @keyframes shimmer-pill {
            0% { transform: translateX(-150%) skewX(-25deg); }
            100% { transform: translateX(250%) skewX(-25deg); }
        }

        #tab-indicator {
            position: absolute;
            background: linear-gradient(135deg, #8b5cf6, #3b82f6);
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow:
                0 10px 25px -5px rgba(59, 130, 246, 0.3),
                0 8px 10px -6px rgba(139, 92, 246, 0.2);
            transition: all 0.5s cubic-bezier(0.2, 1, 0.2, 1);
            z-index: 5;
            overflow: hidden;
        }

        #tab-indicator::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 60%;
            height: 100%;
            background: linear-gradient(
                to right,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent
            );
            animation: shimmer-pill 2.5s infinite linear;
        }

        .dark #tab-indicator {
            background: linear-gradient(135deg, #7c3aed, #2563eb);
            border: 1px solid rgba(255, 255, 255, 0.35);
            box-shadow:
                0 0 20px rgba(37, 99, 235, 0.25),
                0 0 40px rgba(124, 58, 237, 0.1);
        }

        .dark #tab-indicator::after {
            background: linear-gradient(
                to right,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
            padding-right: 2.5rem !important; /* Make sure there's space for the % symbol */
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.8s infinite ease-in-out;
            border-radius: 6px;
        }
        .dark .skeleton {
            background: linear-gradient(90deg, #0f172a 25%, #1e293b 50%, #0f172a 75%);
            background-size: 200% 100%;
        }
        @keyframes skeleton-loading {
            0% { background-position: 150% 0; }
            100% { background-position: -150% 0; }
        }

        .skeleton-bar {
            height: 0.85rem;
            margin-bottom: 0.85rem;
        }
        .skeleton-bar:last-child { margin-bottom: 0; }

        /* Resizer Styles */
        #resizer {
            width: 4px;
            cursor: col-resize;
            background-color: transparent;
            transition: background-color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50;
        }
        #resizer:hover, #resizer.resizing {
            background-color: #6366f1;
        }

        /* Stock Ticker Chips */
        .stock-ticker {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.125rem 0.5rem;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(59, 130, 246, 0.15));
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 0.5rem;
            font-weight: 700;
            font-size: 0.875em;
            color: #7c3aed;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        .stock-ticker:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.25), rgba(59, 130, 246, 0.25));
            border-color: rgba(139, 92, 246, 0.5);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
        }
        .stock-ticker.selected {
            background: linear-gradient(135deg, #8b5cf6, #3b82f6);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }
        .dark .stock-ticker {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.2));
            border-color: rgba(139, 92, 246, 0.4);
            color: #a78bfa;
        }
        .dark .stock-ticker:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.35), rgba(59, 130, 246, 0.35));
            border-color: rgba(139, 92, 246, 0.6);
        }
        .dark .stock-ticker.selected {
            background: linear-gradient(135deg, #7c3aed, #2563eb);
            color: white;
        }
    </style>
</head>
<body class="bg-[#f8fafc] dark:bg-[#020617] text-slate-900 dark:text-slate-100 transition-colors duration-300 h-screen overflow-hidden flex flex-col relative">

    <!-- Background Blobs -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
        <div class="absolute -top-[10%] -left-[10%] w-[40%] h-[40%] bg-primary-500/10 dark:bg-primary-500/5 rounded-full blur-[120px] animate-pulse"></div>
        <div class="absolute top-[20%] -right-[5%] w-[35%] h-[35%] bg-accent-violet/10 dark:bg-accent-violet/5 rounded-full blur-[120px] animate-pulse" style="animation-delay: 2s;"></div>
        <div class="absolute -bottom-[10%] left-[20%] w-[50%] h-[50%] bg-accent-cyan/10 dark:bg-accent-cyan/5 rounded-full blur-[120px] animate-pulse" style="animation-delay: 4s;"></div>
    </div>

    <!-- Header -->
    <header class="border-b border-white/40 dark:border-white/5 bg-white/40 dark:bg-slate-950/40 backdrop-blur-2xl px-8 py-4 flex items-center justify-between z-[60] sticky top-0">
        <div class="flex items-center gap-3 relative">
            <div class="bg-white dark:bg-slate-900 border border-indigo-100 dark:border-indigo-900/30 p-1.5 rounded-xl shadow-lg shadow-indigo-500/10 ring-1 ring-indigo-500/10 dark:ring-white/10">
                <img src="/static/logo.svg" alt="Trade Agent Logo" class="w-7 h-7 object-contain">
            </div>
            <div>
                <h1 class="text-2xl font-black bg-clip-text text-transparent bg-premium-gradient tracking-tight">Trade Agent</h1>
                <p class="text-[10px] uppercase tracking-[0.2em] font-bold text-slate-400 dark:text-slate-500 leading-none mt-1">AI-Powered Intelligence</p>
            </div>
        </div>
        <div class="flex items-center gap-4 relative">
            <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors border border-slate-200 dark:border-slate-800">
                <i data-lucide="moon" id="theme-icon-dark" class="w-5 h-5 hidden"></i>
                <i data-lucide="sun" id="theme-icon-light" class="w-5 h-5"></i>
            </button>
            <div id="user-avatar-btn" class="user-avatar">
                ??
            </div>

            <!-- User Menu Popup -->
            <div id="user-menu" class="user-menu">
                <div class="p-3 mb-2 flex items-center gap-3">
                    <div id="menu-avatar" class="w-10 h-10 rounded-full bg-primary-500 text-white flex items-center justify-center font-bold">??</div>
                    <div>
                        <div id="menu-user-name" class="font-bold text-slate-900 dark:text-white leading-tight">User Name</div>
                        <div id="menu-user-email" class="text-xs text-slate-600 dark:text-slate-400 font-medium">email@example.com</div>
                    </div>
                </div>
                <div class="menu-divider"></div>
                <div class="menu-item" onclick="openSettings()">
                    <i data-lucide="settings" class="w-4 h-4"></i>
                    <span>Thiết lập</span>
                </div>
                <div class="menu-item" onclick="openPortfolio()">
                    <i data-lucide="layout-list" class="w-4 h-4"></i>
                    <span>Danh mục cổ phiếu</span>
                </div>
                <div class="menu-divider"></div>
                <div class="user-switch-item">Đổi người dùng</div>
                <div id="user-list-container">
                    <!-- Dynamic user list -->
                </div>
            </div>
        </div>
    </header>

    <!-- Settings Modal -->
    <div id="settings-overlay" class="modal-overlay">
        <div class="settings-modal">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h2 class="text-2xl font-black bg-clip-text text-transparent bg-premium-gradient tracking-tight">Thiết lập cá nhân</h2>
                    <p class="text-xs text-slate-600 dark:text-slate-400 font-bold uppercase tracking-widest mt-1">Cấu hình tham số phân tích</p>
                </div>
                <button onclick="closeSettings()" class="w-10 h-10 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="space-y-6">
                <!-- Blacklist -->
                <div>
                    <label class="block text-[11px] font-black text-primary-600 dark:text-primary-400 mb-3 uppercase tracking-[0.2em] px-1">Danh sách đen (Blacklist)</label>
                    <div class="relative">
                        <input
                            type="text"
                            id="blacklist-input"
                            class="w-full p-4 rounded-2xl border border-slate-300 dark:border-white/10 bg-white dark:bg-slate-950 focus:border-primary-500 dark:focus:border-primary-400 focus:ring-4 focus:ring-primary-500/10 outline-none transition-all text-sm"
                            placeholder="Nhập tên ngành hoặc cổ phiếu rồi ấn Enter"
                        >
                        <i data-lucide="plus" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"></i>
                    </div>
                    <div id="blacklist-tags-container" class="blacklist-tags">
                        <!-- Tags will be rendered here -->
                    </div>
                </div>

                <!-- Dividend Rate -->
                <div>
                    <label class="block text-[11px] font-black text-primary-600 dark:text-primary-400 mb-3 uppercase tracking-[0.2em] px-1">Tỷ lệ cổ tức tối thiểu (%)</label>
                    <div class="relative">
                        <input
                            type="number"
                            id="dividend-rate-input"
                            step="0.1"
                            class="w-full p-4 rounded-2xl border border-slate-300 dark:border-white/10 bg-white dark:bg-slate-950 focus:border-primary-500 dark:focus:border-primary-400 focus:ring-4 focus:ring-primary-500/10 outline-none transition-all text-sm font-bold"
                            placeholder="Ví dụ: 6.0"
                        >
                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-sm">%</span>
                    </div>
                </div>
            </div>

            <div class="flex gap-3 mt-10">
                <button onclick="closeSettings()" class="flex-1 py-4 px-6 rounded-2xl font-bold bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-all">Hủy</button>
                <button onclick="saveSettings()" id="save-settings-btn" class="flex-1 py-4 px-6 rounded-2xl font-bold bg-premium-gradient text-white shadow-lg shadow-primary-500/20 hover:scale-[1.02] active:scale-[0.98] transition-all">Lưu thay đổi</button>
            </div>
        </div>
    </div>

    <!-- Portfolio Modal -->
    <div id="portfolio-overlay" class="modal-overlay">
        <div class="settings-modal" style="max-width: 600px;">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h2 class="text-2xl font-black bg-clip-text text-transparent bg-premium-gradient tracking-tight">Danh mục cổ phiếu</h2>
                    <p class="text-[11px] text-slate-700 dark:text-slate-300 font-bold uppercase tracking-[0.15em] mt-1.5 opacity-90">Quản lý mã cổ phiếu đang nắm giữ</p>
                </div>
                <button onclick="closePortfolio()" class="w-10 h-10 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Add Stock Form -->
            <div class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-xl border border-slate-200 dark:border-slate-800 mb-6">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 px-1">Mã cổ phiếu</label>
                        <input type="text" id="new-stock-symbol" placeholder="VD: VNM" class="w-full bg-white dark:bg-[#020617] border border-slate-300 dark:border-slate-800 rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-primary-500 outline-none transition-all">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 px-1">Giá vốn (VND)</label>
                        <input type="number" id="new-stock-price" placeholder="VD: 70000" class="w-full bg-white dark:bg-[#020617] border border-slate-300 dark:border-slate-800 rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-primary-500 outline-none transition-all">
                    </div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button onclick="addPortfolioStock()" id="add-stock-btn" class="flex-1 bg-primary-600 hover:bg-primary-700 text-white font-bold py-2.5 rounded-xl transition-all shadow-lg shadow-primary-500/25 flex items-center justify-center gap-2">
                        <i data-lucide="plus" id="add-stock-icon" class="w-4 h-4"></i>
                        <span id="add-stock-text">Thêm vào danh mục</span>
                    </button>
                    <button onclick="cancelEditStock()" id="cancel-edit-btn" class="hidden px-4 bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-400 font-bold py-2.5 rounded-xl transition-all">
                        Hủy
                    </button>
                </div>
            </div>

            <!-- Stocks Table -->
            <div class="max-h-[300px] overflow-y-auto">
                <table class="portfolio-table">
                    <thead>
                        <tr>
                            <th class="font-bold">Mã CK</th>
                            <th class="font-bold">Giá vốn</th>
                            <th class="w-10 font-bold"></th>
                        </tr>
                    </thead>
                    <tbody id="portfolio-list">
                        <!-- Dynamic stocks -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 flex overflow-hidden relative z-10" id="main-container">
        <!-- Left Column (initially 50%) -->
        <aside id="left-column" class="flex flex-col border-r border-white/20 dark:border-white/5 bg-white/20 dark:bg-slate-950/20 backdrop-blur-xl relative" style="width: 50%;">
            <!-- Top Segment (Input Area) -->
            <div class="p-8 border-b border-white/20 dark:border-white/10 bg-white/30 dark:bg-slate-950/30 backdrop-blur-2xl">
                <label for="user-task" class="block text-[11px] font-black text-primary-600 dark:text-primary-400 mb-3 uppercase tracking-[0.2em] px-1">Yêu cầu phân tích</label>
                <div class="relative group mb-5">
                    <textarea
                        id="user-task"
                        class="w-full h-36 p-5 pr-28 rounded-2xl border border-slate-300 dark:border-white/10 bg-white/40 dark:bg-slate-950/40 backdrop-blur-md focus:border-primary-500 dark:focus:border-primary-400 focus:ring-4 focus:ring-primary-500/10 outline-none transition-all resize-none custom-scrollbar text-sm font-medium placeholder-slate-400 dark:placeholder-slate-600 shadow-inner"
                        placeholder="Ví dụ: Phân tích cổ phiếu VNM và đưa ra gợi ý chiến lược ngắn hạn..."
                    ></textarea>
                    <!-- Clear Conversation Button -->
                    <button
                        type="button"
                        onclick="clearConversation()"
                        class="absolute bottom-4 right-16 mr-1 p-3 rounded-xl transition-all transform active:scale-90 z-10
                               bg-white/60 dark:bg-slate-800/60 backdrop-blur-sm border border-slate-200 dark:border-white/10
                               hover:bg-red-50 dark:hover:bg-red-900/20 hover:border-red-300 dark:hover:border-red-500/30
                               text-slate-400 dark:text-slate-500 hover:text-red-500 dark:hover:text-red-400"
                        title="Xóa cuộc hội thoại"
                    >
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                    <!-- Send Button -->
                    <button
                        id="submit-btn"
                        class="absolute bottom-4 right-4 bg-primary-600 hover:bg-primary-700 dark:bg-primary-500 dark:hover:bg-primary-400 text-white p-3 rounded-xl shadow-xl shadow-primary-500/20 transition-all transform active:scale-90 disabled:opacity-50 disabled:cursor-not-allowed z-10"
                        title="Gửi yêu cầu"
                    >
                        <i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                </div>
                <button
                    id="general-btn"
                    class="w-full flex items-center justify-center gap-3 py-4 px-6 rounded-2xl font-black transition-all border border-primary-500/30 dark:border-primary-400/20 bg-white/40 dark:bg-slate-900/40 backdrop-blur-xl hover:bg-white/60 dark:hover:bg-slate-800/60 text-primary-700 dark:text-white shadow-lg shadow-primary-500/10 dark:shadow-primary-500/5 active:scale-[0.97] disabled:opacity-50 disabled:cursor-not-allowed group relative overflow-hidden group/btn"
                >
                    <!-- Background shimmer & gradient overlay -->
                    <div class="absolute inset-0 bg-premium-gradient opacity-[0.1] dark:opacity-[0.2] group-hover:opacity-[0.3] transition-opacity"></div>
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-1000"></div>

                    <i data-lucide="sparkles" class="w-5 h-5 text-accent-cyan animate-pulse group-hover/btn:scale-110 transition-transform"></i>
                    <span class="tracking-tight relative z-10">Phân tích tổng quan thị trường</span>

                    <!-- Accent line -->
                    <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-3/4 h-[2px] bg-gradient-to-r from-transparent via-primary-500 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                </button>
            </div>

            <!-- Bottom Segment (Conversation Display) -->
            <div id="chat-container" class="flex-1 overflow-y-auto p-8 custom-scrollbar bg-transparent">
                <div id="messages" class="space-y-8">
                    <!-- Default Welcome Message -->
                    <div class="flex gap-4 group">
                        <div class="w-10 h-10 rounded-2xl bg-primary-600 shadow-lg shadow-primary-500/20 flex items-center justify-center flex-shrink-0 mt-1 ring-4 ring-primary-500/10">
                            <i data-lucide="bot" class="w-6 h-6 text-white"></i>
                        </div>
                        <div class="flex-1 bubble-bot p-5 rounded-3xl rounded-tl-none markdown-content border border-white/20 dark:border-white/5">
                            <p class="text-[15px] font-medium leading-relaxed" id="welcome-text">Xin chào! Tôi là <b>Stock Trading Assistant</b>. Hãy nhập yêu cầu phân tích để tôi có thể hỗ trợ bạn tìm kiếm cơ hội đầu tư tốt nhất.</p>
                        </div>
                    </div>
                </div>
                <!-- Loading Indicator -->
                <div id="loading" class="hidden mt-6">
                    <div class="flex gap-4 animate-pulse">
                        <div class="w-8 h-8 rounded-lg bg-slate-200 dark:bg-slate-800"></div>
                        <div class="flex-1 space-y-3">
                            <div class="h-4 bg-slate-200 dark:bg-slate-800 rounded-full w-3/4"></div>
                            <div class="h-3 bg-slate-200 dark:bg-slate-800 rounded-full w-1/2"></div>
                            <div class="h-3 bg-slate-200 dark:bg-slate-800 rounded-full w-5/6"></div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Vertical Resizer -->
        <div id="resizer" class="h-full"></div>

        <!-- Right Column (initially 50%) -->
        <div id="right-column" class="flex-1 bg-white/10 dark:bg-slate-950/20 backdrop-blur-sm p-12 flex flex-col items-center justify-center relative overflow-hidden">
            <!-- Background Decoration -->
            <div class="absolute inset-0 opacity-[0.05] pointer-events-none dark:opacity-[0.02]">
                <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                            <path d="M 40 0 L 0 0 0 40" fill="none" stroke="currentColor" stroke-width="0.5"/>
                        </pattern>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#grid)" />
                </svg>
            </div>

            <!-- Floating Shapes -->
            <div class="absolute top-[-10%] right-[-10%] w-64 h-64 bg-primary-500/10 rounded-full blur-3xl"></div>
            <div class="absolute bottom-[-10%] left-[-10%] w-64 h-64 bg-accent-cyan/10 rounded-full blur-3xl"></div>

            <!-- Tab Header -->
            <div class="absolute top-0 left-0 right-0 z-30 p-4">
                <div class="flex p-1 gap-1 bg-white/40 dark:bg-slate-900/40 backdrop-blur-3xl rounded-2xl border border-white/20 dark:border-white/5 shadow-lg relative" id="tab-bar">
                    <!-- iOS Style Indicator -->
                    <div id="tab-indicator" class="rounded-xl"></div>

                    <button onclick="switchTab('chart')" id="tab-btn-chart" class="flex-1 py-2.5 px-4 rounded-xl text-xs font-black uppercase tracking-widest transition-all sidebar-tab-btn active">
                        <div class="flex items-center justify-center gap-2">
                            <i data-lucide="line-chart" class="w-4 h-4"></i>
                            <span class="hidden xl:block">Biểu đồ</span>
                        </div>
                    </button>
                    <button onclick="switchTab('news')" id="tab-btn-news" class="flex-1 py-2.5 px-4 rounded-xl text-xs font-black uppercase tracking-widest transition-all sidebar-tab-btn">
                        <div class="flex items-center justify-center gap-2">
                            <i data-lucide="newspaper" class="w-4 h-4"></i>
                            <span class="hidden xl:block">Tin tức</span>
                        </div>
                    </button>
                    <button onclick="switchTab('analysis')" id="tab-btn-analysis" class="flex-1 py-2.5 px-4 rounded-xl text-xs font-black uppercase tracking-widest transition-all sidebar-tab-btn">
                        <div class="flex items-center justify-center gap-2">
                            <i data-lucide="microscope" class="w-4 h-4"></i>
                            <span class="hidden xl:block">Phân tích</span>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Stock Header (shown when a stock is selected) -->
            <div id="stock-header" class="hidden absolute top-16 left-0 right-0 z-20 px-4 pt-2">
                <div class="flex items-center gap-3 p-3 bg-white/50 dark:bg-slate-900/50 backdrop-blur-xl rounded-2xl border border-white/30 dark:border-white/10">
                    <div class="w-10 h-10 bg-gradient-to-br from-primary-500 to-blue-500 rounded-xl flex items-center justify-center text-white font-black text-sm shadow-lg">
                        <span id="stock-header-symbol">---</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 id="stock-header-name" class="font-bold text-slate-800 dark:text-slate-100 text-sm truncate">Chọn mã cổ phiếu</h3>
                        <p class="text-[10px] text-slate-500 dark:text-slate-400 uppercase tracking-widest font-bold">Đang xem chi tiết</p>
                </div>
            </div>

            <!-- Tab Content Area -->
            <div id="tab-content-container" class="flex-1 w-full pt-20 px-4 pb-4 overflow-hidden z-10">
                <!-- Data Placeholder / Welcome (Hidden by default since Chart is active) -->
                <div id="tab-empty-state" class="hidden h-full flex flex-col items-center justify-center text-center max-w-sm mx-auto">
                    <div class="w-20 h-20 bg-white/50 dark:bg-slate-900/50 rounded-3xl shadow-xl flex items-center justify-center mb-6 border border-white/40 dark:border-white/10 transform rotate-6 p-4">
                        <img src="/static/logo.svg" alt="Logo" class="w-full h-full object-contain transform -rotate-6">
                    </div>
                    <h3 class="text-xl font-black text-slate-800 dark:text-slate-100 mb-2 tracking-tight">Trung tâm Phân tích</h3>
                    <p class="text-xs text-slate-500 dark:text-slate-400 font-bold uppercase tracking-widest leading-relaxed opacity-70">
                        Chọn một tab phía trên để xem chi tiết thông tin thị trường
                    </p>
                </div>

                <!-- Technical Chart Tab (Visible by default) -->
                <div id="tab-content-chart" class="h-full w-full flex flex-col">
                    <div class="flex-1 bg-white/20 dark:bg-slate-900/20 rounded-3xl border border-white/40 dark:border-white/10 backdrop-blur-sm flex flex-col items-center justify-center p-8 text-center border-dashed">
                        <div class="w-16 h-16 bg-primary-100/50 dark:bg-primary-900/20 rounded-2xl flex items-center justify-center mb-4 text-primary-500">
                            <i data-lucide="line-chart" class="w-8 h-8"></i>
                        </div>
                        <h4 class="text-lg font-bold text-slate-700 dark:text-slate-300">Biểu đồ kỹ thuật</h4>
                        <p class="text-sm text-slate-500 dark:text-slate-500 mt-2">Tính năng đang được phát triển. Tích hợp TradingView đang được thiết lập.</p>
                    </div>
                </div>

                <!-- Related News Tab -->
                <div id="tab-content-news" class="hidden h-full w-full overflow-y-auto custom-scrollbar pr-2">
                    <div class="space-y-4">
                        <div class="p-5 bg-white/30 dark:bg-slate-950/40 rounded-3xl border border-white/40 dark:border-white/5 backdrop-blur-md">
                            <div class="text-[10px] font-black text-primary-600 dark:text-primary-400 uppercase tracking-widest mb-2 px-1">Tài chính vĩ mô • 15 phút trước</div>
                            <h4 class="font-bold text-slate-800 dark:text-slate-200 leading-snug">VN-Index bứt phá ngưỡng cản tâm lý, dòng tiền lan tỏa mạnh mẽ</h4>
                        </div>
                        <div class="p-5 bg-white/30 dark:bg-slate-950/40 rounded-3xl border border-white/40 dark:border-white/5 backdrop-blur-md">
                            <div class="text-[10px] font-black text-primary-600 dark:text-primary-400 uppercase tracking-widest mb-2 px-1">Tin doanh nghiệp • 1 giờ trước</div>
                            <h4 class="font-bold text-slate-800 dark:text-slate-200 leading-snug">Nhiều cổ phiếu ngân hàng lập đỉnh mới nhờ kết quả kinh doanh đột phá</h4>
                        </div>
                    </div>
                </div>

                <!-- Deep Analysis Tab -->
                <div id="tab-content-analysis" class="hidden h-full w-full overflow-y-auto custom-scrollbar pr-2">
                    <div class="p-6 bg-white/40 dark:bg-slate-900/40 rounded-[2rem] border border-white/50 dark:border-white/10 backdrop-blur-2xl">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-10 h-10 bg-accent-cyan/20 rounded-xl flex items-center justify-center text-accent-cyan">
                                <i data-lucide="search" class="w-5 h-5"></i>
                            </div>
                            <h4 class="font-black text-slate-800 dark:text-white uppercase tracking-tighter">Báo cáo phân tích chuyên sâu</h4>
                        </div>
                        <p class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed font-medium">
                            Các phân tích đa chiều về doanh nghiệp, định giá và dự báo xu hướng dài hạn sẽ được bộ não AI tổng hợp chi tiết tại đây sau mỗi lượt truy vấn.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        function switchTab(tabId) {
            // Hide all contents
            document.getElementById('tab-empty-state').classList.add('hidden');
            document.getElementById('tab-content-chart').classList.add('hidden');
            document.getElementById('tab-content-news').classList.add('hidden');
            document.getElementById('tab-content-analysis').classList.add('hidden');

            // Show selected content
            document.getElementById(`tab-content-${tabId}`).classList.remove('hidden');

            // Update button states
            document.querySelectorAll('.sidebar-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.getElementById(`tab-btn-${tabId}`);
            activeBtn.classList.add('active');

            // Animate indicator
            updateTabIndicator(activeBtn);
        }

        function updateTabIndicator(btn) {
            const indicator = document.getElementById('tab-indicator');
            const tabBar = document.getElementById('tab-bar');

            if (btn && indicator && tabBar) {
                indicator.style.width = `${btn.offsetWidth}px`;
                indicator.style.height = `${btn.offsetHeight}px`;
                indicator.style.left = `${btn.offsetLeft}px`;
                indicator.style.top = `${btn.offsetTop}px`;
            }
        }

        // Initialize Tab Indicator on load
        window.addEventListener('load', () => {
            const activeBtn = document.querySelector('.sidebar-tab-btn.active');
            if (activeBtn) updateTabIndicator(activeBtn);
        });

        // Initialize Lucide Icons
        lucide.createIcons();

        // Resizer Logic
        const resizer = document.getElementById('resizer');
        const leftColumn = document.getElementById('left-column');
        const mainContainer = document.getElementById('main-container');

        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            resizer.classList.add('resizing');
            document.body.style.cursor = 'col-resize';
            // Disable text selection and pointer events in iframe/content during resize
            document.body.classList.add('select-none');
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;

            const containerWidth = mainContainer.offsetWidth;
            let newLeftWidth = (e.clientX / containerWidth) * 100;

            // Constraints
            if (newLeftWidth < 20) newLeftWidth = 20;
            if (newLeftWidth > 80) newLeftWidth = 80;

            leftColumn.style.width = `${newLeftWidth}%`;

            // Re-sync tab indicator in real-time
            const activeBtn = document.querySelector('.sidebar-tab-btn.active');
            if (activeBtn) updateTabIndicator(activeBtn);
        });

        // Sync tab indicator on window resize
        window.addEventListener('resize', () => {
            const activeBtn = document.querySelector('.sidebar-tab-btn.active');
            if (activeBtn) updateTabIndicator(activeBtn);
        });

        document.addEventListener('mouseup', () => {
            isResizing = false;
            resizer.classList.remove('resizing');
            document.body.style.cursor = 'default';
            document.body.classList.remove('select-none');
        });

        const themeToggle = document.getElementById('theme-toggle');
        const themeIconDark = document.getElementById('theme-icon-dark');
        const themeIconLight = document.getElementById('theme-icon-light');
        const html = document.documentElement;

        // Theme Management
        function setTheme(theme) {
            if (theme === 'dark') {
                html.classList.add('dark');
                themeIconDark.classList.remove('hidden');
                themeIconLight.classList.add('hidden');
            } else {
                html.classList.remove('dark');
                themeIconDark.classList.add('hidden');
                themeIconLight.classList.remove('hidden');
            }
            localStorage.setItem('theme', theme);
        }

        // Check for saved theme or system preference
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            setTheme(savedTheme);
        } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            setTheme('dark');
        }

        themeToggle.addEventListener('click', () => {
            setTheme(html.classList.contains('dark') ? 'light' : 'dark');
        });

        // --- Valid Stock Symbols (fetched from backend) ---
        let symbolsMap = {}; // symbol -> company name

        async function fetchValidSymbols() {
            try {
                const response = await fetch('/symbols');
                if (response.ok) {
                    const data = await response.json();
                    symbolsMap = data.symbols || {};
                }
            } catch (error) {
                console.error('Failed to fetch stock symbols:', error);
            }
        }

        // Fetch symbols on page load
        fetchValidSymbols();

        // Chat Management
        const submitBtn = document.getElementById('submit-btn');
        const generalBtn = document.getElementById('general-btn');
        const userTaskInput = document.getElementById('user-task');
        const messagesContainer = document.getElementById('messages');
        const loadingIndicator = document.getElementById('loading');
        const chatContainer = document.getElementById('chat-container');

        // --- Conversation Persistence (sessionStorage) ---
        const CONVERSATION_KEY = 'trade_agent_conversation';

        function saveConversation() {
            sessionStorage.setItem(CONVERSATION_KEY, messagesContainer.innerHTML);
        }

        function loadConversation() {
            const saved = sessionStorage.getItem(CONVERSATION_KEY);
            if (saved) {
                messagesContainer.innerHTML = saved;
                lucide.createIcons({ root: messagesContainer });
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        function clearConversation() {
            // Build greeting with user name if available
            const userName = currentUser && currentUser.full_name ? currentUser.full_name : '';
            const greeting = userName
                ? `Xin chào <b>${userName}</b>! Tôi là <b>Stock Trading Assistant</b>. Hãy nhập yêu cầu phân tích để tôi có thể hỗ trợ bạn tìm kiếm cơ hội đầu tư tốt nhất.`
                : `Xin chào! Tôi là <b>Stock Trading Assistant</b>. Hãy nhập yêu cầu phân tích để tôi có thể hỗ trợ bạn tìm kiếm cơ hội đầu tư tốt nhất.`;

            const greetingHTML = `
                <div class="flex gap-4 group">
                    <div class="w-10 h-10 rounded-2xl bg-primary-600 shadow-lg shadow-primary-500/20 flex items-center justify-center flex-shrink-0 mt-1 ring-4 ring-primary-500/10">
                        <i data-lucide="bot" class="w-6 h-6 text-white"></i>
                    </div>
                    <div class="flex-1 bubble-bot p-5 rounded-3xl rounded-tl-none markdown-content border border-white/20 dark:border-white/5">
                        <p class="text-[15px] font-medium leading-relaxed" id="welcome-text">${greeting}</p>
                    </div>
                </div>
            `;
            messagesContainer.innerHTML = greetingHTML;
            lucide.createIcons({ root: messagesContainer });
            sessionStorage.removeItem(CONVERSATION_KEY);
        }

        // Load conversation on page load
        loadConversation();

        // --- Stock Ticker Click Handler ---
        let selectedStock = null;

        // Event delegation for stock ticker clicks
        chatContainer.addEventListener('click', (e) => {
            const ticker = e.target.closest('.stock-ticker');
            if (ticker) {
                const symbol = ticker.dataset.symbol;
                selectStock(symbol);
            }
        });

        function selectStock(symbol) {
            // Update selected state
            selectedStock = symbol;
            const companyName = symbolsMap[symbol] || symbol;

            // Remove selected class from all tickers
            document.querySelectorAll('.stock-ticker.selected').forEach(el => {
                el.classList.remove('selected');
            });

            // Add selected class to all instances of the clicked ticker
            document.querySelectorAll(`.stock-ticker[data-symbol="${symbol}"]`).forEach(el => {
                el.classList.add('selected');
            });

            // Show and update Stock Header
            const stockHeader = document.getElementById('stock-header');
            stockHeader.classList.remove('hidden');
            document.getElementById('stock-header-symbol').textContent = symbol;
            document.getElementById('stock-header-name').textContent = companyName;
            lucide.createIcons({ root: stockHeader });

            // Adjust content container padding
            document.getElementById('tab-content-container').classList.remove('pt-20');
            document.getElementById('tab-content-container').classList.add('pt-36');

            // Update Chart Tab
            const chartTab = document.getElementById('tab-content-chart');
            chartTab.innerHTML = `
                <div class="flex-1 bg-white/20 dark:bg-slate-900/20 rounded-3xl border border-white/40 dark:border-white/10 backdrop-blur-sm flex flex-col items-center justify-center p-8 text-center border-dashed">
                    <div class="w-16 h-16 bg-primary-100/50 dark:bg-primary-900/20 rounded-2xl flex items-center justify-center mb-4 text-primary-500">
                        <i data-lucide="line-chart" class="w-8 h-8"></i>
                    </div>
                    <h4 class="text-lg font-bold text-slate-700 dark:text-slate-300">Biểu đồ kỹ thuật</h4>
                    <p class="text-sm text-slate-500 dark:text-slate-500 mt-2">Đang tải biểu đồ cho ${symbol}...</p>
                </div>
            `;
            lucide.createIcons({ root: chartTab });

            // Update News Tab
            const newsTab = document.getElementById('tab-content-news');
            newsTab.innerHTML = `
                <div class="space-y-4">
                    <div class="p-5 bg-white/30 dark:bg-slate-950/40 rounded-3xl border border-white/40 dark:border-white/5 backdrop-blur-md">
                        <div class="text-[10px] font-black text-primary-600 dark:text-primary-400 uppercase tracking-widest mb-2 px-1">Tin tức ${symbol} • Đang tải...</div>
                        <h4 class="font-bold text-slate-800 dark:text-slate-200 leading-snug">Đang tổng hợp tin tức liên quan đến ${companyName}...</h4>
                    </div>
                </div>
            `;

            // Update Analysis Tab
            const analysisTab = document.getElementById('tab-content-analysis');
            analysisTab.innerHTML = `
                <div class="p-6 bg-white/40 dark:bg-slate-900/40 rounded-[2rem] border border-white/50 dark:border-white/10 backdrop-blur-2xl">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-accent-cyan/20 rounded-xl flex items-center justify-center text-accent-cyan">
                            <i data-lucide="search" class="w-5 h-5"></i>
                        </div>
                        <h4 class="font-black text-slate-800 dark:text-white uppercase tracking-tighter">Phân tích chuyên sâu</h4>
                    </div>
                    <p class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed font-medium">
                        Phân tích đa chiều về ${companyName} (${symbol}) bao gồm định giá, dự báo xu hướng và đánh giá rủi ro.
                    </p>
                </div>
            `;
            lucide.createIcons({ root: analysisTab });
        }

        async function analyzeTask(isGeneral = false) {
            let task = null;

            if (!isGeneral) {
                task = userTaskInput.value.trim();
                if (!task) return;
                addMessage('user', task);
                userTaskInput.value = '';
            } else {
                addMessage('user', '✨ Phân tích tổng quan thị trường');
            }

            // Show loading
            submitBtn.disabled = true;
            generalBtn.disabled = true;
            loadingIndicator.classList.remove('hidden');
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Prepare bot message bubble for streaming
            const botMessageId = 'bot-msg-' + Date.now();
            const messageDiv = addInitialBotMessage(botMessageId);
            const contentDiv = messageDiv.querySelector('.markdown-content');
            let fullContent = '';
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                // Fetch user's current stocks from portfolio to pass to agent
                let userStocks = [];
                if (currentUser) {
                    try {
                        const stocksRes = await fetch(`/users/${currentUser.id}/stocks`);
                        if (stocksRes.ok) {
                            const stocksData = await stocksRes.json();
                            userStocks = stocksData.map(s => `${s.stock_name} (${s.avg_price})`);
                        }
                    } catch (e) {
                        console.warn('Could not fetch portfolio for analysis:', e);
                    }
                }

                const response = await fetch('/stock-analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        task: task,
                        stocks: userStocks,
                        blacklist: currentUser ? currentUser.black_list : null,
                        dividend_rate: currentUser ? currentUser.dividend_rate : null,
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                // Hide loading indicator as soon as stream starts
                loadingIndicator.classList.add('hidden');

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                        fullContent += chunk;

                        // Process thinking sections and render markdown
                        contentDiv.innerHTML = processContent(fullContent);
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }
                } catch (error) {
                console.error('Error:', error);
                if (contentDiv) {
                    contentDiv.innerHTML = '❌ Đã xảy ra lỗi khi kết nối với máy chủ: ' + error.message;
                }
            } finally {
                submitBtn.disabled = false;
                generalBtn.disabled = false;
                loadingIndicator.classList.add('hidden');
                chatContainer.scrollTop = chatContainer.scrollHeight;
                // Save conversation to sessionStorage
                saveConversation();
            }
        }

        function addInitialBotMessage(id) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex gap-4 group';
            messageDiv.id = id;

            messageDiv.innerHTML = `
                <div class="w-10 h-10 rounded-2xl bg-primary-600 shadow-lg shadow-primary-500/20 flex items-center justify-center flex-shrink-0 mt-1 ring-4 ring-primary-500/10">
                    <i data-lucide="bot" class="w-6 h-6 text-white"></i>
                </div>
                <div class="flex-1 bubble-bot p-5 rounded-3xl rounded-tl-none overflow-x-auto">
                    <div class="markdown-content text-[15px] prose dark:prose-invert max-w-none">
                        <div class="skeleton-bars">
                            <div class="skeleton skeleton-bar w-3/4"></div>
                            <div class="skeleton skeleton-bar w-full"></div>
                            <div class="skeleton skeleton-bar w-5/6"></div>
                        </div>
                    </div>
                </div>
            `;

            messagesContainer.appendChild(messageDiv);
            lucide.createIcons({ root: messageDiv });
            return messageDiv;
        }

        function addMessage(sender, content) {
            if (sender === 'bot') {
                const id = 'bot-msg-' + Date.now();
                const div = addInitialBotMessage(id);
                div.querySelector('.markdown-content').innerHTML = processContent(content);
                return;
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex gap-4 justify-end group user-bubble-container';

            messageDiv.innerHTML = `
                <div class="flex-1 bubble-user p-5 rounded-3xl rounded-tr-none max-w-[85%]">
                    <div class="markdown-content user-markdown text-[15px] font-medium leading-relaxed">
                        ${marked.parse(content)}
                    </div>
                </div>
                <div class="w-10 h-10 rounded-2xl bg-white dark:bg-slate-800 shadow-xl flex items-center justify-center flex-shrink-0 mt-1 border border-slate-100 dark:border-white/10">
                    <i data-lucide="user" class="w-6 h-6 text-primary-500"></i>
                </div>
            `;

            messagesContainer.appendChild(messageDiv);
            lucide.createIcons({ root: messageDiv });
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function processContent(text) {
            // Handle unclosed thought tags during streaming
            let processedText = text;
            if (processedText.includes('<thought>') && !processedText.includes('</thought>')) {
                processedText += '</thought>';
            }

            // Replace thought tags with collapsible details
            processedText = processedText.replace(/<thought>([\s\S]*?)<\/thought>/g, (match, content) => {
                return `
<details class="thinking-section">
    <summary class="thinking-header">Xem quá trình suy luận</summary>
    <div class="thinking-content">
        ${marked.parse(content.trim())}
    </div>
</details>`;
            });
            // Ensure space after punctuation (., !, ?) if not followed by a space, number, or other punctuation
            // Skip file extensions (dot followed by lowercase letter like .pdf, .xlsx)
            // Add space when dot followed by uppercase letter (new sentence)
            processedText = processedText.replace(/([.])([A-Z])/g, '$1 $2');
            processedText = processedText.replace(/([!?])([A-Za-z])/g, '$1 $2');

            // Parse markdown first
            let html = marked.parse(processedText);

            // Wrap stock tickers in clickable spans
            // Only highlight if the ticker exists in our valid symbols list
            html = html.replace(/\b([A-Z]{3,4})\b/g, (match, ticker) => {
                // Check against the valid symbols list fetched from backend
                if (ticker in symbolsMap) {
                    return `<span class="stock-ticker" data-symbol="${ticker}">${ticker}</span>`;
                }
                return match;
            });

            return html;
        }

        // --- User management logic ---
        let users = [];
        let currentUser = null;

        const userAvatarBtn = document.getElementById('user-avatar-btn');
        const userMenu = document.getElementById('user-menu');
        const userListContainer = document.getElementById('user-list-container');
        const menuAvatar = document.getElementById('menu-avatar');
        const menuUserName = document.getElementById('menu-user-name');
        const menuUserEmail = document.getElementById('menu-user-email');

        const settingsOverlay = document.getElementById('settings-overlay');
        const blacklistInput = document.getElementById('blacklist-input');
        const blacklistTagsContainer = document.getElementById('blacklist-tags-container');
        const dividendRateInput = document.getElementById('dividend-rate-input');
        const saveSettingsBtn = document.getElementById('save-settings-btn');

        let tempBlacklist = [];

        function getInitials(name) {
            if (!name) return '??';
            const parts = name.split(' ');
            if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
            return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        }

        async function fetchUsers() {
            try {
                const response = await fetch('/users');
                users = await response.json();

                if (users.length > 0) {
                    // Load saved user or first user
                    const savedUserId = localStorage.getItem('lastUserId');
                    const user = users.find(u => u.id == savedUserId) || users[0];
                    selectUser(user);
                }
                renderUserList();
            } catch (error) {
                console.error('Error fetching users:', error);
            }
        }

        function selectUser(user) {
            currentUser = user;
            localStorage.setItem('lastUserId', user.id);

            const initials = getInitials(user.full_name);
            userAvatarBtn.innerText = initials;
            menuAvatar.innerText = initials;
            menuUserName.innerText = user.full_name;
            menuUserEmail.innerText = user.email;

            // Update welcome message
            const welcomeText = document.getElementById('welcome-text');
            if (welcomeText) {
                welcomeText.innerHTML = `Xin chào <b>${user.full_name}</b>! Tôi là <b>Stock Trading Assistant</b>. Hãy nhập yêu cầu phân tích để tôi có thể hỗ trợ bạn tìm kiếm cơ hội đầu tư tốt nhất.`;
            }

            // Hide menu
            userMenu.classList.remove('show');
        }

        function openSettings() {
            if (!currentUser) return;

            userMenu.classList.remove('show');
            settingsOverlay.classList.add('show');

            tempBlacklist = [...currentUser.black_list];
            dividendRateInput.value = currentUser.dividend_rate;
            renderBlacklistTags();
        }

        function closeSettings() {
            settingsOverlay.classList.remove('show');
        }

        function renderBlacklistTags() {
            blacklistTagsContainer.innerHTML = '';
            tempBlacklist.forEach((item, index) => {
                const tag = document.createElement('div');
                tag.className = 'blacklist-tag';
                tag.innerHTML = `
                    <span>${item}</span>
                    <span class="remove-tag" onclick="removeBlacklistItem(${index})">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </span>
                `;
                blacklistTagsContainer.appendChild(tag);
            });
            lucide.createIcons({ root: blacklistTagsContainer });
        }

        function addBlacklistItem(text) {
            const val = text.trim();
            if (val && !tempBlacklist.includes(val)) {
                tempBlacklist.push(val);
                renderBlacklistTags();
            }
            blacklistInput.value = '';
        }

        function removeBlacklistItem(index) {
            tempBlacklist.splice(index, 1);
            renderBlacklistTags();
        }

        async function saveSettings() {
            if (!currentUser) return;

            const originalText = saveSettingsBtn.innerText;
            saveSettingsBtn.innerText = 'Đang lưu...';
            saveSettingsBtn.disabled = true;

            try {
                const response = await fetch(`/users/${currentUser.id}/settings`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        black_list: tempBlacklist,
                        dividend_rate: parseFloat(dividendRateInput.value) || 0
                    })
                });

                if (response.ok) {
                    const updatedUser = await response.json();

                    // Update current user and sync with users array
                    currentUser.black_list = updatedUser.black_list;
                    currentUser.dividend_rate = updatedUser.dividend_rate;

                    const userIdx = users.findIndex(u => u.id === currentUser.id);
                    if (userIdx !== -1) users[userIdx] = {...currentUser};

                    closeSettings();
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Save failed:', response.status, errorData);
                    alert(`Lỗi khi lưu thiết lập: ${response.status} ${errorData.detail || ''}`);
                }
            } catch (error) {
                console.error('Network or unexpected error:', error);
                alert('Lỗi kết nối máy chủ hoặc lỗi bất ngờ. Vui lòng kiểm tra console.');
            } finally {
                saveSettingsBtn.innerText = originalText;
                saveSettingsBtn.disabled = false;
            }
        }

        // --- Portfolio Management ---
        const portfolioOverlay = document.getElementById('portfolio-overlay');
        const portfolioList = document.getElementById('portfolio-list');
        const newStockSymbol = document.getElementById('new-stock-symbol');
        const newStockPrice = document.getElementById('new-stock-price');
        const addStockBtn = document.getElementById('add-stock-btn');
        const addStockIcon = document.getElementById('add-stock-icon');
        const addStockText = document.getElementById('add-stock-text');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');

        let editingStockId = null;

        function openPortfolio() {
            if (!currentUser) return;
            userMenu.classList.remove('show');
            portfolioOverlay.classList.add('show');
            fetchPortfolioStocks();
        }

        function closePortfolio() {
            portfolioOverlay.classList.remove('show');
        }

        async function fetchPortfolioStocks() {
            if (!currentUser) return;
            try {
                const response = await fetch(`/users/${currentUser.id}/stocks`);
                const stocks = await response.json();
                renderPortfolioTable(stocks);
            } catch (error) {
                console.error('Error fetching portfolio:', error);
            }
        }

        function renderPortfolioTable(stocks) {
            portfolioList.innerHTML = '';
            if (stocks.length === 0) {
                portfolioList.innerHTML = '<tr><td colspan="3" class="text-center text-slate-400 py-10 text-sm">Chưa có cổ phiếu nào trong danh mục</td></tr>';
                return;
            }

            stocks.forEach(stock => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="font-bold text-primary-600">${stock.stock_name}</td>
                    <td class="text-sm font-medium">${stock.avg_price.toLocaleString()} VND</td>
                    <td>
                        <div class="flex items-center gap-1">
                            <button onclick="editPortfolioStock(${stock.id}, '${stock.stock_name}', ${stock.avg_price})" class="p-2 text-slate-600 dark:text-slate-300 hover:text-primary-600 dark:hover:text-primary-400 transition-colors" title="Sửa">
                                <i data-lucide="edit-3" class="w-4 h-4"></i>
                            </button>
                            <button onclick="removePortfolioStock(${stock.id})" class="p-2 text-slate-600 dark:text-slate-300 hover:text-red-500 transition-colors" title="Xóa">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </td>
                `;
                portfolioList.appendChild(tr);
            });
            lucide.createIcons({ root: portfolioList });
        }

        function editPortfolioStock(id, symbol, price) {
            editingStockId = id;
            newStockSymbol.value = symbol;
            newStockPrice.value = price;

            // UI feedback
            addStockText.innerText = 'Cập nhật';
            addStockIcon.setAttribute('data-lucide', 'check');
            cancelEditBtn.classList.remove('hidden');
            lucide.createIcons({ root: addStockBtn });
            newStockSymbol.focus();
        }

        function cancelEditStock() {
            editingStockId = null;
            newStockSymbol.value = '';
            newStockPrice.value = '';
            addStockText.innerText = 'Thêm vào danh mục';
            addStockIcon.setAttribute('data-lucide', 'plus');
            cancelEditBtn.classList.add('hidden');
            lucide.createIcons({ root: addStockBtn });
        }

        async function addPortfolioStock() {
            const sym = newStockSymbol.value.trim().toUpperCase();
            const prc = parseFloat(newStockPrice.value);

            if (!sym || isNaN(prc)) {
                alert('Vui lòng nhập đầy đủ thông tin');
                return;
            }

            try {
                const url = editingStockId ? `/stocks/${editingStockId}` : `/users/${currentUser.id}/stocks`;
                const method = editingStockId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stock_name: sym, avg_price: prc })
                });

                if (response.ok) {
                    cancelEditStock();
                    fetchPortfolioStocks();
                } else {
                    alert(editingStockId ? 'Lỗi khi cập nhật cổ phiếu' : 'Lỗi khi thêm cổ phiếu');
                }
            } catch (error) {
                console.error('Error adding/updating stock:', error);
            }
        }

        async function removePortfolioStock(stockId) {
            if (!confirm('Bạn có chắc muốn xóa mã này khỏi danh mục?')) return;

            try {
                const response = await fetch(`/stocks/${stockId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    fetchPortfolioStocks();
                } else {
                    alert('Lỗi khi xóa cổ phiếu');
                }
            } catch (error) {
                console.error('Error removing stock:', error);
            }
        }

        function renderUserList() {
            userListContainer.innerHTML = '';
            users.forEach(user => {
                const item = document.createElement('div');
                item.className = 'menu-item';
                item.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 flex items-center justify-center text-xs font-bold">
                        ${getInitials(user.full_name)}
                    </div>
                    <span>${user.full_name}</span>
                `;
                item.onclick = () => selectUser(user);
                userListContainer.appendChild(item);
            });
        }

        userAvatarBtn.onclick = (e) => {
            e.stopPropagation();
            userMenu.classList.toggle('show');
        };

        window.onclick = () => {
            userMenu.classList.remove('show');
        };

        userMenu.onclick = (e) => e.stopPropagation();

        blacklistInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addBlacklistItem(blacklistInput.value);
            }
        });

        // Initialize Lucide for the menu
        lucide.createIcons({ root: userMenu });
        lucide.createIcons({ root: settingsOverlay });

        // Fetch users on load
        fetchUsers();

        submitBtn.addEventListener('click', () => analyzeTask(false));
        generalBtn.addEventListener('click', () => analyzeTask(true));
        userTaskInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                analyzeTask(false);
            }
        });
    </script>
</body>
</html>
